=== НАЧАЛО ОБУЧЕНИЯ 2025-09-02 14:51:38 ===

[2025-09-02 14:51:38] === РЕЖИМ МАСШТАБИРОВАНИЯ: FULL ===
[2025-09-02 14:51:38] Пользователей: все
[2025-09-02 14:51:38] Данных: 100.0%
[2025-09-02 14:51:38] === ЗАГРУЗКА ДАННЫХ ===
[2025-09-02 14:51:38] Загружаем данные...
[2025-09-02 14:51:38] orders: найдено 5 файлов, используем 5
[2025-09-02 14:51:38] orders: 18,887,122 строк (использовано 5 файлов), ~828.1 MB
[2025-09-02 14:51:38] tracker: найдено 200 файлов, используем 200
[2025-09-02 14:51:54] tracker: 1,644,982,482 строк (использовано 200 файлов), ~65693.4 MB
[2025-09-02 14:51:54] items: найдено 100 файлов, используем 100
[2025-09-02 14:52:03] items: 6,439,422 строк (использовано 100 файлов), ~1134.2 MB
[2025-09-02 14:52:03] categories: найдено 1 файлов, используем 1
[2025-09-02 14:52:03] categories: 7,012 строк (использовано 1 файлов), ~1.7 MB
[2025-09-02 14:52:03] test_users: найдено 1 файлов, используем 1
[2025-09-02 14:52:03] test_users: 470,347 строк (использовано 1 файлов), ~1.8 MB
[2025-09-02 14:52:03] Данные загружены
[2025-09-02 14:52:03] Фильтрация данных...
[2025-09-02 14:52:03] Фильтрация завершена
[2025-09-02 14:52:03] Загрузка данных завершена за 0:00:25.149153
[2025-09-02 14:52:03] === ЗАГРУЗКА ЭМБЕДДИНГОВ ===
[2025-09-02 14:52:03] Оптимизированная потоковая загрузка эмбеддингов... без PCA
[2025-09-02 14:52:23] Загружено эмбеддингов для 6342024 товаров
[2025-09-02 14:52:24] Загружено сырых эмбеддингов: 6342024
[2025-09-02 14:52:24] Размерность исходных эмбеддингов: 512
[2025-09-02 14:52:24] Анализ дисперсии эмбеддингов...
[2025-09-02 14:53:12] Оптимальное число компонент PCA: 354
[2025-09-02 14:53:12] Объясненная дисперсия: 95.033%
[2025-09-02 14:53:48] График PCA сохранен: /home/root6/python/e_cup/rec_system/pca_variance.png
[2025-09-02 14:53:48] Используем 10 компонент PCA (оптимально: 354, лимит: 10)
[2025-09-02 14:53:57] Обучение PCA на выборке из 100000 эмбеддингов...
[2025-09-02 14:54:01] PCA: сохранено 25.16% дисперсии в 10 компонентах
[2025-09-02 14:54:01] Применение PCA ко всем 6342024 эмбеддингам батчами...
[2025-09-02 14:54:28] PCA трансформация завершена
[2025-09-02 14:54:49] Модель PCA сохранена: /home/root6/python/e_cup/rec_system/data/processed/embeddings_pca_pca.pkl
[2025-09-02 14:54:49] Модель Scaler сохранена: /home/root6/python/e_cup/rec_system/data/processed/embeddings_pca_scaler.pkl
[2025-09-02 14:54:49] Пример ключей в embeddings_dict: [16450600, 26171495, 32624500, 50387994, 87041801]
[2025-09-02 14:54:49] Пример значения после PCA: [1.7731804  0.19312823 1.444656   5.288397   3.7082381 ]
[2025-09-02 14:54:49] Размерность после PCA: 10
[2025-09-02 14:54:49] Загрузка эмбеддингов с PCA завершена за 0:02:45.959871
[2025-09-02 14:54:49] Загружено эмбеддингов: 6342024
[2025-09-02 14:54:49] === SPLIT ДАННЫХ ===
[2025-09-02 14:54:59] Split данных завершен за 0:00:09.639622
[2025-09-02 14:54:59] Train orders: 13755583, Test orders: 3438892
[2025-09-02 14:54:59] === ПОДГОТОВКА ВЗАИМОДЕЙСТВИЙ ===
[2025-09-02 14:54:59] Формируем матрицу взаимодействий по батчам...
[2025-09-02 14:54:59] ... обработка orders
[2025-09-02 14:54:59] Сохранен orders-батч 0-1000000
[2025-09-02 14:54:59] Сохранен orders-батч 1000000-2000000
[2025-09-02 14:55:00] Сохранен orders-батч 2000000-3000000
[2025-09-02 14:55:00] Сохранен orders-батч 3000000-4000000
[2025-09-02 14:55:00] Сохранен orders-батч 4000000-5000000
[2025-09-02 14:55:00] Сохранен orders-батч 5000000-6000000
[2025-09-02 14:55:00] Сохранен orders-батч 6000000-7000000
[2025-09-02 14:55:01] Сохранен orders-батч 7000000-8000000
[2025-09-02 14:55:01] Сохранен orders-батч 8000000-9000000
[2025-09-02 14:55:01] Сохранен orders-батч 9000000-10000000
[2025-09-02 14:55:01] Сохранен orders-батч 10000000-11000000
[2025-09-02 14:55:01] Сохранен orders-батч 11000000-12000000
[2025-09-02 14:55:02] Сохранен orders-батч 12000000-13000000
[2025-09-02 14:55:02] Сохранен orders-батч 13000000-13755583
[2025-09-02 14:55:02] ... обработка tracker
[2025-09-02 14:55:02] Обрабатываем 10 файлов tracker
[2025-09-02 14:55:03] Обработан tracker файл 0: 5204228 строк
[2025-09-02 14:55:04] Обработан tracker файл 1: 5088402 строк
[2025-09-02 14:55:05] Обработан tracker файл 2: 5045487 строк
[2025-09-02 14:55:07] Обработан tracker файл 3: 4987285 строк
[2025-09-02 14:55:08] Обработан tracker файл 4: 4989096 строк
[2025-09-02 14:55:09] Обработан tracker файл 5: 5219465 строк
[2025-09-02 14:55:11] Обработан tracker файл 6: 5030300 строк
[2025-09-02 14:55:12] Обработан tracker файл 7: 5186810 строк
[2025-09-02 14:55:13] Обработан tracker файл 8: 5120177 строк
[2025-09-02 14:55:14] Обработан tracker файл 9: 5067673 строк
[2025-09-02 14:55:14] ✅ Все файлы успешно созданы
[2025-09-02 14:55:14] Всего файлов взаимодействий: 24
[2025-09-02 14:55:14] Подготовка взаимодействий завершена за 0:00:15.490094
[2025-09-02 14:55:14] Создано файлов взаимодействий: 24
[2025-09-02 14:55:14] === ПОСЛЕДНИЕ ТОВАРЫ ===
[2025-09-02 14:55:31] Словарь сохранен в /home/root6/python/e_cup/rec_system/data/processed/recent_items_map.pkl
[2025-09-02 14:55:31] Построение recent items map завершено за 0:00:16.588931
[2025-09-02 14:55:31] Пользователей с recent items: 960818
[2025-09-02 14:55:31] === ОБУЧЕНИЕ ALS ДЛЯ ПРИЗНАКОВ ===
[2025-09-02 14:55:31] Первый проход: построение маппингов...
[2025-09-02 14:55:34] Маппинги построены. Уников: users=960818, items=3972133
[2025-09-02 14:55:34] item_map сохранен: /home/root6/python/e_cup/rec_system/data/processed/item_map.pkl
[2025-09-02 14:55:34] Сохранение батчей на диск...
[2025-09-02 14:55:37] Обучение als_model...
[2025-09-02 14:55:49] Очистка временных файлов...
[2025-09-02 14:55:49] Директория батчей удалена
[2025-09-02 14:55:49] Обучение завершено!
[2025-09-02 14:55:49] Считаем глобальную популярность на основе тренировочных данных...
[2025-09-02 14:55:50] Глобальная популярность рассчитана на 13755580 тренировочных заказах
[2025-09-02 14:55:50] Обучение ALS завершено за 0:00:19.499513
[2025-09-02 14:55:50] Пользователей: 960818, Товаров: 3972133
[2025-09-02 14:55:50] === ПОСТРОЕНИЕ ДОПОЛНИТЕЛЬНЫХ ДАННЫХ ===
[2025-09-02 14:55:50] Строим co-purchase матрицу для топ-N товаров...
[2025-09-02 14:55:51] Топ-1000 популярных товаров определены
[2025-09-02 14:57:30] Обрабатываем 15477 корзин с популярными товарами
[2025-09-02 14:57:30] Уникальных популярных товаров: 1000
[2025-09-02 14:57:30] Создаем sparse матрицу из 42752 взаимодействий...
[2025-09-02 14:57:30] Sparse матрица построена: torch.Size([1000, 1000]), ненулевых элементов: 17546
[2025-09-02 14:57:30] Формируем рекомендации...
[2025-09-02 14:57:32] Co-purchase словарь построен для 996 товаров
[2025-09-02 14:57:32] В среднем 12.9 рекомендаций на товар
[2025-09-02 14:57:32] Co-purchase map построен: 996 товаров
[2025-09-02 14:57:42] Построение категорийных маппингов...
[2025-09-02 14:57:45] Категорийные маппинги построены: 6342024 товаров, 478 категорий
[2025-09-02 14:57:45] Построение дополнительных данных завершено за 0:01:54.197149
[2025-09-02 14:57:45] === ПРЕДВАРИТЕЛЬНЫЙ РАСЧЕТ ПРИЗНАКОВ ДЛЯ LGBM ===
[2025-09-02 14:57:45] Построение словаря пользовательских признаков из ТРЕНИРОВОЧНЫХ данных...
[2025-09-02 14:57:46] Агрегация по ЗАКАЗАМ (train)...
[2025-09-02 14:57:47] Словарь пользовательских признаков построен. Записей: 960818
[2025-09-02 14:57:47] User features построены за 0:00:02.788145: 960818 пользователей
[2025-09-02 14:57:47] Построение словаря товарных признаков из ТРЕНИРОВОЧНЫХ данных...
[2025-09-02 14:57:49] Обработка ЗАКАЗОВ (train)...
[2025-09-02 14:57:54] Словарь товарных признаков построен. Записей: 3972133
[2025-09-02 14:57:57] Item features: 3972133 товаров, размер вектора: 6 признаков
[2025-09-02 14:57:57] Порядок признаков: ['item_max', 'item_mean', 'item_orders_count', 'item_sum', 'item_count', 'item_min']
[2025-09-02 14:57:57] item_features_dict[251658241] type=<class 'numpy.ndarray'>, shape=(6,), example=[ 27.725887    5.7130785   1.        154.25311    27.       ]
[2025-09-02 14:57:57] item_features_dict[192937988] type=<class 'numpy.ndarray'>, shape=(6,), example=[16.479185 16.479185  1.       16.479185  1.      ]
[2025-09-02 14:57:57] item_features_dict[184549381] type=<class 'numpy.ndarray'>, shape=(6,), example=[14.722195 14.722195  1.       14.722195  1.      ]
[2025-09-02 14:57:57] item_features_dict[75497478] type=<class 'numpy.ndarray'>, shape=(6,), example=[15.545305 15.545305  1.       15.545305  1.      ]
[2025-09-02 14:57:57] item_features_dict[25165834] type=<class 'numpy.ndarray'>, shape=(6,), example=[4.7775574 4.7775574 1.        4.7775574 1.       ]
[2025-09-02 14:58:06] Item features построены за 0:00:18.851296
[2025-09-02 14:58:06] === ПОДГОТОВКА ДАННЫХ ДЛЯ МОДЕЛИ ===
[2025-09-02 14:58:06] Подготовка данных для модели (streaming, polars lazy, батчи)...
[2025-09-02 14:58:06] Тестовые заказы отсутствуют, используем только тренировочные
[2025-09-02 14:58:10] Разделение данных по времени: 2024-12-05 06:00:08 -> 2025-04-22 19:41:17.896000 (train) | 2025-04-22 19:41:17.896000 -> 2025-05-27 11:06:35.370000 (val)
[2025-09-02 14:58:35] ✅ Данные подготовлены. Train: 13896566 строк, Val: 5360460 строк
[2025-09-02 14:58:35] Размер train: 13896566, validation: 5360460
[2025-09-02 14:58:35] Признаки: 22
[2025-09-02 14:58:35] Подготовка данных для модели завершена за 0:00:28.945802
[2025-09-02 14:58:35] === ДЕТАЛЬНАЯ ПРОВЕРКА FEATURE GENERATION ===
[2025-09-02 14:58:35] --- ПРОВЕРКА USER FEATURES ---
[2025-09-02 14:58:35] Пример user features для пользователя 3309900:
[2025-09-02 14:58:35]   user_count: 60
[2025-09-02 14:58:35]   user_mean: 6.122816851383129
[2025-09-02 14:58:35]   user_sum: 367.3690110829877
[2025-09-02 14:58:35]   user_max: 14.339494510220533
[2025-09-02 14:58:35]   user_min: 1.3862943611198906
[2025-09-02 14:58:35]   user_orders_count: 13
[2025-09-02 14:58:35] Пользователей с features: 960818
[2025-09-02 14:58:35] Пользователей с НЕнулевыми features: 960818
[2025-09-02 14:58:35] --- ПРОВЕРКА ITEM FEATURES ---
[2025-09-02 14:58:35] Пример item features для товара 251658241:
[2025-09-02 14:58:35]   emb_0: 27.725887298583984
[2025-09-02 14:58:35]   emb_1: 5.713078498840332
[2025-09-02 14:58:35]   emb_2: 1.0
[2025-09-02 14:58:35]   emb_3: 154.25311279296875
[2025-09-02 14:58:35]   emb_4: 27.0
[2025-09-02 14:58:35]   emb_5: 1.576914668083191
[2025-09-02 14:58:41] Товаров с features: 3972133
[2025-09-02 14:58:41] Товаров с НЕнулевыми features: 3972133
[2025-09-02 14:58:41] --- ПРОВЕРКА ЭМБЕДДИНГОВ ---
[2025-09-02 14:58:41] Пример эмбеддинга для товара 16450600: shape (10,)
[2025-09-02 14:58:41] Эмбеддингов загружено: 6342024
[2025-09-02 14:58:41] Пример значений: [1.7731804  0.19312823 1.444656   5.288397   3.7082381 ]
[2025-09-02 14:58:41] --- ПРОВЕРКА CO-PURCHASE MAP ---
[2025-09-02 14:58:41] Пример co-purchase для товара 51974017: 20 товаров
[2025-09-02 14:58:41] Co-purchase записей: 996
[2025-09-02 14:58:41] --- ПРОВЕРКА КАТЕГОРИЙНЫХ МАППИНГОВ ---
[2025-09-02 14:58:41] Товар 5264590 -> категория 36517
[2025-09-02 14:58:41] Категория 36517 -> 12044 товаров
[2025-09-02 14:58:41] Товаров в маппинге: 6342024
[2025-09-02 14:58:41] Категорий в маппинге: 478
[2025-09-02 14:58:41] Проверка признаков завершена за 0:00:05.293680
[2025-09-02 14:58:41] === ОБУЧЕНИЕ МОДЕЛИ ===
[2025-09-02 14:58:47] === ДЕБАГ ИНФОРМАЦИЯ: TRAIN ===
[2025-09-02 14:58:47] Размер: 13896566 строк
[2025-09-02 14:58:47] Колонки: ['item_id', 'user_id', 'created_timestamp', 'last_status', 'target', 'timestamp', 'weight', 'user_count', 'user_mean', 'user_sum', 'user_max', 'user_min', 'user_orders_count', 'item_feat_0', 'item_feat_1', 'item_feat_2', 'item_feat_3', 'item_feat_4', 'item_feat_5', 'emb_0', 'emb_1', 'emb_2', 'emb_3', 'emb_4', 'emb_5', 'emb_6', 'emb_7', 'emb_8', 'emb_9']
[2025-09-02 14:58:47] ✅ Все признаки присутствуют
[2025-09-02 14:58:47] Целевая переменная: {1: np.int64(7852347), 0: np.int64(6044219)}
[2025-09-02 14:58:47] Пример первой строки:
[2025-09-02 14:58:47]   item_id: 19396399
[2025-09-02 14:58:47]   user_id: 2825591
[2025-09-02 14:58:47]   created_timestamp: 2025-01-08 15:46:12.270000
[2025-09-02 14:58:47]   last_status: canceled_orders
[2025-09-02 14:58:47]   target: 0
[2025-09-02 14:58:47]   timestamp: 2025-01-08 15:46:12.270000
[2025-09-02 14:58:47]   weight: 16.76703453063965
[2025-09-02 14:58:47]   user_count: 90.0
[2025-09-02 14:58:47]   user_mean: 8.109082527301311
[2025-09-02 14:58:47]   user_sum: 729.817427457118
[2025-09-02 14:58:47]   user_max: 28.213788864092134
[2025-09-02 14:58:47]   user_min: 0.6729444732424259
[2025-09-02 14:58:47]   user_orders_count: 23.0
[2025-09-02 14:58:47]   item_feat_0: 16.76703453063965
[2025-09-02 14:58:47]   item_feat_1: 16.377182006835938
[2025-09-02 14:58:47]   item_feat_2: 3.0
[2025-09-02 14:58:47]   item_feat_3: 49.13154602050781
[2025-09-02 14:58:47]   item_feat_4: 3.0
[2025-09-02 14:58:47]   item_feat_5: 15.848427772521973
[2025-09-02 14:58:47]   emb_0: 1.5552276372909546
[2025-09-02 14:58:47]   emb_1: 2.165776252746582
[2025-09-02 14:58:47]   emb_2: 0.2971062660217285
[2025-09-02 14:58:47]   emb_3: 3.4591267108917236
[2025-09-02 14:58:47]   emb_4: 6.019478797912598
[2025-09-02 14:58:47]   emb_5: -1.8084710836410522
[2025-09-02 14:58:47]   emb_6: -0.8895330429077148
[2025-09-02 14:58:47]   emb_7: -4.960775375366211
[2025-09-02 14:58:47]   emb_8: 4.861192226409912
[2025-09-02 14:58:47]   emb_9: -3.423837661743164
[2025-09-02 14:58:47] === ДЕБАГ ИНФОРМАЦИЯ: VAL ===
[2025-09-02 14:58:47] Размер: 5360460 строк
[2025-09-02 14:58:47] Колонки: ['item_id', 'user_id', 'created_timestamp', 'last_status', 'target', 'timestamp', 'weight', 'user_count', 'user_mean', 'user_sum', 'user_max', 'user_min', 'user_orders_count', 'item_feat_0', 'item_feat_1', 'item_feat_2', 'item_feat_3', 'item_feat_4', 'item_feat_5', 'emb_0', 'emb_1', 'emb_2', 'emb_3', 'emb_4', 'emb_5', 'emb_6', 'emb_7', 'emb_8', 'emb_9']
[2025-09-02 14:58:47] ✅ Все признаки присутствуют
[2025-09-02 14:58:47] Целевая переменная: {1: np.int64(2965348), 0: np.int64(2395112)}
[2025-09-02 14:58:47] Пример первой строки:
[2025-09-02 14:58:47]   item_id: 102782634
[2025-09-02 14:58:47]   user_id: 1541891
[2025-09-02 14:58:47]   created_timestamp: 2025-05-09 14:14:05.226000
[2025-09-02 14:58:47]   last_status: delivered_orders
[2025-09-02 14:58:47]   target: 1
[2025-09-02 14:58:47]   timestamp: 2025-05-09 14:14:05.226000
[2025-09-02 14:58:47]   weight: 7.408022880554199
[2025-09-02 14:58:47]   user_count: 10.0
[2025-09-02 14:58:47]   user_mean: 9.013951429531811
[2025-09-02 14:58:47]   user_sum: 90.13951429531811
[2025-09-02 14:58:47]   user_max: 13.671837547097919
[2025-09-02 14:58:47]   user_min: 5.493061443340547
[2025-09-02 14:58:47]   user_orders_count: 10.0
[2025-09-02 14:58:47]   item_feat_0: 7.408022880554199
[2025-09-02 14:58:47]   item_feat_1: 7.408022880554199
[2025-09-02 14:58:47]   item_feat_2: 1.0
[2025-09-02 14:58:47]   item_feat_3: 7.408022880554199
[2025-09-02 14:58:47]   item_feat_4: 1.0
[2025-09-02 14:58:47]   item_feat_5: 7.408022880554199
[2025-09-02 14:58:47]   emb_0: -1.6467844247817993
[2025-09-02 14:58:47]   emb_1: 1.5656988620758057
[2025-09-02 14:58:47]   emb_2: -5.969327926635742
[2025-09-02 14:58:47]   emb_3: 2.481510639190674
[2025-09-02 14:58:47]   emb_4: 2.0347371101379395
[2025-09-02 14:58:47]   emb_5: 2.4684882164001465
[2025-09-02 14:58:47]   emb_6: 0.6114019751548767
[2025-09-02 14:58:47]   emb_7: -1.3423702716827393
[2025-09-02 14:58:47]   emb_8: -2.2428348064422607
[2025-09-02 14:58:47]   emb_9: 0.9057314395904541
[2025-09-02 14:58:47] Feature columns: ['user_count', 'user_mean', 'user_sum', 'user_max', 'user_min', 'user_orders_count', 'item_feat_0', 'item_feat_1', 'item_feat_2', 'item_feat_3', 'item_feat_4', 'item_feat_5', 'emb_0', 'emb_1', 'emb_2', 'emb_3', 'emb_4', 'emb_5', 'emb_6', 'emb_7', 'emb_8', 'emb_9']
[2025-09-02 14:58:49] Размер train: 13896566
[2025-09-02 14:58:49] Количество пользователей в train: 755054
[2025-09-02 14:58:49] Размер val: 5360460
[2025-09-02 14:58:50] Количество пользователей в val: 548044
[2025-09-02 14:58:50] Определение категориальных признаков
[2025-09-02 14:58:50] Приведение категориальных фич к строкам
[2025-09-02 14:59:58] Создание пулов
[2025-09-02 14:59:58] train_pool
[2025-09-02 15:00:10] val_pool
[2025-09-02 15:00:15] Создание пулов завершено
