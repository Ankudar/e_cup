=== НАЧАЛО ОБУЧЕНИЯ 2025-09-01 14:49:49 ===

[2025-09-01 14:49:49] === РЕЖИМ МАСШТАБИРОВАНИЯ: FULL ===
[2025-09-01 14:49:49] Пользователей: все
[2025-09-01 14:49:49] Данных: 100.0%
[2025-09-01 14:49:49] === ЗАГРУЗКА ДАННЫХ ===
[2025-09-01 14:49:49] Загружаем данные...
[2025-09-01 14:49:49] orders: найдено 5 файлов, используем 5
[2025-09-01 14:49:51] orders: ограничено 100,000 из 18,887,122 строк (семплирование 0.5%, использовано 5 файлов), ~4.5 MB
[2025-09-01 14:49:51] tracker: найдено 200 файлов, используем 200
[2025-09-01 14:52:01] tracker: ограничено 100,003 из 1,644,982,482 строк (семплирование 0.0%, использовано 200 файлов), ~4.0 MB
[2025-09-01 14:52:01] items: найдено 100 файлов, используем 100
[2025-09-01 14:52:16] items: ограничено 99,999 из 6,439,422 строк (семплирование 1.6%, использовано 100 файлов), ~17.6 MB
[2025-09-01 14:52:16] categories: найдено 1 файлов, используем 1
[2025-09-01 14:52:16] categories: 7,012 строк (использовано 1 файлов), ~1.7 MB
[2025-09-01 14:52:16] test_users: найдено 1 файлов, используем 1
[2025-09-01 14:52:16] test_users: ограничено 100,000 из 470,347 строк (семплирование 21.3%, использовано 1 файлов), ~1.1 MB
[2025-09-01 14:52:16] Данные загружены
[2025-09-01 14:52:16] Фильтрация данных...
[2025-09-01 14:52:16] Фильтрация завершена
[2025-09-01 14:52:16] Загрузка данных завершена за 0:02:26.425538
[2025-09-01 14:52:16] === ЗАГРУЗКА ЭМБЕДДИНГОВ ===
[2025-09-01 14:52:16] Оптимизированная потоковая загрузка эмбеддингов... без PCA
[2025-09-01 14:52:22] Загружено эмбеддингов для 99965 товаров
[2025-09-01 14:52:22] Загружено сырых эмбеддингов: 99965
[2025-09-01 14:52:22] Размерность исходных эмбеддингов: 512
[2025-09-01 14:52:22] Анализ дисперсии эмбеддингов...
[2025-09-01 14:52:24] Оптимальное число компонент PCA: 354
[2025-09-01 14:52:24] Объясненная дисперсия: 95.052%
[2025-09-01 14:52:26] График PCA сохранен: /home/root6/python/e_cup/rec_system/pca_variance.png
[2025-09-01 14:52:26] Используем 10 компонент PCA (оптимально: 354, лимит: 10)
[2025-09-01 14:52:32] Обучение PCA на выборке из 99965 эмбеддингов...
[2025-09-01 14:52:35] PCA: сохранено 25.11% дисперсии в 10 компонентах
[2025-09-01 14:52:35] Применение PCA ко всем 99965 эмбеддингам батчами...
[2025-09-01 14:52:35] PCA трансформация завершена
[2025-09-01 14:52:35] Модель PCA сохранена: /home/root6/python/e_cup/rec_system/data/processed/embeddings_pca_pca.pkl
[2025-09-01 14:52:35] Модель Scaler сохранена: /home/root6/python/e_cup/rec_system/data/processed/embeddings_pca_scaler.pkl
[2025-09-01 14:52:35] Пример ключей в embeddings_dict: [313302306, 323611609, 313930510, 20238674, 113158168]
[2025-09-01 14:52:35] Пример значения после PCA: [ 9.400326   4.498661   1.5495793  5.7486243 -3.0601325]
[2025-09-01 14:52:35] Размерность после PCA: 10
[2025-09-01 14:52:35] Загрузка эмбеддингов с PCA завершена за 0:00:19.751669
[2025-09-01 14:52:35] Загружено эмбеддингов: 99965
[2025-09-01 14:52:36] === SPLIT ДАННЫХ ===
[2025-09-01 14:52:36] Split данных завершен за 0:00:00.952191
[2025-09-01 14:52:36] Train orders: 75927, Test orders: 18981
[2025-09-01 14:52:36] === ПОДГОТОВКА ВЗАИМОДЕЙСТВИЙ ===
[2025-09-01 14:52:36] Формируем матрицу взаимодействий по батчам...
[2025-09-01 14:52:36] ... обработка orders
[2025-09-01 14:52:36] Сохранен orders-батч 0-75927
[2025-09-01 14:52:37] ... обработка tracker
[2025-09-01 14:52:37] Обрабатываем 10 файлов tracker
[2025-09-01 14:52:38] Обработан tracker файл 0: 5188929 строк
[2025-09-01 14:52:42] Обработан tracker файл 1: 5073468 строк
[2025-09-01 14:52:43] Обработан tracker файл 2: 5029377 строк
[2025-09-01 14:52:45] Обработан tracker файл 3: 4971688 строк
[2025-09-01 14:52:46] Обработан tracker файл 4: 4974471 строк
[2025-09-01 14:52:47] Обработан tracker файл 5: 5203839 строк
[2025-09-01 14:52:49] Обработан tracker файл 6: 5015217 строк
[2025-09-01 14:52:50] Обработан tracker файл 7: 5170396 строк
[2025-09-01 14:52:52] Обработан tracker файл 8: 5105038 строк
[2025-09-01 14:52:53] Обработан tracker файл 9: 5052613 строк
[2025-09-01 14:52:53] ✅ Все файлы успешно созданы
[2025-09-01 14:52:53] Всего файлов взаимодействий: 11
[2025-09-01 14:52:53] Подготовка взаимодействий завершена за 0:00:16.784289
[2025-09-01 14:52:53] Создано файлов взаимодействий: 11
[2025-09-01 14:52:53] === ПОСЛЕДНИЕ ТОВАРЫ ===
[2025-09-01 14:53:02] Словарь сохранен в /home/root6/python/e_cup/rec_system/data/processed/recent_items_map.pkl
[2025-09-01 14:53:02] Построение recent items map завершено за 0:00:08.398948
[2025-09-01 14:53:02] Пользователей с recent items: 942062
[2025-09-01 14:53:02] === ОБУЧЕНИЕ ALS ДЛЯ ПРИЗНАКОВ ===
[2025-09-01 14:53:02] Первый проход: построение маппингов...
[2025-09-01 14:53:02] Маппинги построены. Уников: users=942062, items=305026
[2025-09-01 14:53:02] item_map сохранен: /home/root6/python/e_cup/rec_system/data/processed/item_map.pkl
[2025-09-01 14:53:02] Сохранение батчей на диск...
[2025-09-01 14:53:04] Обучение als_model...
[2025-09-01 14:53:11] Очистка временных файлов...
[2025-09-01 14:53:11] Директория батчей удалена
[2025-09-01 14:53:11] Обучение завершено!
[2025-09-01 14:53:11] Считаем глобальную популярность на основе тренировочных данных...
[2025-09-01 14:53:11] Глобальная популярность рассчитана на 75926 тренировочных заказах
[2025-09-01 14:53:11] Обучение ALS завершено за 0:00:09.167436
[2025-09-01 14:53:11] Пользователей: 942062, Товаров: 305026
[2025-09-01 14:53:11] === ПОСТРОЕНИЕ ДОПОЛНИТЕЛЬНЫХ ДАННЫХ ===
[2025-09-01 14:53:11] Строим co-purchase матрицу для топ-N товаров...
[2025-09-01 14:53:11] Топ-1000 популярных товаров определены
[2025-09-01 14:53:12] Обрабатываем 2 корзин с популярными товарами
[2025-09-01 14:53:12] Уникальных популярных товаров: 1000
[2025-09-01 14:53:12] Создаем sparse матрицу из 4 взаимодействий...
[2025-09-01 14:53:12] Sparse матрица построена: torch.Size([1000, 1000]), ненулевых элементов: 4
[2025-09-01 14:53:12] Формируем рекомендации...
[2025-09-01 14:53:12] Co-purchase словарь построен для 4 товаров
[2025-09-01 14:53:12] В среднем 1.0 рекомендаций на товар
[2025-09-01 14:53:12] Co-purchase map построен: 4 товаров
[2025-09-01 14:53:21] Построение категорийных маппингов...
[2025-09-01 14:53:21] Категорийные маппинги построены: 99965 товаров, 430 категорий
[2025-09-01 14:53:21] Построение дополнительных данных завершено за 0:00:09.855237
[2025-09-01 14:53:21] === ПРЕДВАРИТЕЛЬНЫЙ РАСЧЕТ ПРИЗНАКОВ ДЛЯ LGBM ===
[2025-09-01 14:53:21] Построение словаря пользовательских признаков из ТРЕНИРОВОЧНЫХ данных...
[2025-09-01 14:53:22] Агрегация по ЗАКАЗАМ (train)...
[2025-09-01 14:53:22] Словарь пользовательских признаков построен. Записей: 942062
[2025-09-01 14:53:23] User features построены за 0:00:02.063641: 942062 пользователей
[2025-09-01 14:53:23] Построение словаря товарных признаков из ТРЕНИРОВОЧНЫХ данных...
[2025-09-01 14:53:24] Обработка ЗАКАЗОВ (train)...
[2025-09-01 14:53:24] Словарь товарных признаков построен. Записей: 305026
[2025-09-01 14:53:25] Item features: 305026 товаров, размер вектора: 6 признаков
[2025-09-01 14:53:25] Порядок признаков: ['item_count', 'item_min', 'item_max', 'item_orders_count', 'item_mean', 'item_sum']
[2025-09-01 14:53:25] item_features_dict[27262977] type=<class 'numpy.ndarray'>, shape=(6,), example=[78.        5.888878 33.603752  0.        7.191743]
[2025-09-01 14:53:25] item_features_dict[298844161] type=<class 'numpy.ndarray'>, shape=(6,), example=[13.         4.7590923 31.945831   0.         8.129327 ]
[2025-09-01 14:53:25] item_features_dict[286261250] type=<class 'numpy.ndarray'>, shape=(6,), example=[ 1.       12.424533 12.424533  1.       12.424533]
[2025-09-01 14:53:25] item_features_dict[251658241] type=<class 'numpy.ndarray'>, shape=(6,), example=[26.         1.5769147 27.6001     0.         5.656591 ]
[2025-09-01 14:53:25] item_features_dict[71303174] type=<class 'numpy.ndarray'>, shape=(6,), example=[21.          0.36464313 17.005987    0.          7.2219725 ]
[2025-09-01 14:53:25] Item features построены за 0:00:02.493207
[2025-09-01 14:53:25] === ПОДГОТОВКА ДАННЫХ ДЛЯ LightGBM ===
[2025-09-01 14:53:25] Подготовка данных для модели (streaming, polars lazy, батчи)...
[2025-09-01 14:53:27] ✅ Данные подготовлены с эмбеддингами
[2025-09-01 14:53:27] Размер train: 84907, validation: 20451
[2025-09-01 14:53:27] Признаки: 16
[2025-09-01 14:53:27] Подготовка данных для LightGBM завершена за 0:00:01.477567
[2025-09-01 14:53:27] === ДЕТАЛЬНАЯ ПРОВЕРКА FEATURE GENERATION ===
[2025-09-01 14:53:27] --- ПРОВЕРКА USER FEATURES ---
[2025-09-01 14:53:27] Пример user features для пользователя 51650:
[2025-09-01 14:53:27]   user_count: 33
[2025-09-01 14:53:27]   user_mean: 6.087877291442946
[2025-09-01 14:53:27]   user_sum: 200.8999506176172
[2025-09-01 14:53:27]   user_max: 28.449093838194074
[2025-09-01 14:53:27]   user_min: 0.6729444732424259
[2025-09-01 14:53:27]   user_orders_count: 0
[2025-09-01 14:53:27] Пользователей с features: 942062
[2025-09-01 14:53:27] Пользователей с НЕнулевыми features: 942062
[2025-09-01 14:53:27] --- ПРОВЕРКА ITEM FEATURES ---
[2025-09-01 14:53:27] Пример item features для товара 27262977:
[2025-09-01 14:53:27]   emb_0: 78.0
[2025-09-01 14:53:27]   emb_1: 5.888877868652344
[2025-09-01 14:53:27]   emb_2: 33.60375213623047
[2025-09-01 14:53:27]   emb_3: 0.0
[2025-09-01 14:53:27]   emb_4: 7.191742897033691
[2025-09-01 14:53:27]   emb_5: 560.9559326171875
[2025-09-01 14:53:27] Товаров с features: 305026
[2025-09-01 14:53:27] Товаров с НЕнулевыми features: 305026
[2025-09-01 14:53:27] --- ПРОВЕРКА ЭМБЕДДИНГОВ ---
[2025-09-01 14:53:27] Пример эмбеддинга для товара 313302306: shape (10,)
[2025-09-01 14:53:27] Эмбеддингов загружено: 99965
[2025-09-01 14:53:27] Пример значений: [ 9.400326   4.498661   1.5495793  5.7486243 -3.0601325]
[2025-09-01 14:53:27] --- ПРОВЕРКА CO-PURCHASE MAP ---
[2025-09-01 14:53:27] Пример co-purchase для товара 229404153: 1 товаров
[2025-09-01 14:53:27] Co-purchase записей: 4
[2025-09-01 14:53:27] --- ПРОВЕРКА КАТЕГОРИЙНЫХ МАППИНГОВ ---
[2025-09-01 14:53:27] Товар 313302306 -> категория 7646
[2025-09-01 14:53:27] Категория 7646 -> 493 товаров
[2025-09-01 14:53:27] Товаров в маппинге: 99965
[2025-09-01 14:53:27] Категорий в маппинге: 430
[2025-09-01 14:53:27] Проверка признаков завершена за 0:00:00.528800
[2025-09-01 14:53:27] === ОБУЧЕНИЕ МОДЕЛИ ===
[2025-09-01 14:53:27] === ДЕБАГ ИНФОРМАЦИЯ: TRAIN ===
[2025-09-01 14:53:27] Размер: 84907 строк
[2025-09-01 14:53:27] Колонки: ['item_id', 'user_id', 'created_timestamp', 'last_status', 'target', 'timestamp', 'weight', 'user_count', 'user_mean', 'user_sum', 'user_max', 'user_min', 'user_orders_count', 'emb_0', 'emb_1', 'emb_2', 'emb_3', 'emb_4', 'emb_5', 'emb_6', 'emb_7', 'emb_8', 'emb_9']
[2025-09-01 14:53:27] ✅ Все признаки присутствуют
[2025-09-01 14:53:27] Целевая переменная: {1: np.int64(47436), 0: np.int64(37471)}
[2025-09-01 14:53:27] Пример первой строки:
[2025-09-01 14:53:27]   item_id: 195645756.0
[2025-09-01 14:53:27]   user_id: 457330.0
[2025-09-01 14:53:27]   created_timestamp: 2025-03-26 09:36:28.486000
[2025-09-01 14:53:27]   last_status: canceled_orders
[2025-09-01 14:53:27]   target: 0
[2025-09-01 14:53:27]   timestamp: 2025-03-26 09:36:28.486000
[2025-09-01 14:53:27]   weight: 12.901084147961626
[2025-09-01 14:53:27]   user_count: 217.0
[2025-09-01 14:53:27]   user_mean: 6.721513504529635
[2025-09-01 14:53:27]   user_sum: 1458.5684304829308
[2025-09-01 14:53:27]   user_max: 29.014215940827498
[2025-09-01 14:53:27]   user_min: 0.36464311358790924
[2025-09-01 14:53:27]   user_orders_count: 2.0
[2025-09-01 14:53:27]   emb_0: 0.0
[2025-09-01 14:53:27]   emb_1: 0.0
[2025-09-01 14:53:27]   emb_2: 0.0
[2025-09-01 14:53:27]   emb_3: 0.0
[2025-09-01 14:53:27]   emb_4: 0.0
[2025-09-01 14:53:27]   emb_5: 0.0
[2025-09-01 14:53:27]   emb_6: 0.0
[2025-09-01 14:53:27]   emb_7: 0.0
[2025-09-01 14:53:27]   emb_8: 0.0
[2025-09-01 14:53:27]   emb_9: 0.0
[2025-09-01 14:53:27] === ДЕБАГ ИНФОРМАЦИЯ: VAL ===
[2025-09-01 14:53:27] Размер: 20451 строк
[2025-09-01 14:53:27] Колонки: ['item_id', 'user_id', 'created_timestamp', 'last_status', 'target', 'timestamp', 'weight', 'user_count', 'user_mean', 'user_sum', 'user_max', 'user_min', 'user_orders_count', 'emb_0', 'emb_1', 'emb_2', 'emb_3', 'emb_4', 'emb_5', 'emb_6', 'emb_7', 'emb_8', 'emb_9']
[2025-09-01 14:53:27] ✅ Все признаки присутствуют
[2025-09-01 14:53:27] Целевая переменная: {1: np.int64(11250), 0: np.int64(9201)}
[2025-09-01 14:53:27] Пример первой строки:
[2025-09-01 14:53:27]   item_id: 206589589.0
[2025-09-01 14:53:27]   user_id: 2705760.0
[2025-09-01 14:53:27]   created_timestamp: 2025-04-10 17:39:46.636000
[2025-09-01 14:53:27]   last_status: delivered_orders
[2025-09-01 14:53:27]   target: 1
[2025-09-01 14:53:27]   timestamp: 2025-04-10 17:39:46.636000
[2025-09-01 14:53:27]   weight: 11.611938601451126
[2025-09-01 14:53:27]   user_count: 162.0
[2025-09-01 14:53:27]   user_mean: 5.955968383359089
[2025-09-01 14:53:27]   user_sum: 964.8668781041724
[2025-09-01 14:53:27]   user_max: 31.612467120315646
[2025-09-01 14:53:27]   user_min: 1.3862943611198906
[2025-09-01 14:53:27]   user_orders_count: 1.0
[2025-09-01 14:53:27]   emb_0: 0.0
[2025-09-01 14:53:27]   emb_1: 0.0
[2025-09-01 14:53:27]   emb_2: 0.0
[2025-09-01 14:53:27]   emb_3: 0.0
[2025-09-01 14:53:27]   emb_4: 0.0
[2025-09-01 14:53:27]   emb_5: 0.0
[2025-09-01 14:53:27]   emb_6: 0.0
[2025-09-01 14:53:27]   emb_7: 0.0
[2025-09-01 14:53:27]   emb_8: 0.0
[2025-09-01 14:53:27]   emb_9: 0.0
[2025-09-01 14:53:27] Feature columns: ['user_count', 'user_mean', 'user_sum', 'user_max', 'user_min', 'user_orders_count', 'emb_0', 'emb_1', 'emb_2', 'emb_3', 'emb_4', 'emb_5', 'emb_6', 'emb_7', 'emb_8', 'emb_9']
[2025-09-01 14:53:27] Размер train: 84907
[2025-09-01 14:53:27] Количество пользователей в train: 53237
[2025-09-01 14:53:27] Размер val: 20451
[2025-09-01 14:53:27] Количество пользователей в val: 13017
[2025-09-01 14:53:27] Определение категориальных признаков
[2025-09-01 14:53:27] Приведение категориальных фич к строкам
[2025-09-01 14:53:27] Создание пулов
[2025-09-01 14:53:27] train_pool
[2025-09-01 14:53:28] val_pool
[2025-09-01 14:53:28] Создание пулов завершено
[2025-09-01 14:53:29] 🎯 Финальный кастомный NDCG@100 на валидации: 0.105477
[2025-09-01 14:53:29] Обучение LightGBM завершено за 0:00:01.738317
[2025-09-01 14:53:29] === ОЦЕНКА МОДЕЛИ ===
[2025-09-01 14:53:31] NDCG@100 train: 0.5998
[2025-09-01 14:53:31] NDCG@100 val: 0.5748
[2025-09-01 14:53:31] === СОХРАНЕНИЕ МОДЕЛИ И ПРИЗНАКОВ ===
[2025-09-01 14:53:33] Сохранение модели завершено за 0:00:02.616864
[2025-09-01 14:53:33] Модель сохранена в: /home/root6/python/e_cup/rec_system/src/models/model.pkl
[2025-09-01 14:53:33] === ОБУЧЕНИЕ И ПРЕДСКАЗАНИЯ ЗАВЕРШЕНЫ УСПЕШНО ===
[2025-09-01 14:53:33] Общее время выполнения: 0:03:43.948438
[2025-09-01 14:53:33] Пользователей: 942062
[2025-09-01 14:53:33] Товаров: 305026
[2025-09-01 14:53:33] Признаков: 16
[2025-09-01 14:53:33] === СИСТЕМНАЯ ИНФОРМАЦИЯ ===
[2025-09-01 14:53:33] Видеокарта: NVIDIA GeForce RTX 4090
[2025-09-01 14:53:33] Память GPU: 24.0 GB
[2025-09-01 14:53:33] Процессор: 27.3% загрузки
[2025-09-01 14:53:33] Ядра CPU: 32
[2025-09-01 14:53:33] Частота CPU: 2995.2 MHz
[2025-09-01 14:53:33] Оперативная память: 94.2 GB всего, 61.7 GB использовано
[2025-09-01 14:53:33] ==========================================
[2025-09-01 14:53:33] ВСЕ ЭТАПЫ ВЫПОЛНЕНЫ УСПЕШНО!
[2025-09-01 14:53:33] ==========================================

=== ОБЩЕЕ ВРЕМЯ ВЫПОЛНЕНИЯ: 0:03:43.949438 ===
