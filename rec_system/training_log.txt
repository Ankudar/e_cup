=== НАЧАЛО ОБУЧЕНИЯ 2025-08-29 11:42:09 ===

[2025-08-29 11:42:09] === РЕЖИМ МАСШТАБИРОВАНИЯ: FULL ===
[2025-08-29 11:42:09] Пользователей: все
[2025-08-29 11:42:09] Данных: 100.0%
[2025-08-29 11:42:09] === ЗАГРУЗКА ДАННЫХ ===
[2025-08-29 11:42:09] Загружаем данные...
[2025-08-29 11:42:10] orders: 100,000 строк (использовано 5 из 5 партиций), ~3.8 MB
[2025-08-29 11:42:10] tracker: 100,000 строк (использовано 200 из 200 партиций), ~3.2 MB
[2025-08-29 11:42:11] items: 100,000 строк (использовано 200 из 200 партиций), ~7.4 MB
[2025-08-29 11:42:11] categories: 7,012 строк (использовано 1 из 1 партиций), ~1.7 MB
[2025-08-29 11:42:11] test_users: 100,000 строк (использовано 1 из 1 партиций), ~0.4 MB
[2025-08-29 11:42:11] Данные загружены
[2025-08-29 11:42:11] Фильтрация данных...
[2025-08-29 11:42:11] Фильтрация завершена
[2025-08-29 11:42:11] Загрузка данных завершена за 0:00:02.151438
[2025-08-29 11:42:11] === ЗАГРУЗКА ЭМБЕДДИНГОВ ===
[2025-08-29 11:42:11] Оптимизированная потоковая загрузка эмбеддингов...
[2025-08-29 11:42:12] Загружено эмбеддингов для 43059 товаров
[2025-08-29 11:42:12] Пример ключей в embeddings_dict: [400301, 678602, 746401, 872829, 893255]
[2025-08-29 11:42:12] Пример значения: [ 0.32023853  0.11766258 -0.784552    0.4168199  -0.24610527]
[2025-08-29 11:42:12] Загрузка эмбеддингов завершена за 0:00:00.991123
[2025-08-29 11:42:12] Загружено эмбеддингов: 43059
[2025-08-29 11:42:12] === SPLIT ДАННЫХ ===
[2025-08-29 11:42:13] Split данных завершен за 0:00:00.314265
[2025-08-29 11:42:13] Train orders: 75737, Test orders: 18934
[2025-08-29 11:42:13] === ПОДГОТОВКА ВЗАИМОДЕЙСТВИЙ ===
[2025-08-29 11:42:13] Формируем матрицу взаимодействий по батчам...
[2025-08-29 11:42:13] ✅ Найдено 2 существующих файлов, пропускаем создание
[2025-08-29 11:42:13] Подготовка взаимодействий завершена за 0:00:00.000588
[2025-08-29 11:42:13] Создано файлов взаимодействий: 2
[2025-08-29 11:42:13] === ПОСЛЕДНИЕ ТОВАРЫ ===
[2025-08-29 11:42:15] Словарь сохранен в /home/root6/python/e_cup/rec_system/data/processed/recent_items_map.pkl
[2025-08-29 11:42:15] Построение recent items map завершено за 0:00:02.768841
[2025-08-29 11:42:15] Пользователей с recent items: 872198
[2025-08-29 11:42:15] === ОБУЧЕНИЕ ALS ДЛЯ ПРИЗНАКОВ ===
[2025-08-29 11:42:15] Первый проход: построение маппингов...
[2025-08-29 11:42:17] Маппинги построены. Уников: users=872198, items=3938327
[2025-08-29 11:42:17] item_map сохранен: /home/root6/python/e_cup/rec_system/data/processed/item_map.pkl
[2025-08-29 11:42:17] Сохранение батчей на диск...
[2025-08-29 11:42:18] Постепенное обучение...
[2025-08-29 11:43:13] Очистка временных файлов...
[2025-08-29 11:43:13] Директория батчей удалена
[2025-08-29 11:43:13] Обучение завершено!
[2025-08-29 11:43:13] Считаем глобальную популярность на основе тренировочных данных...
[2025-08-29 11:43:13] Глобальная популярность рассчитана на 75736 тренировочных заказах
[2025-08-29 11:43:13] Обучение ALS завершено за 0:00:57.965121
[2025-08-29 11:43:13] Пользователей: 872198, Товаров: 3938327
[2025-08-29 11:43:13] === ПОСТРОЕНИЕ ДОПОЛНИТЕЛЬНЫХ ДАННЫХ ===
[2025-08-29 11:43:13] Строим co-purchase матрицу для топ-N товаров...
[2025-08-29 11:43:13] Топ-500 популярных товаров определены
[2025-08-29 11:43:14] Обрабатываем 237 корзин с популярными товарами
[2025-08-29 11:43:14] Уникальных популярных товаров: 500
[2025-08-29 11:43:14] Создаем sparse матрицу из 4144 взаимодействий...
[2025-08-29 11:43:14] Sparse матрица построена: torch.Size([500, 500]), ненулевых элементов: 134
[2025-08-29 11:43:14] Формируем рекомендации...
[2025-08-29 11:43:15] Co-purchase словарь построен для 126 товаров
[2025-08-29 11:43:15] В среднем 1.1 рекомендаций на товар
[2025-08-29 11:43:15] Co-purchase map построен: 126 товаров
[2025-08-29 11:43:15] Построение категорийных маппингов...
[2025-08-29 11:43:15] Категорийные маппинги построены: 63318 товаров, 419 категорий
[2025-08-29 11:43:15] Построение дополнительных данных завершено за 0:00:01.510085
[2025-08-29 11:43:15] === ПРЕДВАРИТЕЛЬНЫЙ РАСЧЕТ ПРИЗНАКОВ ДЛЯ LGBM ===
[2025-08-29 11:43:15] Построение словаря пользовательских признаков...
[2025-08-29 11:43:15] Агрегация по заказам...
[2025-08-29 11:43:16] Словарь пользовательских признаков построен и сохранён в /home/root6/python/e_cup/rec_system/data/processed/cat_to_items.pkl. Записей: 872199
[2025-08-29 11:43:17] User features построены за 0:00:01.553707: 872199 пользователей
[2025-08-29 11:43:17] Построение словаря товарных признаков...
[2025-08-29 11:43:17] Добавление данных из items_df...
[2025-08-29 11:43:21] Добавление эмбеддингов...
[2025-08-29 11:43:21] Словарь товарных признаков построен. Записей: 3938328
[2025-08-29 11:43:25] Item features: 3938328 товаров, размер вектора: 7 признаков
[2025-08-29 11:43:25] Порядок признаков: ['item_count', 'item_mean', 'item_sum', 'item_max', 'item_min', 'item_orders_count', 'item_category']
[2025-08-29 11:43:25] item_features_dict[119026081] type=<class 'numpy.ndarray'>, shape=(7,), example=[1.        6.6750054 6.6750054 6.6750054 6.6750054]
[2025-08-29 11:43:25] item_features_dict[31705487] type=<class 'numpy.ndarray'>, shape=(7,), example=[ 11.        13.14101  144.55112   16.173746   5.148097]
[2025-08-29 11:43:25] item_features_dict[199803421] type=<class 'numpy.ndarray'>, shape=(7,), example=[ 2.         9.393681  18.787361  15.848428   2.9389334]
[2025-08-29 11:43:25] item_features_dict[87754075] type=<class 'numpy.ndarray'>, shape=(7,), example=[ 1.       10.986123 10.986123 10.986123 10.986123]
[2025-08-29 11:43:25] item_features_dict[179076681] type=<class 'numpy.ndarray'>, shape=(7,), example=[1.        5.4930615 5.4930615 5.4930615 5.4930615]
[2025-08-29 11:43:35] Item features построены за 0:00:18.753608
[2025-08-29 11:43:35] === ПОДГОТОВКА ДАННЫХ ДЛЯ LightGBM ===
[2025-08-29 11:43:35] Подготовка данных для LightGBM (streaming, polars lazy, векторно)...
[2025-08-29 11:43:46] ✅ Данные подготовлены без утечек памяти
[2025-08-29 11:43:47] Размер train: 650750, validation: 4466
[2025-08-29 11:43:47] Признаки: 14
[2025-08-29 11:43:47] Подготовка данных для LightGBM завершена за 0:00:11.381294
[2025-08-29 11:43:47] === ДЕТАЛЬНАЯ ПРОВЕРКА FEATURE GENERATION ===
[2025-08-29 11:43:47] --- ПРОВЕРКА USER FEATURES ---
[2025-08-29 11:43:47] Пример user features для пользователя 3622920:
[2025-08-29 11:43:47]   user_count: 22
[2025-08-29 11:43:47]   user_mean: 9.665890811728122
[2025-08-29 11:43:47]   user_sum: 212.6495978580187
[2025-08-29 11:43:47]   user_max: 29.444389791664403
[2025-08-29 11:43:47]   user_min: 4.05629649458457
[2025-08-29 11:43:47]   user_orders_count: 0
[2025-08-29 11:43:47] Пользователей с features: 872199
[2025-08-29 11:43:47] Пользователей с НЕнулевыми features: 872199
[2025-08-29 11:43:47] --- ПРОВЕРКА ITEM FEATURES ---
[2025-08-29 11:43:47] Пример item features для товара 119026081:
[2025-08-29 11:43:47]   emb_0: 1.0
[2025-08-29 11:43:47]   emb_1: 6.6750054359436035
[2025-08-29 11:43:47]   emb_2: 6.6750054359436035
[2025-08-29 11:43:47]   emb_3: 6.6750054359436035
[2025-08-29 11:43:47]   emb_4: 6.6750054359436035
[2025-08-29 11:43:47]   emb_5: 0.0
[2025-08-29 11:43:47]   emb_6: 0.0
[2025-08-29 11:43:52] Товаров с features: 3938328
[2025-08-29 11:43:52] Товаров с НЕнулевыми features: 3938328
[2025-08-29 11:43:52] --- ПРОВЕРКА ЭМБЕДДИНГОВ ---
[2025-08-29 11:43:52] Пример эмбеддинга для товара 400301: shape (512,)
[2025-08-29 11:43:52] Эмбеддингов загружено: 43059
[2025-08-29 11:43:52] Пример значений: [ 0.32023853  0.11766258 -0.784552    0.4168199  -0.24610527]
[2025-08-29 11:43:52] --- ПРОВЕРКА CO-PURCHASE MAP ---
[2025-08-29 11:43:52] Пример co-purchase для товара 141204132: 1 товаров
[2025-08-29 11:43:52] Co-purchase записей: 126
[2025-08-29 11:43:52] --- ПРОВЕРКА КАТЕГОРИЙНЫХ МАППИНГОВ ---
[2025-08-29 11:43:52] Товар 400301 -> категория 17080
[2025-08-29 11:43:52] Категория 17080 -> 173 товаров
[2025-08-29 11:43:52] Товаров в маппинге: 63318
[2025-08-29 11:43:52] Категорий в маппинге: 419
[2025-08-29 11:43:52] Проверка признаков завершена за 0:00:05.582020
[2025-08-29 11:43:52] === ОБУЧЕНИЕ LightGBM ===
[2025-08-29 11:43:52] === ДЕБАГ ИНФОРМАЦИЯ: TRAIN ===
[2025-08-29 11:43:52] Размер: 650750 строк
[2025-08-29 11:43:52] Колонки: ['item_id', 'user_id', 'created_timestamp', 'last_status', 'target', 'weight', 'user_count', 'user_mean', 'user_sum', 'user_max', 'user_min', 'user_orders_count', 'emb_0', 'emb_1', 'emb_2', 'emb_3', 'emb_4', 'emb_5', 'emb_6', 'copurchase_count']
[2025-08-29 11:43:52] ✅ Все признаки присутствуют
[2025-08-29 11:43:52] Целевая переменная: {1: np.int64(338818), 0: np.int64(311932)}
[2025-08-29 11:43:52] Пример первой строки:
[2025-08-29 11:43:52]   item_id: 86475917
[2025-08-29 11:43:52]   user_id: 1945310
[2025-08-29 11:43:52]   created_timestamp: 2025-01-01 12:33:22.356000
[2025-08-29 11:43:52]   last_status: delivered_orders
[2025-08-29 11:43:52]   target: 1
[2025-08-29 11:43:52]   weight: 17.005986908310778
[2025-08-29 11:43:52]   user_count: 65.0
[2025-08-29 11:43:52]   user_mean: 12.095494358427906
[2025-08-29 11:43:52]   user_sum: 786.2071332978139
[2025-08-29 11:43:52]   user_max: 34.07841924380824
[2025-08-29 11:43:52]   user_min: 0.36464311358790924
[2025-08-29 11:43:52]   user_orders_count: 1.0
[2025-08-29 11:43:52]   emb_0: 258.0
[2025-08-29 11:43:52]   emb_1: 6.4797468185424805
[2025-08-29 11:43:52]   emb_2: 1671.7747802734375
[2025-08-29 11:43:52]   emb_3: 34.07841873168945
[2025-08-29 11:43:52]   emb_4: 1.3862943649291992
[2025-08-29 11:43:52]   emb_5: 1.0
[2025-08-29 11:43:52]   emb_6: 7559.0
[2025-08-29 11:43:52]   copurchase_count: 0.0
[2025-08-29 11:43:52] === ДЕБАГ ИНФОРМАЦИЯ: VAL ===
[2025-08-29 11:43:52] Размер: 4466 строк
[2025-08-29 11:43:52] Колонки: ['item_id', 'user_id', 'created_timestamp', 'last_status', 'target', 'weight', 'user_count', 'user_mean', 'user_sum', 'user_max', 'user_min', 'user_orders_count', 'emb_0', 'emb_1', 'emb_2', 'emb_3', 'emb_4', 'emb_5', 'emb_6', 'copurchase_count']
[2025-08-29 11:43:52] ✅ Все признаки присутствуют
[2025-08-29 11:43:52] Целевая переменная: {1: np.int64(2300), 0: np.int64(2166)}
[2025-08-29 11:43:52] Пример первой строки:
[2025-08-29 11:43:52]   item_id: 240983128
[2025-08-29 11:43:52]   user_id: 2670751
[2025-08-29 11:43:52]   created_timestamp: 2025-05-23 21:35:08.640000
[2025-08-29 11:43:52]   last_status: canceled_orders
[2025-08-29 11:43:52]   target: 0
[2025-08-29 11:43:52]   weight: 0.36464311358790924
[2025-08-29 11:43:52]   user_count: 165
[2025-08-29 11:43:52]   user_mean: 8.80242231264793
[2025-08-29 11:43:52]   user_sum: 1452.3996815869086
[2025-08-29 11:43:52]   user_max: 32.95836866004329
[2025-08-29 11:43:52]   user_min: 0.36464311358790924
[2025-08-29 11:43:52]   user_orders_count: 3
[2025-08-29 11:43:52]   emb_0: 538.0
[2025-08-29 11:43:52]   emb_1: 5.742250442504883
[2025-08-29 11:43:52]   emb_2: 3089.330810546875
[2025-08-29 11:43:52]   emb_3: 32.6575927734375
[2025-08-29 11:43:52]   emb_4: 0.3646431267261505
[2025-08-29 11:43:52]   emb_5: 14.0
[2025-08-29 11:43:52]   emb_6: 7502.0
[2025-08-29 11:43:52]   copurchase_count: 0.0
[2025-08-29 11:43:52] Feature columns: ['copurchase_count', 'user_count', 'user_mean', 'user_sum', 'user_max', 'user_min', 'user_orders_count', 'emb_0', 'emb_1', 'emb_2', 'emb_3', 'emb_4', 'emb_5', 'emb_6']
[2025-08-29 11:43:52] Размер train: 650750
[2025-08-29 11:43:52] Количество пользователей в train: 76371
[2025-08-29 11:43:52] Размер val: 4466
[2025-08-29 11:43:52] Количество пользователей в val: 1419
[2025-08-29 11:43:54] [Iter 0] train_ndcg@100: 0.613572, valid_ndcg@100: 0.609113
[2025-08-29 11:43:57] [Iter 1] train_ndcg@100: 0.613572, valid_ndcg@100: 0.609113
[2025-08-29 11:43:59] [Iter 2] train_ndcg@100: 0.617268, valid_ndcg@100: 0.610264
[2025-08-29 11:43:59] ✅ [Iter 2] Новый лучший valid_ndcg@100: 0.610264
[2025-08-29 11:44:01] [Iter 3] train_ndcg@100: 0.617494, valid_ndcg@100: 0.611611
[2025-08-29 11:44:01] ✅ [Iter 3] Новый лучший valid_ndcg@100: 0.611611
[2025-08-29 11:44:04] [Iter 4] train_ndcg@100: 0.618688, valid_ndcg@100: 0.610979
[2025-08-29 11:44:06] [Iter 5] train_ndcg@100: 0.618571, valid_ndcg@100: 0.611446
[2025-08-29 11:44:09] [Iter 6] train_ndcg@100: 0.618815, valid_ndcg@100: 0.611827
[2025-08-29 11:44:09] ✅ [Iter 6] Новый лучший valid_ndcg@100: 0.611827
[2025-08-29 11:44:14] [Iter 7] train_ndcg@100: 0.619305, valid_ndcg@100: 0.612994
[2025-08-29 11:44:14] ✅ [Iter 7] Новый лучший valid_ndcg@100: 0.612994
[2025-08-29 11:44:16] [Iter 8] train_ndcg@100: 0.619252, valid_ndcg@100: 0.613261
[2025-08-29 11:44:16] ✅ [Iter 8] Новый лучший valid_ndcg@100: 0.613261
[2025-08-29 11:44:18] [Iter 9] train_ndcg@100: 0.619398, valid_ndcg@100: 0.612638
[2025-08-29 11:44:21] [Iter 10] train_ndcg@100: 0.619256, valid_ndcg@100: 0.612881
[2025-08-29 11:44:23] [Iter 11] train_ndcg@100: 0.619161, valid_ndcg@100: 0.612072
[2025-08-29 11:44:26] [Iter 12] train_ndcg@100: 0.619052, valid_ndcg@100: 0.611995
[2025-08-29 11:44:28] [Iter 13] train_ndcg@100: 0.619465, valid_ndcg@100: 0.611732
[2025-08-29 11:44:30] [Iter 14] train_ndcg@100: 0.620009, valid_ndcg@100: 0.612339
[2025-08-29 11:44:33] [Iter 15] train_ndcg@100: 0.620241, valid_ndcg@100: 0.611835
[2025-08-29 11:44:36] [Iter 16] train_ndcg@100: 0.620719, valid_ndcg@100: 0.612394
[2025-08-29 11:44:38] [Iter 17] train_ndcg@100: 0.621153, valid_ndcg@100: 0.611775
[2025-08-29 11:44:41] [Iter 18] train_ndcg@100: 0.621444, valid_ndcg@100: 0.612066
[2025-08-29 11:44:44] [Iter 19] train_ndcg@100: 0.621663, valid_ndcg@100: 0.612520
[2025-08-29 11:44:50] [Iter 20] train_ndcg@100: 0.621736, valid_ndcg@100: 0.612758
[2025-08-29 11:45:09] ✅ [Iter 28] Новый лучший valid_ndcg@100: 0.613341
[2025-08-29 11:45:15] [Iter 30] train_ndcg@100: 0.623340, valid_ndcg@100: 0.613067
[2025-08-29 11:45:20] ✅ [Iter 32] Новый лучший valid_ndcg@100: 0.613361
[2025-08-29 11:45:26] ✅ [Iter 33] Новый лучший valid_ndcg@100: 0.613394
[2025-08-29 11:45:28] ✅ [Iter 34] Новый лучший valid_ndcg@100: 0.613452
[2025-08-29 11:45:31] ✅ [Iter 35] Новый лучший valid_ndcg@100: 0.614079
[2025-08-29 11:45:33] ✅ [Iter 36] Новый лучший valid_ndcg@100: 0.614146
[2025-08-29 11:45:43] [Iter 40] train_ndcg@100: 0.624237, valid_ndcg@100: 0.614130
[2025-08-29 11:45:55] ✅ [Iter 44] Новый лучший valid_ndcg@100: 0.614446
[2025-08-29 11:46:05] ✅ [Iter 47] Новый лучший valid_ndcg@100: 0.614685
[2025-08-29 11:46:07] ✅ [Iter 48] Новый лучший valid_ndcg@100: 0.614698
[2025-08-29 11:46:10] ✅ [Iter 49] Новый лучший valid_ndcg@100: 0.614904
[2025-08-29 11:46:12] [Iter 50] train_ndcg@100: 0.625030, valid_ndcg@100: 0.614890
[2025-08-29 11:46:15] ✅ [Iter 51] Новый лучший valid_ndcg@100: 0.615045
[2025-08-29 11:46:17] ✅ [Iter 52] Новый лучший valid_ndcg@100: 0.615427
[2025-08-29 11:46:35] ✅ [Iter 58] Новый лучший valid_ndcg@100: 0.615591
[2025-08-29 11:46:40] [Iter 60] train_ndcg@100: 0.625729, valid_ndcg@100: 0.615022
[2025-08-29 11:47:06] [Iter 70] train_ndcg@100: 0.626410, valid_ndcg@100: 0.615108
[2025-08-29 11:47:14] ✅ [Iter 72] Новый лучший valid_ndcg@100: 0.615766
[2025-08-29 11:47:16] ✅ [Iter 73] Новый лучший valid_ndcg@100: 0.616211
[2025-08-29 11:47:33] [Iter 80] train_ndcg@100: 0.627237, valid_ndcg@100: 0.615961
[2025-08-29 11:48:00] ✅ [Iter 89] Новый лучший valid_ndcg@100: 0.616736
[2025-08-29 11:48:02] [Iter 90] train_ndcg@100: 0.627750, valid_ndcg@100: 0.616736
[2025-08-29 11:48:05] ✅ [Iter 91] Новый лучший valid_ndcg@100: 0.616994
[2025-08-29 11:48:10] ✅ [Iter 93] Новый лучший valid_ndcg@100: 0.617000
[2025-08-29 11:48:31] [Iter 100] train_ndcg@100: 0.628290, valid_ndcg@100: 0.616816
[2025-08-29 11:49:04] [Iter 110] train_ndcg@100: 0.628630, valid_ndcg@100: 0.616834
[2025-08-29 11:49:09] ✅ [Iter 112] Новый лучший valid_ndcg@100: 0.617135
[2025-08-29 11:49:11] ✅ [Iter 113] Новый лучший valid_ndcg@100: 0.617143
[2025-08-29 11:49:14] ✅ [Iter 114] Новый лучший valid_ndcg@100: 0.617152
[2025-08-29 11:49:19] ✅ [Iter 116] Новый лучший valid_ndcg@100: 0.617361
[2025-08-29 11:49:22] ✅ [Iter 117] Новый лучший valid_ndcg@100: 0.617836
[2025-08-29 11:49:33] [Iter 120] train_ndcg@100: 0.629045, valid_ndcg@100: 0.617891
[2025-08-29 11:50:00] [Iter 130] train_ndcg@100: 0.629600, valid_ndcg@100: 0.617862
[2025-08-29 11:50:10] ✅ [Iter 132] Новый лучший valid_ndcg@100: 0.618123
[2025-08-29 11:50:28] ✅ [Iter 138] Новый лучший valid_ndcg@100: 0.618216
[2025-08-29 11:50:33] [Iter 140] train_ndcg@100: 0.629898, valid_ndcg@100: 0.618008

=== ОБЩЕЕ ВРЕМЯ ВЫПОЛНЕНИЯ: 0:08:27.752824 ===
