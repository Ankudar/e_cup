=== НАЧАЛО ОБУЧЕНИЯ 2025-08-30 13:45:01 ===

[2025-08-30 13:45:01] === РЕЖИМ МАСШТАБИРОВАНИЯ: FULL ===
[2025-08-30 13:45:01] Пользователей: все
[2025-08-30 13:45:01] Данных: 100.0%
[2025-08-30 13:45:01] === ЗАГРУЗКА ДАННЫХ ===
[2025-08-30 13:45:01] Загружаем данные...
[2025-08-30 13:45:01] orders: найдено 5 файлов, используем 5
[2025-08-30 13:45:03] orders: ограничено 100,000 из 18,887,122 строк (семплирование 0.5%, использовано 5 файлов), ~4.5 MB
[2025-08-30 13:45:03] tracker: найдено 200 файлов, используем 200
[2025-08-30 13:47:07] tracker: ограничено 100,003 из 1,644,982,482 строк (семплирование 0.0%, использовано 200 файлов), ~4.0 MB
[2025-08-30 13:47:07] items: найдено 100 файлов, используем 100
[2025-08-30 13:47:20] items: ограничено 99,999 из 6,439,422 строк (семплирование 1.6%, использовано 100 файлов), ~17.6 MB
[2025-08-30 13:47:20] categories: найдено 1 файлов, используем 1
[2025-08-30 13:47:20] categories: 7,012 строк (использовано 1 файлов), ~1.7 MB
[2025-08-30 13:47:20] test_users: найдено 1 файлов, используем 1
[2025-08-30 13:47:20] test_users: ограничено 100,000 из 470,347 строк (семплирование 21.3%, использовано 1 файлов), ~1.1 MB
[2025-08-30 13:47:20] Данные загружены
[2025-08-30 13:47:20] Фильтрация данных...
[2025-08-30 13:47:20] Фильтрация завершена
[2025-08-30 13:47:20] Загрузка данных завершена за 0:02:19.054816
[2025-08-30 13:47:20] === ЗАГРУЗКА ЭМБЕДДИНГОВ ===
[2025-08-30 13:47:20] Оптимизированная потоковая загрузка эмбеддингов...
[2025-08-30 13:47:26] Загружено эмбеддингов для 99965 товаров
[2025-08-30 13:47:26] Пример ключей в embeddings_dict: [253371956, 48825500, 167428601, 204884346, 138140400]
[2025-08-30 13:47:26] Пример значения: [ 0.17496556 -0.13686967  0.09135273 -0.1721305   0.5205009 ]
[2025-08-30 13:47:26] Загрузка эмбеддингов завершена за 0:00:06.464223
[2025-08-30 13:47:26] Загружено эмбеддингов: 99965
[2025-08-30 13:47:26] === SPLIT ДАННЫХ ===
[2025-08-30 13:47:27] Split данных завершен за 0:00:00.871815
[2025-08-30 13:47:27] Train orders: 75960, Test orders: 18989
[2025-08-30 13:47:27] === ПОДГОТОВКА ВЗАИМОДЕЙСТВИЙ ===
[2025-08-30 13:47:27] Формируем матрицу взаимодействий по батчам...
[2025-08-30 13:47:27] ✅ Найдено 11 существующих файлов, пропускаем создание
[2025-08-30 13:47:27] Подготовка взаимодействий завершена за 0:00:00.000406
[2025-08-30 13:47:27] Создано файлов взаимодействий: 11
[2025-08-30 13:47:27] === ПОСЛЕДНИЕ ТОВАРЫ ===
[2025-08-30 13:47:35] Словарь сохранен в /home/root6/python/e_cup/rec_system/data/processed/recent_items_map.pkl
[2025-08-30 13:47:35] Построение recent items map завершено за 0:00:08.012213
[2025-08-30 13:47:35] Пользователей с recent items: 941932
[2025-08-30 13:47:35] === ОБУЧЕНИЕ ALS ДЛЯ ПРИЗНАКОВ ===
[2025-08-30 13:47:35] Первый проход: построение маппингов...
[2025-08-30 13:47:36] Маппинги построены. Уников: users=941932, items=244938
[2025-08-30 13:47:36] item_map сохранен: /home/root6/python/e_cup/rec_system/data/processed/item_map.pkl
[2025-08-30 13:47:36] Сохранение батчей на диск...
[2025-08-30 13:47:37] Обучение als_model...
[2025-08-30 13:47:44] Очистка временных файлов...
[2025-08-30 13:47:44] Директория батчей удалена
[2025-08-30 13:47:44] Обучение завершено!
[2025-08-30 13:47:44] Считаем глобальную популярность на основе тренировочных данных...
[2025-08-30 13:47:44] Глобальная популярность рассчитана на 75959 тренировочных заказах
[2025-08-30 13:47:44] Обучение ALS завершено за 0:00:08.801830
[2025-08-30 13:47:44] Пользователей: 941932, Товаров: 244938
[2025-08-30 13:47:44] === ПОСТРОЕНИЕ ДОПОЛНИТЕЛЬНЫХ ДАННЫХ ===
[2025-08-30 13:47:44] Строим co-purchase матрицу для топ-N товаров...
[2025-08-30 13:47:44] Топ-500 популярных товаров определены
[2025-08-30 13:47:46] Обрабатываем 2 корзин с популярными товарами
[2025-08-30 13:47:46] Уникальных популярных товаров: 500
[2025-08-30 13:47:46] Создаем sparse матрицу из 14 взаимодействий...
[2025-08-30 13:47:46] Sparse матрица построена: torch.Size([500, 500]), ненулевых элементов: 3
[2025-08-30 13:47:46] Формируем рекомендации...
[2025-08-30 13:47:46] Co-purchase словарь построен для 3 товаров
[2025-08-30 13:47:46] В среднем 1.0 рекомендаций на товар
[2025-08-30 13:47:46] Co-purchase map построен: 3 товаров
[2025-08-30 13:47:52] Построение категорийных маппингов...
[2025-08-30 13:47:52] Категорийные маппинги построены: 99965 товаров, 430 категорий
[2025-08-30 13:47:52] Построение дополнительных данных завершено за 0:00:07.645114
[2025-08-30 13:47:52] === ПРЕДВАРИТЕЛЬНЫЙ РАСЧЕТ ПРИЗНАКОВ ДЛЯ LGBM ===
[2025-08-30 13:47:52] Построение словаря пользовательских признаков...
[2025-08-30 13:47:53] Агрегация по заказам...
[2025-08-30 13:47:54] Словарь пользовательских признаков построен и сохранён в /home/root6/python/e_cup/rec_system/data/processed/cat_to_items.pkl. Записей: 941933
[2025-08-30 13:47:54] User features построены за 0:00:02.779685: 941933 пользователей
[2025-08-30 13:47:54] Построение словаря товарных признаков...
[2025-08-30 13:47:56] Добавление данных из items_df...
[2025-08-30 13:47:56] Добавление эмбеддингов...
[2025-08-30 13:47:56] Словарь товарных признаков построен. Записей: 244939
[2025-08-30 13:47:57] Item features: 244939 товаров, размер вектора: 7 признаков
[2025-08-30 13:47:57] Порядок признаков: ['item_count', 'item_mean', 'item_sum', 'item_max', 'item_min', 'item_orders_count', 'item_category']
[2025-08-30 13:47:57] item_features_dict[130920537] type=<class 'numpy.ndarray'>, shape=(7,), example=[ 32.         8.259011 264.28836   32.95837    4.936199]
[2025-08-30 13:47:57] item_features_dict[180304892] type=<class 'numpy.ndarray'>, shape=(7,), example=[ 19.          7.1478276 135.80873    30.15535     2.059239 ]
[2025-08-30 13:47:57] item_features_dict[58202107] type=<class 'numpy.ndarray'>, shape=(7,), example=[5.7800000e+02 6.7179008e+00 3.8829468e+03 3.3945084e+01 3.6464313e-01]
[2025-08-30 13:47:57] item_features_dict[66583883] type=<class 'numpy.ndarray'>, shape=(7,), example=[3.3200000e+02 6.9697199e+00 2.3139470e+03 3.3603752e+01 3.6464313e-01]
[2025-08-30 13:47:57] item_features_dict[247670670] type=<class 'numpy.ndarray'>, shape=(7,), example=[1.3800000e+02 6.7026119e+00 9.2496045e+02 3.3672958e+01 6.7294449e-01]
[2025-08-30 13:47:57] Item features построены за 0:00:02.691685
[2025-08-30 13:47:57] === ПОДГОТОВКА ДАННЫХ ДЛЯ LightGBM ===
[2025-08-30 13:47:57] Подготовка данных для LightGBM (streaming, polars lazy, векторно)...
[2025-08-30 13:48:00] ✅ Данные подготовлены без утечек памяти
[2025-08-30 13:48:00] Размер train: 121392, validation: 70
[2025-08-30 13:48:00] Признаки: 14
[2025-08-30 13:48:00] Подготовка данных для LightGBM завершена за 0:00:02.731321
[2025-08-30 13:48:00] === ДЕТАЛЬНАЯ ПРОВЕРКА FEATURE GENERATION ===
[2025-08-30 13:48:00] --- ПРОВЕРКА USER FEATURES ---
[2025-08-30 13:48:00] Пример user features для пользователя 455120:
[2025-08-30 13:48:00]   user_count: 211
[2025-08-30 13:48:00]   user_mean: 5.3751792850272775
[2025-08-30 13:48:00]   user_sum: 1134.1628291407555
[2025-08-30 13:48:00]   user_max: 30.05682604407159
[2025-08-30 13:48:00]   user_min: 0.36464311358790924
[2025-08-30 13:48:00]   user_orders_count: 0
[2025-08-30 13:48:00] Пользователей с features: 941933
[2025-08-30 13:48:00] Пользователей с НЕнулевыми features: 941933
[2025-08-30 13:48:00] --- ПРОВЕРКА ITEM FEATURES ---
[2025-08-30 13:48:00] Пример item features для товара 130920537:
[2025-08-30 13:48:00]   emb_0: 32.0
[2025-08-30 13:48:00]   emb_1: 8.259011268615723
[2025-08-30 13:48:00]   emb_2: 264.2883605957031
[2025-08-30 13:48:00]   emb_3: 32.958370208740234
[2025-08-30 13:48:00]   emb_4: 4.936199188232422
[2025-08-30 13:48:00]   emb_5: 0.0
[2025-08-30 13:48:00]   emb_6: 0.0
[2025-08-30 13:48:00] Товаров с features: 244939
[2025-08-30 13:48:00] Товаров с НЕнулевыми features: 244939
[2025-08-30 13:48:00] --- ПРОВЕРКА ЭМБЕДДИНГОВ ---
[2025-08-30 13:48:00] Пример эмбеддинга для товара 253371956: shape (512,)
[2025-08-30 13:48:00] Эмбеддингов загружено: 99965
[2025-08-30 13:48:00] Пример значений: [ 0.17496556 -0.13686967  0.09135273 -0.1721305   0.5205009 ]
[2025-08-30 13:48:00] --- ПРОВЕРКА CO-PURCHASE MAP ---
[2025-08-30 13:48:00] Пример co-purchase для товара 229404153: 1 товаров
[2025-08-30 13:48:00] Co-purchase записей: 3
[2025-08-30 13:48:00] --- ПРОВЕРКА КАТЕГОРИЙНЫХ МАППИНГОВ ---
[2025-08-30 13:48:00] Товар 253371956 -> категория 7582
[2025-08-30 13:48:00] Категория 7582 -> 214 товаров
[2025-08-30 13:48:00] Товаров в маппинге: 99965
[2025-08-30 13:48:00] Категорий в маппинге: 430
[2025-08-30 13:48:00] Проверка признаков завершена за 0:00:00.463948
[2025-08-30 13:48:00] === ОБУЧЕНИЕ LightGBM ===
[2025-08-30 13:48:00] === ДЕБАГ ИНФОРМАЦИЯ: TRAIN ===
[2025-08-30 13:48:00] Размер: 121392 строк
[2025-08-30 13:48:00] Колонки: ['item_id', 'user_id', 'created_timestamp', 'last_status', 'target', 'weight', 'user_count', 'user_mean', 'user_sum', 'user_max', 'user_min', 'user_orders_count', 'emb_0', 'emb_1', 'emb_2', 'emb_3', 'emb_4', 'emb_5', 'emb_6', 'copurchase_count']
[2025-08-30 13:48:00] ✅ Все признаки присутствуют
[2025-08-30 13:48:00] Целевая переменная: {1: np.int64(66432), 0: np.int64(54960)}
[2025-08-30 13:48:00] Пример первой строки:
[2025-08-30 13:48:00]   item_id: 315358564
[2025-08-30 13:48:00]   user_id: 2160310
[2025-08-30 13:48:00]   created_timestamp: 2025-06-10 13:28:28.370000
[2025-08-30 13:48:00]   last_status: canceled_orders
[2025-08-30 13:48:00]   target: 0
[2025-08-30 13:48:00]   weight: 0.0
[2025-08-30 13:48:00]   user_count: 120.0
[2025-08-30 13:48:00]   user_mean: 6.592827279875918
[2025-08-30 13:48:00]   user_sum: 791.1392735851101
[2025-08-30 13:48:00]   user_max: 30.44522437723423
[2025-08-30 13:48:00]   user_min: 0.36464311358790924
[2025-08-30 13:48:00]   user_orders_count: 3.0
[2025-08-30 13:48:00]   emb_0: 133.0
[2025-08-30 13:48:00]   emb_1: 4.964491844177246
[2025-08-30 13:48:00]   emb_2: 660.2774047851562
[2025-08-30 13:48:00]   emb_3: 29.123506546020508
[2025-08-30 13:48:00]   emb_4: 0.3646431267261505
[2025-08-30 13:48:00]   emb_5: 1.0
[2025-08-30 13:48:00]   emb_6: 0.0
[2025-08-30 13:48:00]   copurchase_count: 0.0
[2025-08-30 13:48:00] === ДЕБАГ ИНФОРМАЦИЯ: VAL ===
[2025-08-30 13:48:00] Размер: 70 строк
[2025-08-30 13:48:00] Колонки: ['item_id', 'user_id', 'created_timestamp', 'last_status', 'target', 'weight', 'user_count', 'user_mean', 'user_sum', 'user_max', 'user_min', 'user_orders_count', 'emb_0', 'emb_1', 'emb_2', 'emb_3', 'emb_4', 'emb_5', 'emb_6', 'copurchase_count']
[2025-08-30 13:48:00] ✅ Все признаки присутствуют
[2025-08-30 13:48:00] Целевая переменная: {0: np.int64(44), 1: np.int64(26)}
[2025-08-30 13:48:00] Пример первой строки:
[2025-08-30 13:48:00]   item_id: 16938974
[2025-08-30 13:48:00]   user_id: 3435341
[2025-08-30 13:48:00]   created_timestamp: 2025-05-27 20:45:09.510000
[2025-08-30 13:48:00]   last_status: canceled_orders
[2025-08-30 13:48:00]   target: 0
[2025-08-30 13:48:00]   weight: 0.36464311358790924
[2025-08-30 13:48:00]   user_count: 369
[2025-08-30 13:48:00]   user_mean: 6.358004192571417
[2025-08-30 13:48:00]   user_sum: 2346.1035470588527
[2025-08-30 13:48:00]   user_max: 31.000922888782338
[2025-08-30 13:48:00]   user_min: 0.36464311358790924
[2025-08-30 13:48:00]   user_orders_count: 1
[2025-08-30 13:48:00]   emb_0: 785.0
[2025-08-30 13:48:00]   emb_1: 7.0104899406433105
[2025-08-30 13:48:00]   emb_2: 5503.234375
[2025-08-30 13:48:00]   emb_3: 33.60375213623047
[2025-08-30 13:48:00]   emb_4: 0.3646431267261505
[2025-08-30 13:48:00]   emb_5: 1.0
[2025-08-30 13:48:00]   emb_6: 0.0
[2025-08-30 13:48:00]   copurchase_count: 0.0
[2025-08-30 13:48:00] Feature columns: ['copurchase_count', 'user_count', 'user_mean', 'user_sum', 'user_max', 'user_min', 'user_orders_count', 'emb_0', 'emb_1', 'emb_2', 'emb_3', 'emb_4', 'emb_5', 'emb_6']
[2025-08-30 13:48:00] Размер train: 121392
[2025-08-30 13:48:00] Количество пользователей в train: 80392
[2025-08-30 13:48:00] Размер val: 70
[2025-08-30 13:48:00] Количество пользователей в val: 30
[2025-08-30 13:48:02] [Iter 0] train_ndcg@100: 0.575583, valid_ndcg@100: 0.477709
[2025-08-30 13:48:09] ✅ [Iter 3] Новый лучший valid_ndcg@100: 0.499430
[2025-08-30 13:48:22] ✅ [Iter 9] Новый лучший valid_ndcg@100: 0.500000
[2025-08-30 13:48:22] 🎯 Финальный NDCG@100 на валидации: 0.500000
[2025-08-30 13:48:22] 📈 Лучший NDCG@100: 0.500000 на итерации 9
[2025-08-30 13:48:22] Обучение LightGBM завершено за 0:00:21.575767
[2025-08-30 13:48:22] === ВАЖНОСТЬ ПРИЗНАКОВ ===
[2025-08-30 13:48:22] Топ-20 важных признаков:
[2025-08-30 13:48:22]   user_count: 58
[2025-08-30 13:48:22]   emb_1: 46
[2025-08-30 13:48:22]   emb_0: 45
[2025-08-30 13:48:22]   emb_2: 42
[2025-08-30 13:48:22]   user_sum: 22
[2025-08-30 13:48:22]   user_max: 20
[2025-08-30 13:48:22]   emb_3: 20
[2025-08-30 13:48:22]   emb_4: 15
[2025-08-30 13:48:22]   user_orders_count: 11
[2025-08-30 13:48:22]   user_mean: 7
[2025-08-30 13:48:22]   emb_5: 7
[2025-08-30 13:48:22]   user_min: 6
[2025-08-30 13:48:22]   emb_6: 1
[2025-08-30 13:48:22]   copurchase_count: 0
[2025-08-30 13:48:22] Анализ важности признаков завершен за 0:00:00.001398
[2025-08-30 13:48:22] === СОХРАНЕНИЕ МОДЕЛИ И ПРИЗНАКОВ ===
[2025-08-30 13:48:24] Сохранение модели завершено за 0:00:01.741497
[2025-08-30 13:48:24] Модель сохранена в: /home/root6/python/e_cup/rec_system/src/models/lgbm_model_full.pkl
[2025-08-30 13:48:24] === ОБУЧЕНИЕ И ПРЕДСКАЗАНИЯ ЗАВЕРШЕНЫ УСПЕШНО ===
[2025-08-30 13:48:24] Общее время выполнения: 0:03:22.837270
[2025-08-30 13:48:24] Пользователей: 941932
[2025-08-30 13:48:24] Товаров: 244938
[2025-08-30 13:48:24] Признаков: 14
[2025-08-30 13:48:24] === СИСТЕМНАЯ ИНФОРМАЦИЯ ===
[2025-08-30 13:48:24] Видеокарта: NVIDIA GeForce RTX 4090
[2025-08-30 13:48:24] Память GPU: 24.0 GB
[2025-08-30 13:48:24] Процессор: 28.1% загрузки
[2025-08-30 13:48:24] Ядра CPU: 32
[2025-08-30 13:48:24] Частота CPU: 2995.2 MHz
[2025-08-30 13:48:24] Оперативная память: 94.2 GB всего, 61.0 GB использовано
[2025-08-30 13:48:24] ==========================================
[2025-08-30 13:48:24] ВСЕ ЭТАПЫ ВЫПОЛНЕНЫ УСПЕШНО!
[2025-08-30 13:48:24] ==========================================

=== ОБЩЕЕ ВРЕМЯ ВЫПОЛНЕНИЯ: 0:03:22.838189 ===
