=== НАЧАЛО ОБУЧЕНИЯ 2025-08-27 01:12:47 ===

[2025-08-27 01:12:47] === РЕЖИМ МАСШТАБИРОВАНИЯ: FULL ===
[2025-08-27 01:12:47] Пользователей: все
[2025-08-27 01:12:47] Данных: 100.0%
[2025-08-27 01:12:47] === ЗАГРУЗКА ДАННЫХ ===
[2025-08-27 01:12:47] Загружаем данные...
[2025-08-27 01:12:47] orders: 1,000 строк (использовано 28 из 28 партиций), ~0.0 MB
[2025-08-27 01:12:48] tracker: 1,000 строк (использовано 298 из 298 партиций), ~0.0 MB
[2025-08-27 01:12:49] items: 1,000 строк (использовано 200 из 200 партиций), ~0.2 MB
[2025-08-27 01:12:49] categories: 1,000 строк (использовано 1 из 1 партиций), ~0.2 MB
[2025-08-27 01:12:49] test_users: 1,000 строк (использовано 1 из 1 партиций), ~0.0 MB
[2025-08-27 01:12:49] Данные загружены
[2025-08-27 01:12:49] Фильтрация данных...
[2025-08-27 01:12:49] Фильтрация завершена
[2025-08-27 01:12:49] Загрузка данных завершена за 0:00:01.703514
[2025-08-27 01:12:49] === ЗАГРУЗКА ЭМБЕДДИНГОВ ===
[2025-08-27 01:12:49] Оптимизированная потоковая загрузка эмбеддингов...
[2025-08-27 01:12:49] Загружено эмбеддингов для 990 товаров
[2025-08-27 01:12:49] Загрузка эмбеддингов завершена за 0:00:00.736774
[2025-08-27 01:12:49] Загружено эмбеддингов: 990
[2025-08-27 01:12:49] === SPLIT ДАННЫХ ===
[2025-08-27 01:12:49] Split данных завершен за 0:00:00.016262
[2025-08-27 01:12:49] Train orders: 684, Test orders: 170
[2025-08-27 01:12:49] === ПОДГОТОВКА ВЗАИМОДЕЙСТВИЙ ===
[2025-08-27 01:12:49] Формируем матрицу взаимодействий по батчам...
[2025-08-27 01:12:49] ... для orders
[2025-08-27 01:12:50] Сохранен orders-батч 0-684
[2025-08-27 01:12:50] ... для tracker
[2025-08-27 01:12:50] Сохранен tracker-партиция 0
[2025-08-27 01:12:50] Все батчи сохранены на диск.
[2025-08-27 01:12:50] Подготовка взаимодействий завершена за 0:00:00.818250
[2025-08-27 01:12:50] Создано файлов взаимодействий: 2
[2025-08-27 01:12:50] === ПОСЛЕДНИЕ ТОВАРЫ ===
[2025-08-27 01:12:50] Построение recent items map завершено за 0:00:00.024371
[2025-08-27 01:12:50] Пользователей с recent items: 1183
[2025-08-27 01:12:50] === ОБУЧЕНИЕ ALS ДЛЯ ПРИЗНАКОВ ===
[2025-08-27 01:12:50] Первый проход: построение маппингов...
[2025-08-27 01:12:50] Маппинги построены. Уников: users=1183, items=606
[2025-08-27 01:12:50] Сохранение батчей на диск...
[2025-08-27 01:12:50] Постепенное обучение...
[2025-08-27 01:12:51] Очистка временных файлов...
[2025-08-27 01:12:51] Директория батчей удалена
[2025-08-27 01:12:51] Обучение завершено!
[2025-08-27 01:12:51] Считаем глобальную популярность на основе тренировочных данных...
[2025-08-27 01:12:51] Глобальная популярность рассчитана на 683 тренировочных заказах
[2025-08-27 01:12:51] Обучение ALS завершено за 0:00:00.806567
[2025-08-27 01:12:51] Пользователей: 1183, Товаров: 606
[2025-08-27 01:12:51] === ПОСТРОЕНИЕ ДОПОЛНИТЕЛЬНЫХ ДАННЫХ ===
[2025-08-27 01:12:51] Строим co-purchase матрицу для топ-N товаров...
[2025-08-27 01:12:51] Топ-603 популярных товаров определены
[2025-08-27 01:12:51] Обрабатываем 2 корзин с популярными товарами
[2025-08-27 01:12:51] Уникальных популярных товаров: 603
[2025-08-27 01:12:51] Создаем sparse матрицу из 4 взаимодействий...
[2025-08-27 01:12:51] Sparse матрица построена: torch.Size([603, 603]), ненулевых элементов: 4
[2025-08-27 01:12:51] Формируем рекомендации...
[2025-08-27 01:12:51] Co-purchase словарь построен для 4 товаров
[2025-08-27 01:12:51] В среднем 1.0 рекомендаций на товар
[2025-08-27 01:12:51] Co-purchase map построен: 4 товаров
[2025-08-27 01:12:51] Построение категорийных маппингов...
[2025-08-27 01:12:51] Категорийные маппинги построены: 990 товаров, 223 категорий
[2025-08-27 01:12:51] Построение дополнительных данных завершено за 0:00:00.311475
[2025-08-27 01:12:51] === ПРЕДВАРИТЕЛЬНЫЙ РАСЧЕТ ПРИЗНАКОВ ДЛЯ LGBM ===
[2025-08-27 01:12:51] Построение словаря пользовательских признаков...
[2025-08-27 01:12:51] Агрегация по заказам...
[2025-08-27 01:12:52] Словарь пользовательских признаков построен. Записей: 1184
[2025-08-27 01:12:52] User features построены за 0:00:00.047907: 1184 пользователей
[2025-08-27 01:12:52] Построение словаря товарных признаков...
[2025-08-27 01:12:52] Добавление данных из items_df...
[2025-08-27 01:12:52] Добавление эмбеддингов...
[2025-08-27 01:12:52] Словарь товарных признаков построен. Записей: 607
[2025-08-27 01:12:52] Item features построены за 0:00:00.049953: 607 товаров
[2025-08-27 01:12:52] Создание UI-признаков (данные остаются на диске)
[2025-08-27 01:12:52] Создано 2 файлов UI-признаков в: /home/root6/python/e_cup/rec_system/data/processed/ui_features_distributed
[2025-08-27 01:12:52] User-Item features созданы в: /home/root6/python/e_cup/rec_system/data/processed/ui_features_distributed
[2025-08-27 01:12:52] Количество файлов: 2
[2025-08-27 01:12:52] User-Item features построены за 0:00:00.016091
[2025-08-27 01:12:52] Предварительный расчет признаков завершен за 0:00:00.114125
[2025-08-27 01:12:52] === ПОДГОТОВКА ДАННЫХ ДЛЯ LightGBM ===
[2025-08-27 01:12:52] Подготовка данных для LightGBM (streaming)...
[2025-08-27 01:12:53] Обучение матрицы ковизитации на train данных...
[2025-08-27 01:12:53] Размер матрицы ковизитации: 6 товаров
[2025-08-27 01:12:53] Добавление фичей для train данных...
[2025-08-27 01:12:53] Добавление богатых признаков...
[2025-08-27 01:12:53] Ускоренная обработка FCLIP эмбеддингов на GPU...
[2025-08-27 01:12:53] Обработка FCLIP измерения 1/10 на GPU...
[2025-08-27 01:12:53] Обработка FCLIP измерения 2/10 на GPU...
[2025-08-27 01:12:53] Обработка FCLIP измерения 3/10 на GPU...
[2025-08-27 01:12:53] Обработка FCLIP измерения 4/10 на GPU...
[2025-08-27 01:12:53] Обработка FCLIP измерения 5/10 на GPU...
[2025-08-27 01:12:53] Обработка FCLIP измерения 6/10 на GPU...
[2025-08-27 01:12:53] Обработка FCLIP измерения 7/10 на GPU...
[2025-08-27 01:12:53] Обработка FCLIP измерения 8/10 на GPU...
[2025-08-27 01:12:53] Обработка FCLIP измерения 9/10 на GPU...
[2025-08-27 01:12:53] Обработка FCLIP измерения 10/10 на GPU...
[2025-08-27 01:12:53] Добавлены фичи: ['is_weekend', 'hour', 'item_popularity', 'category_popularity', 'user_activity', 'user_avg_item_popularity', 'covisitation_score', 'fclip_embed_0', 'fclip_embed_1', 'fclip_embed_2', 'fclip_embed_3', 'fclip_embed_4', 'fclip_embed_5', 'fclip_embed_6', 'fclip_embed_7', 'fclip_embed_8', 'fclip_embed_9']
[2025-08-27 01:12:53] Всего фич после добавления: 17
[2025-08-27 01:12:53] Добавление фичей для val данных (на основе train статистик)...
[2025-08-27 01:12:53] Добавление богатых признаков...
[2025-08-27 01:12:53] Ускоренная обработка FCLIP эмбеддингов на GPU...
[2025-08-27 01:12:53] Обработка FCLIP измерения 1/10 на GPU...
[2025-08-27 01:12:53] Обработка FCLIP измерения 2/10 на GPU...
[2025-08-27 01:12:53] Обработка FCLIP измерения 3/10 на GPU...
[2025-08-27 01:12:53] Обработка FCLIP измерения 4/10 на GPU...
[2025-08-27 01:12:53] Обработка FCLIP измерения 5/10 на GPU...
[2025-08-27 01:12:53] Обработка FCLIP измерения 6/10 на GPU...
[2025-08-27 01:12:53] Обработка FCLIP измерения 7/10 на GPU...
[2025-08-27 01:12:53] Обработка FCLIP измерения 8/10 на GPU...
[2025-08-27 01:12:53] Обработка FCLIP измерения 9/10 на GPU...
[2025-08-27 01:12:53] Обработка FCLIP измерения 10/10 на GPU...
[2025-08-27 01:12:53] Добавлены фичи: ['is_weekend', 'hour', 'item_popularity', 'category_popularity', 'user_activity', 'user_avg_item_popularity', 'covisitation_score', 'fclip_embed_0', 'fclip_embed_1', 'fclip_embed_2', 'fclip_embed_3', 'fclip_embed_4', 'fclip_embed_5', 'fclip_embed_6', 'fclip_embed_7', 'fclip_embed_8', 'fclip_embed_9']
[2025-08-27 01:12:53] Всего фич после добавления: 17
[2025-08-27 01:12:53] Добавлены UI признаки: ['ui_count', 'ui_sum', 'ui_max', 'ui_min', 'ui_mean', 'ui_days_since_last', 'ui_days_since_first']
[2025-08-27 01:12:53] TRAIN: rows=1975; target_counts={0: 1568, 1: 407}
[2025-08-27 01:12:53] VAL: rows=220; target_counts={0: 177, 1: 43}
[2025-08-27 01:12:53] split_time = 2025-06-25 19:56:09.596000 (val_days=7)
[2025-08-27 01:12:53] ✅ Данные подготовлены: train=1975, val=220
[2025-08-27 01:12:53] Размер train: 1606, validation: 369
[2025-08-27 01:12:53] Признаки: 24
[2025-08-27 01:12:53] Подготовка данных для LightGBM завершена за 0:00:01.161903
[2025-08-27 01:12:53] === ДЕТАЛЬНАЯ ПРОВЕРКА FEATURE GENERATION ===
[2025-08-27 01:12:53] --- ПРОВЕРКА USER FEATURES ---
[2025-08-27 01:12:53] Пример user features для пользователя 2856891:
[2025-08-27 01:12:53]   user_count: 1
[2025-08-27 01:12:53]   user_mean: 0.16394911411495436
[2025-08-27 01:12:53]   user_sum: 0.16394911411495436
[2025-08-27 01:12:53]   user_max: 0.16394911411495436
[2025-08-27 01:12:53]   user_min: 0.16394911411495436
[2025-08-27 01:12:53]   user_last_ts: 2025-07-02 15:09:19.790000
[2025-08-27 01:12:53]   user_first_ts: 2025-07-02 15:09:19.790000
[2025-08-27 01:12:53]   user_orders_count: 1
[2025-08-27 01:12:53]   user_last_order_ts: 2025-07-02 15:09:19.790000
[2025-08-27 01:12:53]   user_first_order_ts: 2025-07-02 15:09:19.790000
[2025-08-27 01:12:53]   user_days_since_last: 55
[2025-08-27 01:12:53]   user_days_since_first: 55
[2025-08-27 01:12:53]   user_days_since_last_order: 55
[2025-08-27 01:12:53] Пользователей с features: 1184
[2025-08-27 01:12:53] Пользователей с НЕнулевыми features: 1184
[2025-08-27 01:12:53] --- ПРОВЕРКА ITEM FEATURES ---
[2025-08-27 01:12:53] Пример item features для товара 127264185:
[2025-08-27 01:12:53]   item_count: 1
[2025-08-27 01:12:53]   item_mean: 0.16394911411495436
[2025-08-27 01:12:53]   item_sum: 0.16394911411495436
[2025-08-27 01:12:53]   item_max: 0.16394911411495436
[2025-08-27 01:12:53]   item_min: 0.16394911411495436
[2025-08-27 01:12:53]   item_last_ts: 2025-07-02 10:11:58.600000
[2025-08-27 01:12:53]   item_first_ts: 2025-07-02 10:11:58.600000
[2025-08-27 01:12:53]   item_orders_count: 1
[2025-08-27 01:12:53]   item_category: None
[2025-08-27 01:12:53]   item_days_since_last: 55
[2025-08-27 01:12:53]   item_days_since_first: 55
[2025-08-27 01:12:53] Товаров с features: 607
[2025-08-27 01:12:53] Товаров с НЕнулевыми features: 607
[2025-08-27 01:12:53] --- ПРОВЕРКА UI FEATURES ---
[2025-08-27 01:12:53] UI features files: 2
[2025-08-27 01:12:53] UI features stats: {}
[2025-08-27 01:12:53] --- ПРОВЕРКА ЭМБЕДДИНГОВ ---
[2025-08-27 01:12:53] Пример эмбеддинга для товара 400301: shape (512,)
[2025-08-27 01:12:53] Эмбеддингов загружено: 990
[2025-08-27 01:12:53] Пример значений: [ 0.32023853  0.11766258 -0.784552    0.4168199  -0.24610527]
[2025-08-27 01:12:53] --- ПРОВЕРКА CO-PURCHASE MAP ---
[2025-08-27 01:12:53] Пример co-purchase для товара 132235443: 1 товаров
[2025-08-27 01:12:53] Co-purchase записей: 4
[2025-08-27 01:12:53] --- ПРОВЕРКА КАТЕГОРИЙНЫХ МАППИНГОВ ---
[2025-08-27 01:12:53] Товар 400301 -> категория 17080
[2025-08-27 01:12:53] Категория 17080 -> 4 товаров
[2025-08-27 01:12:53] Товаров в маппинге: 990
[2025-08-27 01:12:53] Категорий в маппинге: 223
[2025-08-27 01:12:53] Проверка признаков завершена за 0:00:00.001846
[2025-08-27 01:12:53] === ОБУЧЕНИЕ LightGBM ===
[2025-08-27 01:12:53] Размер train: 1606
[2025-08-27 01:12:53] Размер val: 369
[2025-08-27 01:12:53] NDCG@100 на валидации: 0.4842
[2025-08-27 01:12:53] Обучение LightGBM завершено за 0:00:00.066109
[2025-08-27 01:12:53] === ОЦЕНКА МОДЕЛИ ===
[2025-08-27 01:12:53] NDCG@100 train: 0.5509
[2025-08-27 01:12:53] NDCG@100 val: 0.4842
[2025-08-27 01:12:53] Оценка модели завершена за 0:00:00.034404
[2025-08-27 01:12:53] === ВАЖНОСТЬ ПРИЗНАКОВ ===
[2025-08-27 01:12:53] Топ-20 важных признаков:
[2025-08-27 01:12:53]   user_avg_item_popularity: 1458
[2025-08-27 01:12:53]   item_popularity: 641
[2025-08-27 01:12:53]   ui_count: 163
[2025-08-27 01:12:53]   fclip_embed_8: 74
[2025-08-27 01:12:53]   user_activity: 70
[2025-08-27 01:12:53]   covisitation_score: 57
[2025-08-27 01:12:53]   ui_sum: 26
[2025-08-27 01:12:53]   fclip_embed_0: 13
[2025-08-27 01:12:53]   fclip_embed_1: 13
[2025-08-27 01:12:53]   fclip_embed_5: 11
[2025-08-27 01:12:53]   fclip_embed_6: 11
[2025-08-27 01:12:53]   fclip_embed_9: 8
[2025-08-27 01:12:53]   fclip_embed_4: 7
[2025-08-27 01:12:53]   fclip_embed_7: 7
[2025-08-27 01:12:53]   fclip_embed_2: 7
[2025-08-27 01:12:53]   ui_days_since_last: 5
[2025-08-27 01:12:53]   ui_max: 5
[2025-08-27 01:12:53]   ui_days_since_first: 3
[2025-08-27 01:12:53]   ui_min: 2
[2025-08-27 01:12:53]   fclip_embed_3: 1
[2025-08-27 01:12:53] Анализ важности признаков завершен за 0:00:00.002609
[2025-08-27 01:12:53] === СОХРАНЕНИЕ МОДЕЛИ И ПРИЗНАКОВ ===
[2025-08-27 01:12:53] Сохранение модели завершено за 0:00:00.009068
[2025-08-27 01:12:53] Модель сохранена в: /home/root6/python/e_cup/rec_system/src/models/lgbm_model_full.pkl
[2025-08-27 01:12:53] === ОПТИМИЗИРОВАННЫЕ ПРЕДСКАЗАНИЯ С МОДЕЛЬЮ ===
[2025-08-27 01:12:53] Тестовых пользователей для предсказания: 1000
[2025-08-27 01:12:53] Начинаем создание рекомендаций для 1000 пользователей...
[2025-08-27 01:12:54] User 1857340: 100 unique, score: 0.0047
[2025-08-27 01:14:33] Обработано 100/1000 пользователей
[2025-08-27 01:14:33] Текущий батч: 19.62 сек, Среднее время: 1.0059 сек/пользователь
[2025-08-27 01:14:34] User 1756280: 100 unique, score: 0.0047
[2025-08-27 01:16:15] Обработано 200/1000 пользователей
[2025-08-27 01:16:15] Текущий батч: 19.92 сек, Среднее время: 1.0131 сек/пользователь
[2025-08-27 01:16:17] User 4166110: 100 unique, score: 0.0047

=== ОБЩЕЕ ВРЕМЯ ВЫПОЛНЕНИЯ: 0:04:18.081913 ===
