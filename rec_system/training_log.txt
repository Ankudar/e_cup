=== НАЧАЛО ОБУЧЕНИЯ 2025-08-31 16:25:34 ===

[2025-08-31 16:25:34] === РЕЖИМ МАСШТАБИРОВАНИЯ: FULL ===
[2025-08-31 16:25:34] Пользователей: все
[2025-08-31 16:25:34] Данных: 100.0%
[2025-08-31 16:25:34] === ЗАГРУЗКА ДАННЫХ ===
[2025-08-31 16:25:34] Загружаем данные...
[2025-08-31 16:25:34] orders: найдено 5 файлов, используем 5
[2025-08-31 16:25:35] orders: 18,887,122 строк (использовано 5 файлов), ~828.1 MB
[2025-08-31 16:25:35] tracker: найдено 200 файлов, используем 200
[2025-08-31 16:25:52] tracker: 1,644,982,482 строк (использовано 200 файлов), ~65693.4 MB
[2025-08-31 16:25:52] items: найдено 100 файлов, используем 100
[2025-08-31 16:25:58] items: 6,439,422 строк (использовано 100 файлов), ~1134.2 MB
[2025-08-31 16:25:58] categories: найдено 1 файлов, используем 1
[2025-08-31 16:25:58] categories: 7,012 строк (использовано 1 файлов), ~1.7 MB
[2025-08-31 16:25:58] test_users: найдено 1 файлов, используем 1
[2025-08-31 16:25:58] test_users: 470,347 строк (использовано 1 файлов), ~1.8 MB
[2025-08-31 16:25:58] Данные загружены
[2025-08-31 16:25:58] Фильтрация данных...
[2025-08-31 16:25:58] Фильтрация завершена
[2025-08-31 16:25:58] Загрузка данных завершена за 0:00:23.784847
[2025-08-31 16:25:58] === SPLIT ДАННЫХ ===
[2025-08-31 16:26:10] Split данных завершен за 0:00:12.166585
[2025-08-31 16:26:10] Train orders: 13755583, Test orders: 3438892
[2025-08-31 16:26:10] === ПОДГОТОВКА ВЗАИМОДЕЙСТВИЙ ===
[2025-08-31 16:26:10] Формируем матрицу взаимодействий по батчам...
[2025-08-31 16:26:10] ... обработка orders
[2025-08-31 16:26:11] Сохранен orders-батч 0-1000000
[2025-08-31 16:26:11] Сохранен orders-батч 1000000-2000000
[2025-08-31 16:26:11] Сохранен orders-батч 2000000-3000000
[2025-08-31 16:26:11] Сохранен orders-батч 3000000-4000000
[2025-08-31 16:26:11] Сохранен orders-батч 4000000-5000000
[2025-08-31 16:26:12] Сохранен orders-батч 5000000-6000000
[2025-08-31 16:26:12] Сохранен orders-батч 6000000-7000000
[2025-08-31 16:26:12] Сохранен orders-батч 7000000-8000000
[2025-08-31 16:26:12] Сохранен orders-батч 8000000-9000000
[2025-08-31 16:26:12] Сохранен orders-батч 9000000-10000000
[2025-08-31 16:26:13] Сохранен orders-батч 10000000-11000000
[2025-08-31 16:26:13] Сохранен orders-батч 11000000-12000000
[2025-08-31 16:26:13] Сохранен orders-батч 12000000-13000000
[2025-08-31 16:26:13] Сохранен orders-батч 13000000-13755583
[2025-08-31 16:26:13] ... обработка tracker
[2025-08-31 16:26:13] Обрабатываем 10 файлов tracker
[2025-08-31 16:26:15] Обработан tracker файл 0: 5204228 строк
[2025-08-31 16:26:16] Обработан tracker файл 1: 5088402 строк
[2025-08-31 16:26:17] Обработан tracker файл 2: 5045487 строк
[2025-08-31 16:26:18] Обработан tracker файл 3: 4987285 строк
[2025-08-31 16:26:20] Обработан tracker файл 4: 4989096 строк
[2025-08-31 16:26:21] Обработан tracker файл 5: 5219465 строк
[2025-08-31 16:26:22] Обработан tracker файл 6: 5030300 строк
[2025-08-31 16:26:24] Обработан tracker файл 7: 5186810 строк
[2025-08-31 16:26:25] Обработан tracker файл 8: 5120177 строк
[2025-08-31 16:26:26] Обработан tracker файл 9: 5067673 строк
[2025-08-31 16:26:26] ✅ Все файлы успешно созданы
[2025-08-31 16:26:26] Всего файлов взаимодействий: 24
[2025-08-31 16:26:26] Подготовка взаимодействий завершена за 0:00:15.885711
[2025-08-31 16:26:26] Создано файлов взаимодействий: 24
[2025-08-31 16:26:26] === ПОСЛЕДНИЕ ТОВАРЫ ===
[2025-08-31 16:26:42] Словарь сохранен в /home/root6/python/e_cup/rec_system/data/processed/recent_items_map.pkl
[2025-08-31 16:26:42] Построение recent items map завершено за 0:00:16.076949
[2025-08-31 16:26:42] Пользователей с recent items: 960818
[2025-08-31 16:26:42] === ОБУЧЕНИЕ ALS ДЛЯ ПРИЗНАКОВ ===
[2025-08-31 16:26:42] Первый проход: построение маппингов...
[2025-08-31 16:26:46] Маппинги построены. Уников: users=960818, items=3972133
[2025-08-31 16:26:46] item_map сохранен: /home/root6/python/e_cup/rec_system/data/processed/item_map.pkl
[2025-08-31 16:26:46] Сохранение батчей на диск...
[2025-08-31 16:26:48] Обучение als_model...
[2025-08-31 16:27:01] Очистка временных файлов...
[2025-08-31 16:27:01] Директория батчей удалена
[2025-08-31 16:27:01] Обучение завершено!
[2025-08-31 16:27:01] Считаем глобальную популярность на основе тренировочных данных...
[2025-08-31 16:27:03] Глобальная популярность рассчитана на 13755580 тренировочных заказах
[2025-08-31 16:27:03] Обучение ALS завершено за 0:00:20.681155
[2025-08-31 16:27:03] Пользователей: 960818, Товаров: 3972133
[2025-08-31 16:27:03] === ПОСТРОЕНИЕ ДОПОЛНИТЕЛЬНЫХ ДАННЫХ ===
[2025-08-31 16:27:03] Строим co-purchase матрицу для топ-N товаров...
[2025-08-31 16:27:04] Топ-1000 популярных товаров определены
[2025-08-31 16:28:44] Обрабатываем 15477 корзин с популярными товарами
[2025-08-31 16:28:44] Уникальных популярных товаров: 1000
[2025-08-31 16:28:44] Создаем sparse матрицу из 42752 взаимодействий...
[2025-08-31 16:28:44] Sparse матрица построена: torch.Size([1000, 1000]), ненулевых элементов: 17546
[2025-08-31 16:28:44] Формируем рекомендации...
[2025-08-31 16:28:46] Co-purchase словарь построен для 996 товаров
[2025-08-31 16:28:46] В среднем 12.9 рекомендаций на товар
[2025-08-31 16:28:46] Co-purchase map построен: 996 товаров
[2025-08-31 16:28:56] Построение категорийных маппингов...
[2025-08-31 16:28:58] Категорийные маппинги построены: 6342024 товаров, 478 категорий
[2025-08-31 16:28:58] Построение дополнительных данных завершено за 0:01:55.059569
[2025-08-31 16:28:58] === ПРЕДВАРИТЕЛЬНЫЙ РАСЧЕТ ПРИЗНАКОВ ДЛЯ LGBM ===
[2025-08-31 16:28:58] Построение словаря пользовательских признаков...
[2025-08-31 16:29:00] Агрегация по заказам...
[2025-08-31 16:29:07] Словарь пользовательских признаков построен и сохранён в /home/root6/python/e_cup/rec_system/data/processed/cat_to_items.pkl. Записей: 960819
[2025-08-31 16:29:08] User features построены за 0:00:09.377969: 960819 пользователей
[2025-08-31 16:29:08] Построение словаря товарных признаков с батчевой обработкой...
[2025-08-31 16:29:08] Батчевая агрегация взаимодействий...
[2025-08-31 16:29:09] Объединение статистик...
[2025-08-31 16:29:10] Обработка заказов...
[2025-08-31 16:29:24] Ошибка обработки партиции 3: tuple index out of range
[2025-08-31 16:29:24] Ошибка обработки партиции 4: tuple index out of range
[2025-08-31 16:29:24] Обработка items...
[2025-08-31 16:29:56] Объединение всех данных...
[2025-08-31 16:29:59] Создание финального словаря...
[2025-08-31 16:30:07] Очистка временных файлов...
[2025-08-31 16:30:07] Словарь товарных признаков построен. Записей: 6342024
[2025-08-31 16:30:12] Item features: 6342024 товаров, размер вектора: 7 признаков
[2025-08-31 16:30:12] Порядок признаков: ['item_min', 'item_category', 'item_count', 'item_orders_count', 'item_mean', 'item_max', 'item_sum']
[2025-08-31 16:30:13] item_features_dict[251658241] type=<class 'numpy.ndarray'>, shape=(7,), example=[1.5769147e+00 3.1655000e+04 2.7000000e+01 3.0000000e+00 5.7130785e+00]
[2025-08-31 16:30:13] item_features_dict[184549381] type=<class 'numpy.ndarray'>, shape=(7,), example=[1.4722195e+01 3.6608000e+04 1.0000000e+00 1.0000000e+00 1.4722195e+01]
[2025-08-31 16:30:13] item_features_dict[234881038] type=<class 'numpy.ndarray'>, shape=(7,), example=[1.2588482e+01 1.7136000e+04 1.0000000e+00 1.0000000e+00 1.2588482e+01]
[2025-08-31 16:30:13] item_features_dict[285212687] type=<class 'numpy.ndarray'>, shape=(7,), example=[0.000e+00 7.512e+03 0.000e+00 2.000e+00 0.000e+00]
[2025-08-31 16:30:13] item_features_dict[83886101] type=<class 'numpy.ndarray'>, shape=(7,), example=[    0. 31308.     0.     0.     0.]
[2025-08-31 16:30:28] Item features построены за 0:01:20.510800
[2025-08-31 16:30:28] === ПОДГОТОВКА ДАННЫХ ДЛЯ LightGBM ===
[2025-08-31 16:30:28] Подготовка данных для LightGBM (streaming, polars lazy, батчи)...
[2025-08-31 16:30:50] ✅ Данные подготовлены без утечек памяти
[2025-08-31 16:30:50] Размер train: 22646731, validation: 140544
[2025-08-31 16:30:50] Признаки: 13
[2025-08-31 16:30:50] Подготовка данных для LightGBM завершена за 0:00:21.974495
[2025-08-31 16:30:50] === ДЕТАЛЬНАЯ ПРОВЕРКА FEATURE GENERATION ===
[2025-08-31 16:30:50] --- ПРОВЕРКА USER FEATURES ---
[2025-08-31 16:30:50] Пример user features для пользователя 75900:
[2025-08-31 16:30:50]   user_count: 14
[2025-08-31 16:30:50]   user_mean: 9.351472337153538
[2025-08-31 16:30:50]   user_sum: 130.92061272014953
[2025-08-31 16:30:50]   user_max: 33.32204510175204
[2025-08-31 16:30:50]   user_min: 3.445533195482207
[2025-08-31 16:30:50]   user_orders_count: 4
[2025-08-31 16:30:50] Пользователей с features: 960819
[2025-08-31 16:30:50] Пользователей с НЕнулевыми features: 960819
[2025-08-31 16:30:50] --- ПРОВЕРКА ITEM FEATURES ---
[2025-08-31 16:30:50] Товаров с features: 6342024
[2025-08-31 16:30:50] --- ПРОВЕРКА CO-PURCHASE MAP ---
[2025-08-31 16:30:50] Пример co-purchase для товара 51974017: 20 товаров
[2025-08-31 16:30:50] Co-purchase записей: 996
[2025-08-31 16:30:50] --- ПРОВЕРКА КАТЕГОРИЙНЫХ МАППИНГОВ ---
[2025-08-31 16:30:50] Товар 5264590 -> категория 36517
[2025-08-31 16:30:50] Категория 36517 -> 12044 товаров
[2025-08-31 16:30:50] Товаров в маппинге: 6342024
[2025-08-31 16:30:50] Категорий в маппинге: 478
[2025-08-31 16:30:50] Проверка признаков завершена за 0:00:00.112600
[2025-08-31 16:30:50] === ОБУЧЕНИЕ LightGBM ===
[2025-08-31 16:30:51] === ДЕБАГ ИНФОРМАЦИЯ: TRAIN ===
[2025-08-31 16:30:51] Размер: 22646731 строк
[2025-08-31 16:30:51] Колонки: ['item_id', 'user_id', 'created_timestamp', 'last_status', 'target', 'weight', 'user_count', 'user_mean', 'user_sum', 'user_max', 'user_min', 'user_orders_count', 'item_count', 'item_sum', 'item_mean', 'item_max', 'item_min', 'item_orders_count', 'copurchase_count']
[2025-08-31 16:30:51] ✅ Все признаки присутствуют
[2025-08-31 16:30:51] Целевая переменная: {1: np.int64(12562229), 0: np.int64(10084502)}
[2025-08-31 16:30:51] Пример первой строки:
[2025-08-31 16:30:51]   item_id: 184250368
[2025-08-31 16:30:51]   user_id: 3826851
[2025-08-31 16:30:51]   created_timestamp: 2025-02-15 16:43:17.746000
[2025-08-31 16:30:51]   last_status: delivered_orders
[2025-08-31 16:30:51]   target: 1
[2025-08-31 16:30:51]   weight: 15.222612188617115
[2025-08-31 16:30:51]   user_count: 406.0
[2025-08-31 16:30:51]   user_mean: 7.0276131616202955
[2025-08-31 16:30:51]   user_sum: 2853.21094361784
[2025-08-31 16:30:51]   user_max: 33.80994674344636
[2025-08-31 16:30:51]   user_min: 0.36464311358790924
[2025-08-31 16:30:51]   user_orders_count: 56.0
[2025-08-31 16:30:51]   item_count: 15.222612380981445
[2025-08-31 16:30:51]   item_sum: 7504.0
[2025-08-31 16:30:51]   item_mean: 1.0
[2025-08-31 16:30:51]   item_max: 1.0
[2025-08-31 16:30:51]   item_min: 15.222612380981445
[2025-08-31 16:30:51]   item_orders_count: 15.222612380981445
[2025-08-31 16:30:51]   copurchase_count: 0.0
[2025-08-31 16:30:51] === ДЕБАГ ИНФОРМАЦИЯ: VAL ===
[2025-08-31 16:30:51] Размер: 140544 строк
[2025-08-31 16:30:51] Колонки: ['item_id', 'user_id', 'created_timestamp', 'last_status', 'target', 'weight', 'user_count', 'user_mean', 'user_sum', 'user_max', 'user_min', 'user_orders_count', 'item_count', 'item_sum', 'item_mean', 'item_max', 'item_min', 'item_orders_count', 'copurchase_count']
[2025-08-31 16:30:51] ✅ Все признаки присутствуют
[2025-08-31 16:30:51] Целевая переменная: {1: np.int64(74838), 0: np.int64(65706)}
[2025-08-31 16:30:51] Пример первой строки:
[2025-08-31 16:30:51]   item_id: 285337782
[2025-08-31 16:30:51]   user_id: 4353551
[2025-08-31 16:30:51]   created_timestamp: 2025-05-26 14:58:06.670000
[2025-08-31 16:30:51]   last_status: canceled_orders
[2025-08-31 16:30:51]   target: 0
[2025-08-31 16:30:51]   weight: 0.9116077839697732
[2025-08-31 16:30:51]   user_count: 316
[2025-08-31 16:30:51]   user_mean: 7.338792476174323
[2025-08-31 16:30:51]   user_sum: 2319.058422471086
[2025-08-31 16:30:51]   user_max: 33.94508393511359
[2025-08-31 16:30:51]   user_min: 0.36464311358790924
[2025-08-31 16:30:51]   user_orders_count: 76
[2025-08-31 16:30:51]   item_count: 0.9116078019142151
[2025-08-31 16:30:51]   item_sum: 36741.0
[2025-08-31 16:30:51]   item_mean: 4.0
[2025-08-31 16:30:51]   item_max: 4.0
[2025-08-31 16:30:51]   item_min: 8.400938034057617
[2025-08-31 16:30:51]   item_orders_count: 16.801876068115234
[2025-08-31 16:30:51]   copurchase_count: 0.0
[2025-08-31 16:30:51] Feature columns: ['copurchase_count', 'user_count', 'user_mean', 'user_sum', 'user_max', 'user_min', 'user_orders_count', 'item_count', 'item_sum', 'item_mean', 'item_max', 'item_min', 'item_orders_count']
[2025-08-31 16:30:57] Размер train: 22646731
[2025-08-31 16:30:57] Количество пользователей в train: 825808
[2025-08-31 16:30:57] Размер val: 140544
[2025-08-31 16:30:57] Количество пользователей в val: 54902
[2025-08-31 16:43:05] [Iter 0] train_ndcg@100: 0.891763, valid_ndcg@100: 0.399184
[2025-08-31 16:43:05] ✅ [Iter 0] Новый лучший valid_ndcg@100: 0.399184
[2025-08-31 17:44:11] [Iter 5] train_ndcg@100: 0.891761, valid_ndcg@100: 0.399184
[2025-08-31 18:45:11] [Iter 10] train_ndcg@100: 0.891759, valid_ndcg@100: 0.399184
[2025-08-31 18:45:11] ⏹️ Ранняя остановка на итерации 10. Лучший NDCG@100=0.399184 (iter 0)
[2025-08-31 18:45:12] 🎯 Финальный NDCG@100 на валидации: 0.637506
[2025-08-31 18:45:12] 📈 Лучший NDCG@100: 0.399184 на итерации 0
[2025-08-31 18:45:12] Обучение LightGBM завершено за 2:14:22.145157
[2025-08-31 18:45:12] === ВАЖНОСТЬ ПРИЗНАКОВ ===
[2025-08-31 18:45:12] Топ-20 важных признаков:
[2025-08-31 18:45:12]   user_orders_count: 11
[2025-08-31 18:45:12]   item_max: 10
[2025-08-31 18:45:12]   user_sum: 8
[2025-08-31 18:45:12]   user_count: 1
[2025-08-31 18:45:12]   copurchase_count: 0
[2025-08-31 18:45:12]   user_max: 0
[2025-08-31 18:45:12]   user_mean: 0
[2025-08-31 18:45:12]   item_count: 0
[2025-08-31 18:45:12]   user_min: 0
[2025-08-31 18:45:12]   item_sum: 0
[2025-08-31 18:45:12]   item_mean: 0
[2025-08-31 18:45:12]   item_min: 0
[2025-08-31 18:45:12]   item_orders_count: 0
[2025-08-31 18:45:12] Анализ важности признаков завершен за 0:00:00.001572
[2025-08-31 18:45:12] === СОХРАНЕНИЕ МОДЕЛИ И ПРИЗНАКОВ ===
[2025-08-31 18:45:45] Сохранение модели завершено за 0:00:32.367264
[2025-08-31 18:45:45] Модель сохранена в: /home/root6/python/e_cup/rec_system/src/models/lgbm_model_full.pkl
[2025-08-31 18:45:45] === ОБУЧЕНИЕ И ПРЕДСКАЗАНИЯ ЗАВЕРШЕНЫ УСПЕШНО ===
[2025-08-31 18:45:45] Общее время выполнения: 2:20:10.146361
[2025-08-31 18:45:45] Пользователей: 960818
[2025-08-31 18:45:45] Товаров: 3972133
[2025-08-31 18:45:45] Признаков: 13
[2025-08-31 18:45:45] === СИСТЕМНАЯ ИНФОРМАЦИЯ ===
[2025-08-31 18:45:45] Видеокарта: NVIDIA GeForce RTX 4090
[2025-08-31 18:45:45] Память GPU: 24.0 GB
[2025-08-31 18:45:45] Процессор: 9.4% загрузки
[2025-08-31 18:45:45] Ядра CPU: 32
[2025-08-31 18:45:45] Частота CPU: 2995.2 MHz
[2025-08-31 18:45:45] Оперативная память: 94.2 GB всего, 82.9 GB использовано
[2025-08-31 18:45:45] ==========================================
[2025-08-31 18:45:45] ВСЕ ЭТАПЫ ВЫПОЛНЕНЫ УСПЕШНО!
[2025-08-31 18:45:45] ==========================================

=== ОБЩЕЕ ВРЕМЯ ВЫПОЛНЕНИЯ: 2:20:10.162656 ===
