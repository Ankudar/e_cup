=== НАЧАЛО ОБУЧЕНИЯ 2025-08-31 20:53:56 ===

[2025-08-31 20:53:56] === РЕЖИМ МАСШТАБИРОВАНИЯ: FULL ===
[2025-08-31 20:53:56] Пользователей: все
[2025-08-31 20:53:56] Данных: 100.0%
[2025-08-31 20:53:56] === ЗАГРУЗКА ДАННЫХ ===
[2025-08-31 20:53:56] Загружаем данные...
[2025-08-31 20:53:56] orders: найдено 5 файлов, используем 5
[2025-08-31 20:53:58] orders: ограничено 10,000 из 18,887,122 строк (семплирование 0.1%, использовано 5 файлов), ~0.5 MB
[2025-08-31 20:53:58] tracker: найдено 200 файлов, используем 200
[2025-08-31 20:56:04] tracker: ограничено 10,006 из 1,644,982,482 строк (семплирование 0.0%, использовано 200 файлов), ~0.4 MB
[2025-08-31 20:56:04] items: найдено 100 файлов, используем 100
[2025-08-31 20:56:17] items: ограничено 10,000 из 6,439,422 строк (семплирование 0.2%, использовано 100 файлов), ~1.8 MB
[2025-08-31 20:56:17] categories: найдено 1 файлов, используем 1
[2025-08-31 20:56:17] categories: 7,012 строк (использовано 1 файлов), ~1.7 MB
[2025-08-31 20:56:17] test_users: найдено 1 файлов, используем 1
[2025-08-31 20:56:17] test_users: ограничено 10,000 из 470,347 строк (семплирование 2.1%, использовано 1 файлов), ~0.1 MB
[2025-08-31 20:56:17] Данные загружены
[2025-08-31 20:56:17] Фильтрация данных...
[2025-08-31 20:56:17] Фильтрация завершена
[2025-08-31 20:56:17] Загрузка данных завершена за 0:02:20.569660
[2025-08-31 20:56:17] === SPLIT ДАННЫХ ===
[2025-08-31 20:56:18] Split данных завершен за 0:00:00.991110
[2025-08-31 20:56:18] Train orders: 7608, Test orders: 1901
[2025-08-31 20:56:18] === ПОДГОТОВКА ВЗАИМОДЕЙСТВИЙ ===
[2025-08-31 20:56:18] Формируем матрицу взаимодействий по батчам...
[2025-08-31 20:56:18] ✅ Найдено 11 существующих файлов, пропускаем создание
[2025-08-31 20:56:18] Подготовка взаимодействий завершена за 0:00:00.000267
[2025-08-31 20:56:18] Создано файлов взаимодействий: 11
[2025-08-31 20:56:18] === ПОСЛЕДНИЕ ТОВАРЫ ===
[2025-08-31 20:56:28] Словарь сохранен в /home/root6/python/e_cup/rec_system/data/processed/recent_items_map.pkl
[2025-08-31 20:56:28] Построение recent items map завершено за 0:00:09.885571
[2025-08-31 20:56:28] Пользователей с recent items: 942079
[2025-08-31 20:56:28] === ОБУЧЕНИЕ ALS ДЛЯ ПРИЗНАКОВ ===
[2025-08-31 20:56:28] Первый проход: построение маппингов...
[2025-08-31 20:56:29] Маппинги построены. Уников: users=942079, items=244212
[2025-08-31 20:56:29] item_map сохранен: /home/root6/python/e_cup/rec_system/data/processed/item_map.pkl
[2025-08-31 20:56:29] Сохранение батчей на диск...
[2025-08-31 20:56:30] Обучение als_model...
[2025-08-31 20:56:36] Очистка временных файлов...
[2025-08-31 20:56:36] Директория батчей удалена
[2025-08-31 20:56:36] Обучение завершено!
[2025-08-31 20:56:36] Считаем глобальную популярность на основе тренировочных данных...
[2025-08-31 20:56:36] Глобальная популярность рассчитана на 7607 тренировочных заказах
[2025-08-31 20:56:36] Обучение ALS завершено за 0:00:08.337160
[2025-08-31 20:56:36] Пользователей: 942079, Товаров: 244212
[2025-08-31 20:56:36] === ПОСТРОЕНИЕ ДОПОЛНИТЕЛЬНЫХ ДАННЫХ ===
[2025-08-31 20:56:36] Строим co-purchase матрицу для топ-N товаров...
[2025-08-31 20:56:36] Топ-1000 популярных товаров определены
[2025-08-31 20:56:36] Обрабатываем 1 корзин с популярными товарами
[2025-08-31 20:56:36] Уникальных популярных товаров: 1000
[2025-08-31 20:56:36] Создаем sparse матрицу из 2 взаимодействий...
[2025-08-31 20:56:36] Sparse матрица построена: torch.Size([1000, 1000]), ненулевых элементов: 2
[2025-08-31 20:56:36] Формируем рекомендации...
[2025-08-31 20:56:36] Co-purchase словарь построен для 2 товаров
[2025-08-31 20:56:36] В среднем 1.0 рекомендаций на товар
[2025-08-31 20:56:36] Co-purchase map построен: 2 товаров
[2025-08-31 20:56:42] Построение категорийных маппингов...
[2025-08-31 20:56:42] Категорийные маппинги построены: 10000 товаров, 370 категорий
[2025-08-31 20:56:42] Построение дополнительных данных завершено за 0:00:05.923103
[2025-08-31 20:56:42] === ПРЕДВАРИТЕЛЬНЫЙ РАСЧЕТ ПРИЗНАКОВ ДЛЯ LGBM ===
[2025-08-31 20:56:42] Построение словаря пользовательских признаков из ТРЕНИРОВОЧНЫХ данных...
[2025-08-31 20:56:43] Агрегация по ЗАКАЗАМ (train)...
[2025-08-31 20:56:44] Словарь пользовательских признаков построен. Записей: 942079
[2025-08-31 20:56:44] User features построены за 0:00:01.667738: 942079 пользователей
[2025-08-31 20:56:44] Построение словаря товарных признаков из ТРЕНИРОВОЧНЫХ данных...
[2025-08-31 20:56:45] Обработка ЗАКАЗОВ (train)...
[2025-08-31 20:56:45] Словарь товарных признаков построен. Записей: 244212
[2025-08-31 20:56:45] Item features: 244212 товаров, размер вектора: 6 признаков
[2025-08-31 20:56:45] Порядок признаков: ['item_orders_count', 'item_mean', 'item_count', 'item_sum', 'item_max', 'item_min']
[2025-08-31 20:56:45] item_features_dict[27262977] type=<class 'numpy.ndarray'>, shape=(6,), example=[  0.          7.1998844  78.        561.591      33.67296  ]
[2025-08-31 20:56:45] item_features_dict[298844161] type=<class 'numpy.ndarray'>, shape=(6,), example=[  0.         8.144577  13.       105.8795    32.027466]
[2025-08-31 20:56:45] item_features_dict[286261250] type=<class 'numpy.ndarray'>, shape=(6,), example=[ 1.      12.50718  1.      12.50718 12.50718]
[2025-08-31 20:56:45] item_features_dict[251658241] type=<class 'numpy.ndarray'>, shape=(6,), example=[  0.         5.724078  26.       148.82603   27.725887]
[2025-08-31 20:56:45] item_features_dict[71303174] type=<class 'numpy.ndarray'>, shape=(6,), example=[  0.          7.2560368  21.        152.37677    17.005987 ]
[2025-08-31 20:56:46] Item features построены за 0:00:01.830898
[2025-08-31 20:56:46] === ПОДГОТОВКА ДАННЫХ ДЛЯ LightGBM ===
[2025-08-31 20:56:46] Подготовка данных для LightGBM (streaming, polars lazy, батчи)...
[2025-08-31 20:56:46] Подготовка тренировочных данных...
[2025-08-31 20:56:46] Генерация признаков на тренировочных данных...
[2025-08-31 20:56:46] Построение словаря пользовательских признаков из ТРЕНИРОВОЧНЫХ данных...
[2025-08-31 20:56:46] Агрегация по ЗАКАЗАМ (train)...
[2025-08-31 20:56:47] Словарь пользовательских признаков построен. Записей: 942079
[2025-08-31 20:56:47] Построение словаря товарных признаков из ТРЕНИРОВОЧНЫХ данных...
[2025-08-31 20:56:48] Обработка ЗАКАЗОВ (train)...
[2025-08-31 20:56:48] Словарь товарных признаков построен. Записей: 244212
[2025-08-31 20:56:48] Добавление признаков к тренировочным данным...
[2025-08-31 20:56:50] Подготовка тестовых данных...
[2025-08-31 20:56:50] Сохранение результатов...
[2025-08-31 20:56:51] ✅ Данные подготовлены без утечек памяти
[2025-08-31 20:56:51] Размер train: 8284, validation: 2088
[2025-08-31 20:56:51] Признаки: 12
[2025-08-31 20:56:51] Подготовка данных для LightGBM завершена за 0:00:05.010469
[2025-08-31 20:56:51] === ДЕТАЛЬНАЯ ПРОВЕРКА FEATURE GENERATION ===
[2025-08-31 20:56:51] --- ПРОВЕРКА USER FEATURES ---
[2025-08-31 20:56:51] Пример user features для пользователя 4349631:
[2025-08-31 20:56:51]   user_count: 20
[2025-08-31 20:56:51]   user_mean: 4.106824833536585
[2025-08-31 20:56:51]   user_sum: 82.1364966707317
[2025-08-31 20:56:51]   user_max: 14.350845252893228
[2025-08-31 20:56:51]   user_min: 0.36464311358790924
[2025-08-31 20:56:51]   user_orders_count: 0
[2025-08-31 20:56:51] Пользователей с features: 942079
[2025-08-31 20:56:51] Пользователей с НЕнулевыми features: 942079
[2025-08-31 20:56:51] --- ПРОВЕРКА ITEM FEATURES ---
[2025-08-31 20:56:51] Товаров с features: 244212
[2025-08-31 20:56:51] --- ПРОВЕРКА CO-PURCHASE MAP ---
[2025-08-31 20:56:51] Пример co-purchase для товара 77721124: 1 товаров
[2025-08-31 20:56:51] Co-purchase записей: 2
[2025-08-31 20:56:51] --- ПРОВЕРКА КАТЕГОРИЙНЫХ МАППИНГОВ ---
[2025-08-31 20:56:51] Товар 313302306 -> категория 7646
[2025-08-31 20:56:51] Категория 7646 -> 50 товаров
[2025-08-31 20:56:51] Товаров в маппинге: 10000
[2025-08-31 20:56:51] Категорий в маппинге: 370
[2025-08-31 20:56:51] Проверка признаков завершена за 0:00:00.125962
[2025-08-31 20:56:51] === ОБУЧЕНИЕ LightGBM ===
[2025-08-31 20:56:51] === ДЕБАГ ИНФОРМАЦИЯ: TRAIN ===
[2025-08-31 20:56:51] Размер: 8284 строк
[2025-08-31 20:56:51] Колонки: ['item_id', 'user_id', 'created_timestamp', 'last_status', 'target', 'timestamp', 'weight', 'user_count', 'user_mean', 'user_sum', 'user_max', 'user_min', 'user_orders_count', 'item_count', 'item_mean', 'item_sum', 'item_max', 'item_min', 'item_orders_count']
[2025-08-31 20:56:51] ✅ Все признаки присутствуют
[2025-08-31 20:56:51] Целевая переменная: {1: np.int64(4628), 0: np.int64(3656)}
[2025-08-31 20:56:51] Пример первой строки:
[2025-08-31 20:56:51]   item_id: 155223309
[2025-08-31 20:56:51]   user_id: 2577591
[2025-08-31 20:56:51]   created_timestamp: 2025-02-18 19:33:53.176000
[2025-08-31 20:56:51]   last_status: delivered_orders
[2025-08-31 20:56:51]   target: 1
[2025-08-31 20:56:51]   timestamp: 2025-02-18 19:33:53.176000
[2025-08-31 20:56:51]   weight: 15.077674504250853
[2025-08-31 20:56:51]   user_count: 361.0
[2025-08-31 20:56:51]   user_mean: 6.897191067074837
[2025-08-31 20:56:51]   user_sum: 2489.885975214016
[2025-08-31 20:56:51]   user_max: 31.179499062782405
[2025-08-31 20:56:51]   user_min: 0.36464311358790924
[2025-08-31 20:56:51]   user_orders_count: 1.0
[2025-08-31 20:56:51]   item_count: 1.0
[2025-08-31 20:56:51]   item_mean: 15.077674504250853
[2025-08-31 20:56:51]   item_sum: 15.077674504250853
[2025-08-31 20:56:51]   item_max: 15.077674504250853
[2025-08-31 20:56:51]   item_min: 15.077674504250853
[2025-08-31 20:56:51]   item_orders_count: 1.0
[2025-08-31 20:56:51] === ДЕБАГ ИНФОРМАЦИЯ: VAL ===
[2025-08-31 20:56:51] Размер: 2088 строк
[2025-08-31 20:56:51] Колонки: ['item_id', 'user_id', 'created_timestamp', 'last_status', 'target', 'timestamp', 'weight', 'user_count', 'user_mean', 'user_sum', 'user_max', 'user_min', 'user_orders_count', 'item_count', 'item_mean', 'item_sum', 'item_max', 'item_min', 'item_orders_count']
[2025-08-31 20:56:51] ✅ Все признаки присутствуют
[2025-08-31 20:56:51] Целевая переменная: {1: np.int64(1207), 0: np.int64(881)}
[2025-08-31 20:56:51] Пример первой строки:
[2025-08-31 20:56:51]   item_id: 156261528
[2025-08-31 20:56:51]   user_id: 2643091
[2025-08-31 20:56:51]   created_timestamp: 2025-01-27 07:36:54.130000
[2025-08-31 20:56:51]   last_status: delivered_orders
[2025-08-31 20:56:51]   target: 1
[2025-08-31 20:56:51]   timestamp: 2025-02-02 11:13:39
[2025-08-31 20:56:51]   weight: 6.339371161354858
[2025-08-31 20:56:51]   user_count: 28.0
[2025-08-31 20:56:51]   user_mean: 8.991616215760926
[2025-08-31 20:56:51]   user_sum: 251.76525404130592
[2025-08-31 20:56:51]   user_max: 32.18875824868201
[2025-08-31 20:56:51]   user_min: 0.36464311358790924
[2025-08-31 20:56:51]   user_orders_count: 1.0
[2025-08-31 20:56:51]   item_count: 67.0
[2025-08-31 20:56:51]   item_mean: 9.370847888612552
[2025-08-31 20:56:51]   item_sum: 627.8468085370409
[2025-08-31 20:56:51]   item_max: 33.94508393511359
[2025-08-31 20:56:51]   item_min: 4.564764771353053
[2025-08-31 20:56:51]   item_orders_count: 1.0
[2025-08-31 20:56:51] Feature columns: ['user_count', 'user_mean', 'user_sum', 'user_max', 'user_min', 'user_orders_count', 'item_count', 'item_mean', 'item_sum', 'item_max', 'item_min', 'item_orders_count']
[2025-08-31 20:56:51] Размер train: 8284
[2025-08-31 20:56:51] Количество пользователей в train: 5975
[2025-08-31 20:56:51] Размер val: 2088
[2025-08-31 20:56:51] Количество пользователей в val: 1507
[2025-08-31 20:56:51] [Iter 0] train_ndcg@100: 0.037657, valid_ndcg@100: 0.031188
[2025-08-31 20:56:51] ✅ [Iter 0] Новый лучший valid_ndcg@100: 0.031188
[2025-08-31 20:56:53] [Iter 5] train_ndcg@100: 0.037657, valid_ndcg@100: 0.031188
[2025-08-31 20:56:55] [Iter 10] train_ndcg@100: 0.037657, valid_ndcg@100: 0.031188
[2025-08-31 20:56:55] ⏹️ Ранняя остановка на итерации 10. Лучший NDCG@100=0.031188 (iter 0)
[2025-08-31 20:56:55] 🎯 Финальный NDCG@100 на валидации: 0.608306
[2025-08-31 20:56:55] 📈 Лучший NDCG@100: 0.031188 на итерации 0
[2025-08-31 20:56:55] Обучение LightGBM завершено за 0:00:03.999190
[2025-08-31 20:56:55] === ВАЖНОСТЬ ПРИЗНАКОВ ===
[2025-08-31 20:56:55] Топ-20 важных признаков:
[2025-08-31 20:56:55]   user_count: 3
[2025-08-31 20:56:55]   user_sum: 2
[2025-08-31 20:56:55]   item_sum: 2
[2025-08-31 20:56:55]   item_mean: 2
[2025-08-31 20:56:55]   user_max: 1
[2025-08-31 20:56:55]   user_mean: 0
[2025-08-31 20:56:55]   user_orders_count: 0
[2025-08-31 20:56:55]   user_min: 0
[2025-08-31 20:56:55]   item_count: 0
[2025-08-31 20:56:55]   item_max: 0
[2025-08-31 20:56:55]   item_min: 0
[2025-08-31 20:56:55]   item_orders_count: 0
[2025-08-31 20:56:55] Анализ важности признаков завершен за 0:00:00.001513
[2025-08-31 20:56:55] === СОХРАНЕНИЕ МОДЕЛИ И ПРИЗНАКОВ ===
[2025-08-31 20:56:57] Сохранение модели завершено за 0:00:01.817894
[2025-08-31 20:56:57] Модель сохранена в: /home/root6/python/e_cup/rec_system/src/models/lgbm_model_full.pkl
[2025-08-31 20:56:57] === ОБУЧЕНИЕ И ПРЕДСКАЗАНИЯ ЗАВЕРШЕНЫ УСПЕШНО ===
[2025-08-31 20:56:57] Общее время выполнения: 0:03:00.162346
[2025-08-31 20:56:57] Пользователей: 942079
[2025-08-31 20:56:57] Товаров: 244212
[2025-08-31 20:56:57] Признаков: 12
[2025-08-31 20:56:57] === СИСТЕМНАЯ ИНФОРМАЦИЯ ===
[2025-08-31 20:56:57] Видеокарта: NVIDIA GeForce RTX 4090
[2025-08-31 20:56:57] Память GPU: 24.0 GB
[2025-08-31 20:56:57] Процессор: 28.7% загрузки
[2025-08-31 20:56:57] Ядра CPU: 32
[2025-08-31 20:56:57] Частота CPU: 2995.2 MHz
[2025-08-31 20:56:57] Оперативная память: 94.2 GB всего, 76.5 GB использовано
[2025-08-31 20:56:57] ==========================================
[2025-08-31 20:56:57] ВСЕ ЭТАПЫ ВЫПОЛНЕНЫ УСПЕШНО!
[2025-08-31 20:56:57] ==========================================

=== ОБЩЕЕ ВРЕМЯ ВЫПОЛНЕНИЯ: 0:03:00.163311 ===
