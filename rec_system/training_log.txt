=== НАЧАЛО ОБУЧЕНИЯ 2025-08-28 10:01:07 ===

[2025-08-28 10:01:07] === РЕЖИМ МАСШТАБИРОВАНИЯ: FULL ===
[2025-08-28 10:01:07] Пользователей: все
[2025-08-28 10:01:07] Данных: 100.0%
[2025-08-28 10:01:07] === ЗАГРУЗКА ДАННЫХ ===
[2025-08-28 10:01:07] Загружаем данные...
[2025-08-28 10:01:08] orders: 1,000 строк (использовано 5 из 5 партиций), ~0.0 MB
[2025-08-28 10:01:08] tracker: 1,000 строк (использовано 200 из 200 партиций), ~0.0 MB
[2025-08-28 10:01:11] items: 1,000 строк (использовано 200 из 200 партиций), ~0.2 MB
[2025-08-28 10:01:11] categories: 1,000 строк (использовано 1 из 1 партиций), ~0.2 MB
[2025-08-28 10:01:11] test_users: 1,000 строк (использовано 1 из 1 партиций), ~0.0 MB
[2025-08-28 10:01:11] Данные загружены
[2025-08-28 10:01:11] Фильтрация данных...
[2025-08-28 10:01:11] Фильтрация завершена
[2025-08-28 10:01:11] Загрузка данных завершена за 0:00:03.783572
[2025-08-28 10:01:11] === ЗАГРУЗКА ЭМБЕДДИНГОВ ===
[2025-08-28 10:01:11] Оптимизированная потоковая загрузка эмбеддингов...
[2025-08-28 10:01:12] Загружено эмбеддингов для 990 товаров
[2025-08-28 10:01:12] Пример ключей в embeddings_dict: [400301, 678602, 746401, 872829, 893255]
[2025-08-28 10:01:12] Пример значения: [ 0.32023853  0.11766258 -0.784552    0.4168199  -0.24610527]
[2025-08-28 10:01:12] Загрузка эмбеддингов завершена за 0:00:00.716276
[2025-08-28 10:01:12] Загружено эмбеддингов: 990
[2025-08-28 10:01:12] === SPLIT ДАННЫХ ===
[2025-08-28 10:01:12] Split данных завершен за 0:00:00.281296
[2025-08-28 10:01:12] Train orders: 753, Test orders: 187
[2025-08-28 10:01:12] === ПОДГОТОВКА ВЗАИМОДЕЙСТВИЙ ===
[2025-08-28 10:01:12] Формируем матрицу взаимодействий по батчам...
[2025-08-28 10:01:12] ... для orders
[2025-08-28 10:01:12] Сохранен orders-батч 0-753
[2025-08-28 10:01:12] ... для tracker
[2025-08-28 10:01:13] Сохранен tracker-партиция 0
[2025-08-28 10:01:13] Все батчи сохранены на диск.
[2025-08-28 10:01:13] Подготовка взаимодействий завершена за 0:00:00.815768
[2025-08-28 10:01:13] Создано файлов взаимодействий: 2
[2025-08-28 10:01:13] === ПОСЛЕДНИЕ ТОВАРЫ ===
[2025-08-28 10:01:13] Словарь сохранен в /home/root6/python/e_cup/rec_system/data/processed/recent_items_map.pkl
[2025-08-28 10:01:13] Построение recent items map завершено за 0:00:00.023517
[2025-08-28 10:01:13] Пользователей с recent items: 1195
[2025-08-28 10:01:13] === ОБУЧЕНИЕ ALS ДЛЯ ПРИЗНАКОВ ===
[2025-08-28 10:01:13] Первый проход: построение маппингов...
[2025-08-28 10:01:13] Маппинги построены. Уников: users=1195, items=207
[2025-08-28 10:01:13] item_map сохранен: /home/root6/python/e_cup/rec_system/data/processed/item_map.pkl
[2025-08-28 10:01:13] Сохранение батчей на диск...
[2025-08-28 10:01:13] Постепенное обучение...
[2025-08-28 10:01:14] Очистка временных файлов...
[2025-08-28 10:01:14] Директория батчей удалена
[2025-08-28 10:01:14] Обучение завершено!
[2025-08-28 10:01:14] Считаем глобальную популярность на основе тренировочных данных...
[2025-08-28 10:01:14] Глобальная популярность рассчитана на 752 тренировочных заказах
[2025-08-28 10:01:14] Обучение ALS завершено за 0:00:00.841536
[2025-08-28 10:01:14] Пользователей: 1195, Товаров: 207
[2025-08-28 10:01:14] === ПОСТРОЕНИЕ ДОПОЛНИТЕЛЬНЫХ ДАННЫХ ===
[2025-08-28 10:01:14] Строим co-purchase матрицу для топ-N товаров...
[2025-08-28 10:01:14] Топ-207 популярных товаров определены
[2025-08-28 10:01:14] Обрабатываем 3 корзин с популярными товарами
[2025-08-28 10:01:14] Уникальных популярных товаров: 207
[2025-08-28 10:01:14] Создаем sparse матрицу из 6 взаимодействий...
[2025-08-28 10:01:14] Sparse матрица построена: torch.Size([207, 207]), ненулевых элементов: 3
[2025-08-28 10:01:14] Формируем рекомендации...
[2025-08-28 10:01:14] Co-purchase словарь построен для 3 товаров
[2025-08-28 10:01:14] В среднем 1.0 рекомендаций на товар
[2025-08-28 10:01:14] Co-purchase map построен: 3 товаров
[2025-08-28 10:01:14] Построение категорийных маппингов...
[2025-08-28 10:01:14] Категорийные маппинги построены: 990 товаров, 223 категорий
[2025-08-28 10:01:14] Построение дополнительных данных завершено за 0:00:00.264377
[2025-08-28 10:01:14] === ПРЕДВАРИТЕЛЬНЫЙ РАСЧЕТ ПРИЗНАКОВ ДЛЯ LGBM ===
[2025-08-28 10:01:14] Построение словаря пользовательских признаков...
[2025-08-28 10:01:14] Агрегация по заказам...
[2025-08-28 10:01:14] Словарь пользовательских признаков построен и сохранён в /home/root6/python/e_cup/rec_system/data/processed/cat_to_items.pkl. Записей: 1196
[2025-08-28 10:01:14] User features построены за 0:00:00.293045: 1196 пользователей
[2025-08-28 10:01:14] Построение словаря товарных признаков...
[2025-08-28 10:01:15] Добавление данных из items_df...
[2025-08-28 10:01:15] Добавление эмбеддингов...
[2025-08-28 10:01:15] Словарь товарных признаков построен. Записей: 208
[2025-08-28 10:01:15] Item features: 208 товаров, размер вектора: 7 признаков
[2025-08-28 10:01:15] Порядок признаков: ['item_count', 'item_mean', 'item_sum', 'item_max', 'item_min', 'item_orders_count', 'item_category']
[2025-08-28 10:01:15] item_features_dict[3684119] type=<class 'numpy.ndarray'>, shape=(7,), example=[1.       8.113416 8.113416 8.113416 8.113416]
[2025-08-28 10:01:15] item_features_dict[2622802] type=<class 'numpy.ndarray'>, shape=(7,), example=[ 3.         5.0619783 15.185935   8.401035   1.1819439]
[2025-08-28 10:01:15] item_features_dict[5205316] type=<class 'numpy.ndarray'>, shape=(7,), example=[1.       7.946176 7.946176 7.946176 7.946176]
[2025-08-28 10:01:15] item_features_dict[6072528] type=<class 'numpy.ndarray'>, shape=(7,), example=[2.        4.181814  8.363628  7.7378125 0.6258157]
[2025-08-28 10:01:15] item_features_dict[669551] type=<class 'numpy.ndarray'>, shape=(7,), example=[1.       4.581454 4.581454 4.581454 4.581454]
[2025-08-28 10:01:15] Item features построены за 0:00:00.305137
[2025-08-28 10:01:15] === ПОДГОТОВКА ДАННЫХ ДЛЯ LightGBM ===
[2025-08-28 10:01:15] Подготовка данных для LightGBM (streaming, polars lazy, векторно)...
[2025-08-28 10:01:17] ✅ Данные подготовлены (streaming lazy polars, векторно)
[2025-08-28 10:01:17] Размер train: 2260, validation: 204
[2025-08-28 10:01:17] Признаки: 14
[2025-08-28 10:01:17] Подготовка данных для LightGBM завершена за 0:00:01.826061
[2025-08-28 10:01:17] === ДЕТАЛЬНАЯ ПРОВЕРКА FEATURE GENERATION ===
[2025-08-28 10:01:17] --- ПРОВЕРКА USER FEATURES ---
[2025-08-28 10:01:17] Пример user features для пользователя 3499190:
[2025-08-28 10:01:17]   user_count: 1
[2025-08-28 10:01:17]   user_mean: 1.8590719172483514
[2025-08-28 10:01:17]   user_sum: 1.8590719172483514
[2025-08-28 10:01:17]   user_max: 1.8590719172483514
[2025-08-28 10:01:17]   user_min: 1.8590719172483514
[2025-08-28 10:01:17]   user_orders_count: 0
[2025-08-28 10:01:17] Пользователей с features: 1196
[2025-08-28 10:01:17] Пользователей с НЕнулевыми features: 1196
[2025-08-28 10:01:17] --- ПРОВЕРКА ITEM FEATURES ---
[2025-08-28 10:01:17] Пример item features для товара 3684119:
[2025-08-28 10:01:17]   emb_0: 1.0
[2025-08-28 10:01:17]   emb_1: 8.113415718078613
[2025-08-28 10:01:17]   emb_2: 8.113415718078613
[2025-08-28 10:01:17]   emb_3: 8.113415718078613
[2025-08-28 10:01:17]   emb_4: 8.113415718078613
[2025-08-28 10:01:17]   emb_5: 1.0
[2025-08-28 10:01:17]   emb_6: 0.0
[2025-08-28 10:01:17] Товаров с features: 208
[2025-08-28 10:01:17] Товаров с НЕнулевыми features: 208
[2025-08-28 10:01:17] --- ПРОВЕРКА ЭМБЕДДИНГОВ ---
[2025-08-28 10:01:17] Пример эмбеддинга для товара 400301: shape (512,)
[2025-08-28 10:01:17] Эмбеддингов загружено: 990
[2025-08-28 10:01:17] Пример значений: [ 0.32023853  0.11766258 -0.784552    0.4168199  -0.24610527]
[2025-08-28 10:01:17] --- ПРОВЕРКА CO-PURCHASE MAP ---
[2025-08-28 10:01:17] Пример co-purchase для товара 10126067: 1 товаров
[2025-08-28 10:01:17] Co-purchase записей: 3
[2025-08-28 10:01:17] --- ПРОВЕРКА КАТЕГОРИЙНЫХ МАППИНГОВ ---
[2025-08-28 10:01:17] Товар 400301 -> категория 17080
[2025-08-28 10:01:17] Категория 17080 -> 4 товаров
[2025-08-28 10:01:17] Товаров в маппинге: 990
[2025-08-28 10:01:17] Категорий в маппинге: 223
[2025-08-28 10:01:17] Проверка признаков завершена за 0:00:00.001576
[2025-08-28 10:01:17] === ОБУЧЕНИЕ LightGBM ===
[2025-08-28 10:01:18] === ДЕБАГ ИНФОРМАЦИЯ: TRAIN ===
[2025-08-28 10:01:18] Размер: 2260 строк
[2025-08-28 10:01:18] Колонки: ['item_id', 'user_id', 'created_timestamp', 'last_status', 'target', 'weight', 'user_count', 'user_mean', 'user_sum', 'user_max', 'user_min', 'user_orders_count', 'emb_0', 'emb_1', 'emb_2', 'emb_3', 'emb_4', 'emb_5', 'emb_6', 'copurchase_count']
[2025-08-28 10:01:18] ✅ Все признаки присутствуют
[2025-08-28 10:01:18] Целевая переменная: {0: np.int64(1831), 1: np.int64(429)}
[2025-08-28 10:01:18] Пример первой строки:
[2025-08-28 10:01:18]   item_id: 3578885
[2025-08-28 10:01:18]   user_id: 455530
[2025-08-28 10:01:18]   created_timestamp: 2025-01-19 01:05:45.010000
[2025-08-28 10:01:18]   last_status: delivered_orders
[2025-08-28 10:01:18]   target: 1
[2025-08-28 10:01:18]   weight: 8.369882167858357
[2025-08-28 10:01:18]   user_count: 1.0
[2025-08-28 10:01:18]   user_mean: 8.369882167858357
[2025-08-28 10:01:18]   user_sum: 8.369882167858357
[2025-08-28 10:01:18]   user_max: 8.369882167858357
[2025-08-28 10:01:18]   user_min: 8.369882167858357
[2025-08-28 10:01:18]   user_orders_count: 1.0
[2025-08-28 10:01:18]   emb_0: 19.0
[2025-08-28 10:01:18]   emb_1: 5.3321757316589355
[2025-08-28 10:01:18]   emb_2: 101.31134033203125
[2025-08-28 10:01:18]   emb_3: 8.84643268585205
[2025-08-28 10:01:18]   emb_4: 0.3226926028728485
[2025-08-28 10:01:18]   emb_5: 22.0
[2025-08-28 10:01:18]   emb_6: 0.0
[2025-08-28 10:01:18]   copurchase_count: 0.0
[2025-08-28 10:01:18] === ДЕБАГ ИНФОРМАЦИЯ: VAL ===
[2025-08-28 10:01:18] Размер: 204 строк
[2025-08-28 10:01:18] Колонки: ['item_id', 'user_id', 'created_timestamp', 'last_status', 'target', 'weight', 'user_count', 'user_mean', 'user_sum', 'user_max', 'user_min', 'user_orders_count', 'emb_0', 'emb_1', 'emb_2', 'emb_3', 'emb_4', 'emb_5', 'emb_6', 'copurchase_count']
[2025-08-28 10:01:18] ✅ Все признаки присутствуют
[2025-08-28 10:01:18] Целевая переменная: {0: np.int64(111), 1: np.int64(93)}
[2025-08-28 10:01:18] Пример первой строки:
[2025-08-28 10:01:18]   item_id: 7043871
[2025-08-28 10:01:18]   user_id: 2665240
[2025-08-28 10:01:18]   created_timestamp: 2025-05-06 23:50:57.130000
[2025-08-28 10:01:18]   last_status: canceled_orders
[2025-08-28 10:01:18]   target: 0
[2025-08-28 10:01:18]   weight: 2.75023168459636
[2025-08-28 10:01:18]   user_count: 1
[2025-08-28 10:01:18]   user_mean: 2.75023168459636
[2025-08-28 10:01:18]   user_sum: 2.75023168459636
[2025-08-28 10:01:18]   user_max: 2.75023168459636
[2025-08-28 10:01:18]   user_min: 2.75023168459636
[2025-08-28 10:01:18]   user_orders_count: 1
[2025-08-28 10:01:18]   emb_0: 1.0
[2025-08-28 10:01:18]   emb_1: 2.7502317428588867
[2025-08-28 10:01:18]   emb_2: 2.7502317428588867
[2025-08-28 10:01:18]   emb_3: 2.7502317428588867
[2025-08-28 10:01:18]   emb_4: 2.7502317428588867
[2025-08-28 10:01:18]   emb_5: 2.0
[2025-08-28 10:01:18]   emb_6: 0.0
[2025-08-28 10:01:18]   copurchase_count: 0.0
[2025-08-28 10:01:18] Feature columns: ['copurchase_count', 'user_count', 'user_mean', 'user_sum', 'user_max', 'user_min', 'user_orders_count', 'emb_0', 'emb_1', 'emb_2', 'emb_3', 'emb_4', 'emb_5', 'emb_6']
[2025-08-28 10:01:18] Размер train: 2260
[2025-08-28 10:01:18] Используемые признаки: ['copurchase_count', 'user_count', 'user_mean', 'user_sum', 'user_max', 'user_min', 'user_orders_count', 'emb_0', 'emb_1', 'emb_2', 'emb_3', 'emb_4', 'emb_5', 'emb_6']
[2025-08-28 10:01:18] Пример данных: {'copurchase_count': 0.0, 'user_count': 1.0, 'user_mean': 8.369882167858357, 'user_sum': 8.369882167858357, 'user_max': 8.369882167858357, 'user_min': 8.369882167858357, 'user_orders_count': 1.0, 'emb_0': 19.0, 'emb_1': 5.3321757316589355, 'emb_2': 101.31134033203125, 'emb_3': 8.84643268585205, 'emb_4': 0.3226926028728485, 'emb_5': 22.0, 'emb_6': 0.0}
[2025-08-28 10:01:18] Категориальные признаки: ['user_count', 'user_mean', 'user_sum', 'user_max', 'user_min', 'user_orders_count']
[2025-08-28 10:01:18] Размер val: 204
[2025-08-28 10:01:18] [Iter 0] train_binary_logloss:0.4824, valid_binary_logloss:0.8691
[2025-08-28 10:01:18] [Iter 10] train_binary_logloss:0.4526, valid_binary_logloss:0.8605
[2025-08-28 10:01:18] [Iter 20] train_binary_logloss:0.4319, valid_binary_logloss:0.8641
[2025-08-28 10:01:18] [Iter 30] train_binary_logloss:0.4159, valid_binary_logloss:0.8717
[2025-08-28 10:01:18] [Iter 40] train_binary_logloss:0.4030, valid_binary_logloss:0.8833
[2025-08-28 10:01:18] [Iter 50] train_binary_logloss:0.3914, valid_binary_logloss:0.9018
[2025-08-28 10:01:18] [Iter 60] train_binary_logloss:0.3811, valid_binary_logloss:0.9189
[2025-08-28 10:01:18] NDCG@100 на валидации: 0.4762
[2025-08-28 10:01:18] Обучение LightGBM завершено за 0:00:01.313720
[2025-08-28 10:01:18] === ОЦЕНКА МОДЕЛИ ===
[2025-08-28 10:01:18] NDCG@100 train: 0.4026
[2025-08-28 10:01:18] NDCG@100 val: 0.4762
[2025-08-28 10:01:18] Оценка модели завершена за 0:00:00.039661
[2025-08-28 10:01:18] === ВАЖНОСТЬ ПРИЗНАКОВ ===
[2025-08-28 10:01:18] Топ-20 важных признаков:
[2025-08-28 10:01:18]   emb_1: 100
[2025-08-28 10:01:18]   emb_2: 99
[2025-08-28 10:01:18]   emb_3: 62
[2025-08-28 10:01:18]   emb_5: 44
[2025-08-28 10:01:18]   emb_4: 31
[2025-08-28 10:01:18]   user_orders_count: 24
[2025-08-28 10:01:18]   emb_0: 17
[2025-08-28 10:01:18]   emb_6: 4
[2025-08-28 10:01:18]   user_min: 3
[2025-08-28 10:01:18]   user_count: 2
[2025-08-28 10:01:18]   user_mean: 2
[2025-08-28 10:01:18]   user_max: 2
[2025-08-28 10:01:18]   user_sum: 2
[2025-08-28 10:01:18]   copurchase_count: 0
[2025-08-28 10:01:18] Анализ важности признаков завершен за 0:00:00.001364
[2025-08-28 10:01:18] === СОХРАНЕНИЕ МОДЕЛИ И ПРИЗНАКОВ ===
[2025-08-28 10:01:18] Сохранение модели завершено за 0:00:00.005612
[2025-08-28 10:01:18] Модель сохранена в: /home/root6/python/e_cup/rec_system/src/models/lgbm_model_full.pkl
[2025-08-28 10:01:18] === ОБУЧЕНИЕ И ПРЕДСКАЗАНИЯ ЗАВЕРШЕНЫ УСПЕШНО ===
[2025-08-28 10:01:18] Общее время выполнения: 0:00:10.513618
[2025-08-28 10:01:18] Пользователей: 1195
[2025-08-28 10:01:18] Товаров: 207
[2025-08-28 10:01:18] Признаков: 14
[2025-08-28 10:01:18] NDCG@100 train: 0.4026
[2025-08-28 10:01:18] NDCG@100 val: 0.4762
[2025-08-28 10:01:18] === СИСТЕМНАЯ ИНФОРМАЦИЯ ===
[2025-08-28 10:01:18] Видеокарта: NVIDIA GeForce RTX 4090
[2025-08-28 10:01:18] Память GPU: 24.0 GB
[2025-08-28 10:01:18] Процессор: 13.2% загрузки
[2025-08-28 10:01:18] Ядра CPU: 32
[2025-08-28 10:01:18] Частота CPU: 2995.2 MHz
[2025-08-28 10:01:18] Оперативная память: 94.2 GB всего, 6.8 GB использовано
[2025-08-28 10:01:18] Частота RAM: информация требует дополнительных библиотек
[2025-08-28 10:01:18] ==========================================
[2025-08-28 10:01:18] ВСЕ ЭТАПЫ ВЫПОЛНЕНЫ УСПЕШНО!
[2025-08-28 10:01:18] ==========================================

=== ОБЩЕЕ ВРЕМЯ ВЫПОЛНЕНИЯ: 0:00:10.514862 ===
