=== НАЧАЛО ОБУЧЕНИЯ 2025-08-27 09:40:05 ===

[2025-08-27 09:40:05] === РЕЖИМ МАСШТАБИРОВАНИЯ: FULL ===
[2025-08-27 09:40:05] Пользователей: все
[2025-08-27 09:40:05] Данных: 100.0%
[2025-08-27 09:40:05] === ЗАГРУЗКА ДАННЫХ ===
[2025-08-27 09:40:05] Загружаем данные...
[2025-08-27 09:40:05] orders: 1,000 строк (использовано 28 из 28 партиций), ~0.0 MB
[2025-08-27 09:40:06] tracker: 1,000 строк (использовано 298 из 298 партиций), ~0.0 MB
[2025-08-27 09:40:07] items: 1,000 строк (использовано 200 из 200 партиций), ~0.2 MB
[2025-08-27 09:40:07] categories: 1,000 строк (использовано 1 из 1 партиций), ~0.2 MB
[2025-08-27 09:40:07] test_users: 1,000 строк (использовано 1 из 1 партиций), ~0.0 MB
[2025-08-27 09:40:07] Данные загружены
[2025-08-27 09:40:07] Фильтрация данных...
[2025-08-27 09:40:07] Фильтрация завершена
[2025-08-27 09:40:07] Загрузка данных завершена за 0:00:01.867411
[2025-08-27 09:40:07] === ЗАГРУЗКА ЭМБЕДДИНГОВ ===
[2025-08-27 09:40:07] Оптимизированная потоковая загрузка эмбеддингов...
[2025-08-27 09:40:07] Загружено эмбеддингов для 990 товаров
[2025-08-27 09:40:07] Загрузка эмбеддингов завершена за 0:00:00.716553
[2025-08-27 09:40:07] Загружено эмбеддингов: 990
[2025-08-27 09:40:07] === SPLIT ДАННЫХ ===
[2025-08-27 09:40:07] Split данных завершен за 0:00:00.017704
[2025-08-27 09:40:07] Train orders: 684, Test orders: 170
[2025-08-27 09:40:07] === ПОДГОТОВКА ВЗАИМОДЕЙСТВИЙ ===
[2025-08-27 09:40:07] Формируем матрицу взаимодействий по батчам...
[2025-08-27 09:40:07] ... для orders
[2025-08-27 09:40:07] Сохранен orders-батч 0-684
[2025-08-27 09:40:07] ... для tracker
[2025-08-27 09:40:08] Сохранен tracker-партиция 0
[2025-08-27 09:40:08] Все батчи сохранены на диск.
[2025-08-27 09:40:08] Подготовка взаимодействий завершена за 0:00:00.803115
[2025-08-27 09:40:08] Создано файлов взаимодействий: 2
[2025-08-27 09:40:08] === ПОСЛЕДНИЕ ТОВАРЫ ===
[2025-08-27 09:40:08] Словарь сохранен в /home/root6/python/e_cup/rec_system/data/processed/recent_items_map.pkl
[2025-08-27 09:40:08] Построение recent items map завершено за 0:00:00.027318
[2025-08-27 09:40:08] Пользователей с recent items: 1183
[2025-08-27 09:40:08] === ОБУЧЕНИЕ ALS ДЛЯ ПРИЗНАКОВ ===
[2025-08-27 09:40:08] Первый проход: построение маппингов...
[2025-08-27 09:40:08] Маппинги построены. Уников: users=1183, items=606
[2025-08-27 09:40:08] item_map сохранен: /home/root6/python/e_cup/rec_system/data/processed/item_map.pkl
[2025-08-27 09:40:08] Сохранение батчей на диск...
[2025-08-27 09:40:08] Постепенное обучение...
[2025-08-27 09:40:09] Очистка временных файлов...
[2025-08-27 09:40:09] Директория батчей удалена
[2025-08-27 09:40:09] Обучение завершено!
[2025-08-27 09:40:09] Считаем глобальную популярность на основе тренировочных данных...
[2025-08-27 09:40:09] Глобальная популярность рассчитана на 683 тренировочных заказах
[2025-08-27 09:40:09] Обучение ALS завершено за 0:00:00.821883
[2025-08-27 09:40:09] Пользователей: 1183, Товаров: 606
[2025-08-27 09:40:09] === ПОСТРОЕНИЕ ДОПОЛНИТЕЛЬНЫХ ДАННЫХ ===
[2025-08-27 09:40:09] Строим co-purchase матрицу для топ-N товаров...
[2025-08-27 09:40:09] Топ-603 популярных товаров определены
[2025-08-27 09:40:09] Обрабатываем 2 корзин с популярными товарами
[2025-08-27 09:40:09] Уникальных популярных товаров: 603
[2025-08-27 09:40:09] Создаем sparse матрицу из 4 взаимодействий...
[2025-08-27 09:40:09] Sparse матрица построена: torch.Size([603, 603]), ненулевых элементов: 4
[2025-08-27 09:40:09] Формируем рекомендации...
[2025-08-27 09:40:09] Co-purchase словарь построен для 4 товаров
[2025-08-27 09:40:09] В среднем 1.0 рекомендаций на товар
[2025-08-27 09:40:09] Co-purchase словарь сохранен в /home/root6/python/e_cup/rec_system/data/processed/copurchase_map.pkl
[2025-08-27 09:40:09] Co-purchase map построен: 4 товаров
[2025-08-27 09:40:09] Построение категорийных маппингов...
[2025-08-27 09:40:09] Сохранено: item_to_cat.pkl и extended_cat_to_items.pkl в /home/root6/python/e_cup/rec_system/data/processed/
[2025-08-27 09:40:09] Категорийные маппинги построены: 990 товаров, 223 категорий
[2025-08-27 09:40:09] Построение дополнительных данных завершено за 0:00:00.339132
[2025-08-27 09:40:09] === ПРЕДВАРИТЕЛЬНЫЙ РАСЧЕТ ПРИЗНАКОВ ДЛЯ LGBM ===
[2025-08-27 09:40:09] Построение словаря пользовательских признаков...
[2025-08-27 09:40:09] Агрегация по заказам...
[2025-08-27 09:40:09] Словарь пользовательских признаков построен и сохранён в /home/root6/python/e_cup/rec_system/data/processed/user_features_dict.pkl. Записей: 1184
[2025-08-27 09:40:09] User features построены за 0:00:00.052023: 1184 пользователей
[2025-08-27 09:40:09] Построение словаря товарных признаков...
[2025-08-27 09:40:09] Добавление данных из items_df...
[2025-08-27 09:40:09] Добавление эмбеддингов...
[2025-08-27 09:40:09] Словарь товарных признаков построен. Записей: 607
[2025-08-27 09:40:09] Словарь сохранён в /home/root6/python/e_cup/rec_system/data/processed/item_features_dict.pkl
[2025-08-27 09:40:09] Item features построены за 0:00:00.054124: 607 товаров
[2025-08-27 09:40:09] Создание UI-признаков (данные остаются на диске)
[2025-08-27 09:40:10] Создано 2 файлов UI-признаков в: /home/root6/python/e_cup/rec_system/data/processed/ui_features_distributed
[2025-08-27 09:40:10] User-Item features созданы в: /home/root6/python/e_cup/rec_system/data/processed/ui_features_distributed
[2025-08-27 09:40:10] Количество файлов: 2
[2025-08-27 09:40:10] User-Item features построены за 0:00:00.017835
[2025-08-27 09:40:10] Предварительный расчет признаков завершен за 0:00:00.124163
[2025-08-27 09:40:10] === ПОДГОТОВКА ДАННЫХ ДЛЯ LightGBM ===
[2025-08-27 09:40:10] Подготовка данных для LightGBM (streaming)...
[2025-08-27 09:40:10] Обучение матрицы ковизитации на train данных...
[2025-08-27 09:40:11] Размер матрицы ковизитации: 5 товаров
[2025-08-27 09:40:11] Добавление фичей для train данных...
[2025-08-27 09:40:11] Добавление богатых признаков...
[2025-08-27 09:40:11] Ускоренная обработка FCLIP эмбеддингов на GPU...
[2025-08-27 09:40:11] Обработка FCLIP измерения 1/10 на GPU...
[2025-08-27 09:40:11] Обработка FCLIP измерения 2/10 на GPU...
[2025-08-27 09:40:11] Обработка FCLIP измерения 3/10 на GPU...
[2025-08-27 09:40:11] Обработка FCLIP измерения 4/10 на GPU...
[2025-08-27 09:40:11] Обработка FCLIP измерения 5/10 на GPU...
[2025-08-27 09:40:11] Обработка FCLIP измерения 6/10 на GPU...
[2025-08-27 09:40:11] Обработка FCLIP измерения 7/10 на GPU...
[2025-08-27 09:40:11] Обработка FCLIP измерения 8/10 на GPU...
[2025-08-27 09:40:11] Обработка FCLIP измерения 9/10 на GPU...
[2025-08-27 09:40:11] Обработка FCLIP измерения 10/10 на GPU...
[2025-08-27 09:40:11] Добавлены фичи: ['is_weekend', 'hour', 'item_popularity', 'category_popularity', 'user_activity', 'user_avg_item_popularity', 'covisitation_score', 'fclip_embed_0', 'fclip_embed_1', 'fclip_embed_2', 'fclip_embed_3', 'fclip_embed_4', 'fclip_embed_5', 'fclip_embed_6', 'fclip_embed_7', 'fclip_embed_8', 'fclip_embed_9']
[2025-08-27 09:40:11] Всего фич после добавления: 17
[2025-08-27 09:40:11] Добавление фичей для val данных (на основе train статистик)...
[2025-08-27 09:40:11] Добавление богатых признаков...
[2025-08-27 09:40:11] Ускоренная обработка FCLIP эмбеддингов на GPU...
[2025-08-27 09:40:11] Обработка FCLIP измерения 1/10 на GPU...
[2025-08-27 09:40:11] Обработка FCLIP измерения 2/10 на GPU...
[2025-08-27 09:40:11] Обработка FCLIP измерения 3/10 на GPU...
[2025-08-27 09:40:11] Обработка FCLIP измерения 4/10 на GPU...
[2025-08-27 09:40:11] Обработка FCLIP измерения 5/10 на GPU...
[2025-08-27 09:40:11] Обработка FCLIP измерения 6/10 на GPU...
[2025-08-27 09:40:11] Обработка FCLIP измерения 7/10 на GPU...
[2025-08-27 09:40:11] Обработка FCLIP измерения 8/10 на GPU...
[2025-08-27 09:40:11] Обработка FCLIP измерения 9/10 на GPU...
[2025-08-27 09:40:11] Обработка FCLIP измерения 10/10 на GPU...
[2025-08-27 09:40:11] Добавлены фичи: ['is_weekend', 'hour', 'item_popularity', 'category_popularity', 'user_activity', 'user_avg_item_popularity', 'covisitation_score', 'fclip_embed_0', 'fclip_embed_1', 'fclip_embed_2', 'fclip_embed_3', 'fclip_embed_4', 'fclip_embed_5', 'fclip_embed_6', 'fclip_embed_7', 'fclip_embed_8', 'fclip_embed_9']
[2025-08-27 09:40:11] Всего фич после добавления: 17
[2025-08-27 09:40:11] Добавлены UI признаки: ['ui_count', 'ui_sum', 'ui_max', 'ui_min', 'ui_mean', 'ui_days_since_last', 'ui_days_since_first']
[2025-08-27 09:40:11] TRAIN: rows=1975; target_counts={0: 1568, 1: 407}
[2025-08-27 09:40:11] VAL: rows=220; target_counts={0: 177, 1: 43}
[2025-08-27 09:40:11] split_time = 2025-06-25 19:56:09.596000 (val_days=7)
[2025-08-27 09:40:11] ✅ Данные подготовлены: train=1975, val=220
[2025-08-27 09:40:11] Размер train: 1606, validation: 369
[2025-08-27 09:40:11] Признаки: 24
[2025-08-27 09:40:11] Подготовка данных для LightGBM завершена за 0:00:01.136240
[2025-08-27 09:40:11] === ДЕТАЛЬНАЯ ПРОВЕРКА FEATURE GENERATION ===
[2025-08-27 09:40:11] --- ПРОВЕРКА USER FEATURES ---
[2025-08-27 09:40:11] Пример user features для пользователя 4132700:
[2025-08-27 09:40:11]   user_count: 1
[2025-08-27 09:40:11]   user_mean: 2.772588722239781
[2025-08-27 09:40:11]   user_sum: 2.772588722239781
[2025-08-27 09:40:11]   user_max: 2.772588722239781
[2025-08-27 09:40:11]   user_min: 2.772588722239781
[2025-08-27 09:40:11]   user_last_ts: 2025-04-02 19:57:37
[2025-08-27 09:40:11]   user_first_ts: 2025-04-02 19:57:37
[2025-08-27 09:40:11]   user_orders_count: 0
[2025-08-27 09:40:11]   user_last_order_ts: None
[2025-08-27 09:40:11]   user_first_order_ts: None
[2025-08-27 09:40:11]   user_days_since_last: 146
[2025-08-27 09:40:11]   user_days_since_first: 146
[2025-08-27 09:40:11]   user_days_since_last_order: None
[2025-08-27 09:40:11] Пользователей с features: 1184
[2025-08-27 09:40:11] Пользователей с НЕнулевыми features: 1184
[2025-08-27 09:40:11] --- ПРОВЕРКА ITEM FEATURES ---
[2025-08-27 09:40:11] Пример item features для товара 333556502:
[2025-08-27 09:40:11]   item_count: 1
[2025-08-27 09:40:11]   item_mean: 0.16394911411495436
[2025-08-27 09:40:11]   item_sum: 0.16394911411495436
[2025-08-27 09:40:11]   item_max: 0.16394911411495436
[2025-08-27 09:40:11]   item_min: 0.16394911411495436
[2025-08-27 09:40:11]   item_last_ts: 2025-07-02 11:10:19.233000
[2025-08-27 09:40:11]   item_first_ts: 2025-07-02 11:10:19.233000
[2025-08-27 09:40:11]   item_orders_count: 1
[2025-08-27 09:40:11]   item_category: None
[2025-08-27 09:40:11]   item_days_since_last: 55
[2025-08-27 09:40:11]   item_days_since_first: 55
[2025-08-27 09:40:11] Товаров с features: 607
[2025-08-27 09:40:11] Товаров с НЕнулевыми features: 607
[2025-08-27 09:40:11] --- ПРОВЕРКА UI FEATURES ---
[2025-08-27 09:40:11] UI features files: 2
[2025-08-27 09:40:11] UI features stats: {}
[2025-08-27 09:40:11] --- ПРОВЕРКА ЭМБЕДДИНГОВ ---
[2025-08-27 09:40:11] Пример эмбеддинга для товара 400301: shape (512,)
[2025-08-27 09:40:11] Эмбеддингов загружено: 990
[2025-08-27 09:40:11] Пример значений: [ 0.32023853  0.11766258 -0.784552    0.4168199  -0.24610527]
[2025-08-27 09:40:11] --- ПРОВЕРКА CO-PURCHASE MAP ---
[2025-08-27 09:40:11] Пример co-purchase для товара 132235443: 1 товаров
[2025-08-27 09:40:11] Co-purchase записей: 4
[2025-08-27 09:40:11] --- ПРОВЕРКА КАТЕГОРИЙНЫХ МАППИНГОВ ---
[2025-08-27 09:40:11] Товар 400301 -> категория 17080
[2025-08-27 09:40:11] Категория 17080 -> 4 товаров
[2025-08-27 09:40:11] Товаров в маппинге: 990
[2025-08-27 09:40:11] Категорий в маппинге: 223
[2025-08-27 09:40:11] Проверка признаков завершена за 0:00:00.001560
[2025-08-27 09:40:11] === ОБУЧЕНИЕ LightGBM ===
[2025-08-27 09:40:11] Размер train: 1606
[2025-08-27 09:40:11] Размер val: 369
[2025-08-27 09:40:11] !!! ОШИБКА ВЫПОЛНЕНИЯ !!!
[2025-08-27 09:40:11] Ошибка: No OpenCL device found
[2025-08-27 09:40:11] Время до ошибки: 0:00:05.859175
[2025-08-27 09:40:11] Трассировка ошибки:
[2025-08-27 09:40:11] Traceback (most recent call last):
  File "/home/root6/python/e_cup/rec_system/src/prepare/with_ml.py", line 2548, in <module>
    model = recommender.train(train_df, val_df)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/root6/python/e_cup/rec_system/src/prepare/with_ml.py", line 1521, in train
    self.model = lgb.train(
                 ^^^^^^^^^^
  File "/home/root6/python/e_cup/venv/lib/python3.12/site-packages/lightgbm/engine.py", line 297, in train
    booster = Booster(params=params, train_set=train_set)
              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/root6/python/e_cup/venv/lib/python3.12/site-packages/lightgbm/basic.py", line 3660, in __init__
    _safe_call(
  File "/home/root6/python/e_cup/venv/lib/python3.12/site-packages/lightgbm/basic.py", line 313, in _safe_call
    raise LightGBMError(_LIB.LGBM_GetLastError().decode("utf-8"))
lightgbm.basic.LightGBMError: No OpenCL device found


=== ОБЩЕЕ ВРЕМЯ ВЫПОЛНЕНИЯ: 0:00:05.860139 ===
