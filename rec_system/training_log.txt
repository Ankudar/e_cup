=== НАЧАЛО ОБУЧЕНИЯ 2025-08-28 11:38:21 ===

[2025-08-28 11:38:21] === РЕЖИМ МАСШТАБИРОВАНИЯ: FULL ===
[2025-08-28 11:38:21] Пользователей: все
[2025-08-28 11:38:21] Данных: 100.0%
[2025-08-28 11:38:21] === ЗАГРУЗКА ДАННЫХ ===
[2025-08-28 11:38:21] Загружаем данные...
[2025-08-28 11:38:22] orders: 100,000 строк (использовано 5 из 5 партиций), ~3.8 MB
[2025-08-28 11:38:23] tracker: 100,000 строк (использовано 200 из 200 партиций), ~3.2 MB
[2025-08-28 11:38:23] items: 100,000 строк (использовано 200 из 200 партиций), ~7.4 MB
[2025-08-28 11:38:23] categories: 7,012 строк (использовано 1 из 1 партиций), ~1.7 MB
[2025-08-28 11:38:23] test_users: 100,000 строк (использовано 1 из 1 партиций), ~0.4 MB
[2025-08-28 11:38:23] Данные загружены
[2025-08-28 11:38:23] Фильтрация данных...
[2025-08-28 11:38:23] Фильтрация завершена
[2025-08-28 11:38:23] Загрузка данных завершена за 0:00:01.971103
[2025-08-28 11:38:23] === ЗАГРУЗКА ЭМБЕДДИНГОВ ===
[2025-08-28 11:38:23] Оптимизированная потоковая загрузка эмбеддингов...
[2025-08-28 11:38:24] Загружено эмбеддингов для 43059 товаров
[2025-08-28 11:38:24] Пример ключей в embeddings_dict: [400301, 678602, 746401, 872829, 893255]
[2025-08-28 11:38:24] Пример значения: [ 0.32023853  0.11766258 -0.784552    0.4168199  -0.24610527]
[2025-08-28 11:38:24] Загрузка эмбеддингов завершена за 0:00:00.960411
[2025-08-28 11:38:24] Загружено эмбеддингов: 43059
[2025-08-28 11:38:24] === SPLIT ДАННЫХ ===
[2025-08-28 11:38:25] Split данных завершен за 0:00:00.333520
[2025-08-28 11:38:25] Train orders: 75737, Test orders: 18934
[2025-08-28 11:38:25] === ПОДГОТОВКА ВЗАИМОДЕЙСТВИЙ ===
[2025-08-28 11:38:25] Формируем матрицу взаимодействий по батчам...
[2025-08-28 11:38:25] ... для orders
[2025-08-28 11:38:25] Сохранен orders-батч 0-75737
[2025-08-28 11:38:25] ... для tracker
[2025-08-28 11:38:26] Сохранен tracker-партиция 0
[2025-08-28 11:38:26] Все батчи сохранены на диск.
[2025-08-28 11:38:26] Подготовка взаимодействий завершена за 0:00:00.877784
[2025-08-28 11:38:26] Создано файлов взаимодействий: 2
[2025-08-28 11:38:26] === ПОСЛЕДНИЕ ТОВАРЫ ===
[2025-08-28 11:38:26] Словарь сохранен в /home/root6/python/e_cup/rec_system/data/processed/recent_items_map.pkl
[2025-08-28 11:38:26] Построение recent items map завершено за 0:00:00.073110
[2025-08-28 11:38:26] Пользователей с recent items: 95951
[2025-08-28 11:38:26] === ОБУЧЕНИЕ ALS ДЛЯ ПРИЗНАКОВ ===
[2025-08-28 11:38:26] Первый проход: построение маппингов...
[2025-08-28 11:38:26] Маппинги построены. Уников: users=95951, items=21340
[2025-08-28 11:38:26] item_map сохранен: /home/root6/python/e_cup/rec_system/data/processed/item_map.pkl
[2025-08-28 11:38:26] Сохранение батчей на диск...
[2025-08-28 11:38:26] Постепенное обучение...
[2025-08-28 11:38:27] Очистка временных файлов...
[2025-08-28 11:38:27] Директория батчей удалена
[2025-08-28 11:38:27] Обучение завершено!
[2025-08-28 11:38:27] Считаем глобальную популярность на основе тренировочных данных...
[2025-08-28 11:38:27] Глобальная популярность рассчитана на 75736 тренировочных заказах
[2025-08-28 11:38:27] Обучение ALS завершено за 0:00:00.901143
[2025-08-28 11:38:27] Пользователей: 95951, Товаров: 21340
[2025-08-28 11:38:27] === ПОСТРОЕНИЕ ДОПОЛНИТЕЛЬНЫХ ДАННЫХ ===
[2025-08-28 11:38:27] Строим co-purchase матрицу для топ-N товаров...
[2025-08-28 11:38:27] Топ-500 популярных товаров определены
[2025-08-28 11:38:27] Обрабатываем 237 корзин с популярными товарами
[2025-08-28 11:38:27] Уникальных популярных товаров: 500
[2025-08-28 11:38:27] Создаем sparse матрицу из 4144 взаимодействий...
[2025-08-28 11:38:27] Sparse матрица построена: torch.Size([500, 500]), ненулевых элементов: 134
[2025-08-28 11:38:27] Формируем рекомендации...
[2025-08-28 11:38:27] Co-purchase словарь построен для 126 товаров
[2025-08-28 11:38:27] В среднем 1.1 рекомендаций на товар
[2025-08-28 11:38:27] Co-purchase map построен: 126 товаров
[2025-08-28 11:38:28] Построение категорийных маппингов...
[2025-08-28 11:38:28] Категорийные маппинги построены: 63318 товаров, 419 категорий
[2025-08-28 11:38:28] Построение дополнительных данных завершено за 0:00:01.065937
[2025-08-28 11:38:28] === ПРЕДВАРИТЕЛЬНЫЙ РАСЧЕТ ПРИЗНАКОВ ДЛЯ LGBM ===
[2025-08-28 11:38:28] Построение словаря пользовательских признаков...
[2025-08-28 11:38:28] Агрегация по заказам...
[2025-08-28 11:38:28] Словарь пользовательских признаков построен и сохранён в /home/root6/python/e_cup/rec_system/data/processed/cat_to_items.pkl. Записей: 95952
[2025-08-28 11:38:28] User features построены за 0:00:00.438415: 95952 пользователей
[2025-08-28 11:38:28] Построение словаря товарных признаков...
[2025-08-28 11:38:28] Добавление данных из items_df...
[2025-08-28 11:38:29] Добавление эмбеддингов...
[2025-08-28 11:38:29] Словарь товарных признаков построен. Записей: 21341
[2025-08-28 11:38:29] Item features: 21341 товаров, размер вектора: 12 признаков
[2025-08-28 11:38:29] Порядок признаков: ['item_count', 'item_mean', 'item_sum', 'item_max', 'item_min', 'item_orders_count', 'item_category', 'fclip_embed_0', 'fclip_embed_1', 'fclip_embed_2']...
[2025-08-28 11:38:29] item_features_dict[99499634] type=<class 'numpy.ndarray'>, shape=(12,), example=[2.        2.8869565 5.773913  4.091552  1.6823611]
[2025-08-28 11:38:29] item_features_dict[278754702] type=<class 'numpy.ndarray'>, shape=(12,), example=[ 3.         6.5092926 19.527878   6.6750054  6.3112087]
[2025-08-28 11:38:29] item_features_dict[2419742] type=<class 'numpy.ndarray'>, shape=(12,), example=[1.        2.5541282 2.5541282 2.5541282 2.5541282]
[2025-08-28 11:38:29] item_features_dict[None] type=<class 'numpy.ndarray'>, shape=(12,), example=[0. 0. 0. 0. 0.]
[2025-08-28 11:38:29] item_features_dict[44555908] type=<class 'numpy.ndarray'>, shape=(12,), example=[ 3.         4.6342616 13.902784   5.815754   3.7096868]
[2025-08-28 11:38:29] Item features построены за 0:00:00.623857
[2025-08-28 11:38:29] === ПОДГОТОВКА ДАННЫХ ДЛЯ LightGBM ===
[2025-08-28 11:38:29] Подготовка данных для LightGBM (streaming, polars lazy, векторно)...
[2025-08-28 11:38:29] Negatives к positive: 0
[2025-08-28 11:38:29] ✅ Данные подготовлены (streaming lazy polars, векторно)
[2025-08-28 11:38:29] Размер train: 101432, validation: 25468
[2025-08-28 11:38:29] Признаки: 19
[2025-08-28 11:38:29] Подготовка данных для LightGBM завершена за 0:00:00.521208
[2025-08-28 11:38:29] === ДЕТАЛЬНАЯ ПРОВЕРКА FEATURE GENERATION ===
[2025-08-28 11:38:29] --- ПРОВЕРКА USER FEATURES ---
[2025-08-28 11:38:29] Пример user features для пользователя 1469931:
[2025-08-28 11:38:29]   user_count: 1
[2025-08-28 11:38:29]   user_mean: 5.380697164080256
[2025-08-28 11:38:29]   user_sum: 5.380697164080256
[2025-08-28 11:38:29]   user_max: 5.380697164080256
[2025-08-28 11:38:29]   user_min: 5.380697164080256
[2025-08-28 11:38:29]   user_orders_count: 1
[2025-08-28 11:38:29] Пользователей с features: 95952
[2025-08-28 11:38:29] Пользователей с НЕнулевыми features: 95952
[2025-08-28 11:38:29] --- ПРОВЕРКА ITEM FEATURES ---
[2025-08-28 11:38:29] Пример item features для товара 99499634:
[2025-08-28 11:38:29]   emb_0: 2.0
[2025-08-28 11:38:29]   emb_1: 2.8869564533233643
[2025-08-28 11:38:29]   emb_2: 5.7739129066467285
[2025-08-28 11:38:29]   emb_3: 4.091551780700684
[2025-08-28 11:38:29]   emb_4: 1.682361125946045
[2025-08-28 11:38:29]   emb_5: 2.0
[2025-08-28 11:38:29]   emb_6: 36578.0
[2025-08-28 11:38:29]   emb_7: 0.20250260829925537
[2025-08-28 11:38:29]   emb_8: 0.6419633626937866
[2025-08-28 11:38:29]   emb_9: -0.3057639002799988
[2025-08-28 11:38:29]   emb_10: 0.1960780918598175
[2025-08-28 11:38:29]   emb_11: 0.6851245164871216
[2025-08-28 11:38:29] Товаров с features: 21341
[2025-08-28 11:38:29] Товаров с НЕнулевыми features: 21341
[2025-08-28 11:38:29] --- ПРОВЕРКА ЭМБЕДДИНГОВ ---
[2025-08-28 11:38:29] Пример эмбеддинга для товара 400301: shape (512,)
[2025-08-28 11:38:29] Эмбеддингов загружено: 43059
[2025-08-28 11:38:29] Пример значений: [ 0.32023853  0.11766258 -0.784552    0.4168199  -0.24610527]
[2025-08-28 11:38:29] --- ПРОВЕРКА CO-PURCHASE MAP ---
[2025-08-28 11:38:29] Пример co-purchase для товара 141204132: 1 товаров
[2025-08-28 11:38:29] Co-purchase записей: 126
[2025-08-28 11:38:29] --- ПРОВЕРКА КАТЕГОРИЙНЫХ МАППИНГОВ ---
[2025-08-28 11:38:29] Товар 400301 -> категория 17080
[2025-08-28 11:38:29] Категория 17080 -> 173 товаров
[2025-08-28 11:38:29] Товаров в маппинге: 63318
[2025-08-28 11:38:29] Категорий в маппинге: 419
[2025-08-28 11:38:29] Проверка признаков завершена за 0:00:00.057730
[2025-08-28 11:38:29] === ОБУЧЕНИЕ LightGBM ===
[2025-08-28 11:38:29] === ДЕБАГ ИНФОРМАЦИЯ: TRAIN ===
[2025-08-28 11:38:29] Размер: 101432 строк
[2025-08-28 11:38:29] Колонки: ['item_id', 'user_id', 'created_timestamp', 'last_status', 'target', 'weight', 'user_count', 'user_mean', 'user_sum', 'user_max', 'user_min', 'user_orders_count', 'emb_0', 'emb_1', 'emb_2', 'emb_3', 'emb_4', 'emb_5', 'emb_6', 'emb_7', 'emb_8', 'emb_9', 'emb_10', 'emb_11', 'copurchase_count']
[2025-08-28 11:38:29] ✅ Все признаки присутствуют
[2025-08-28 11:38:29] Целевая переменная: {1: np.int64(54387), 0: np.int64(47045)}
[2025-08-28 11:38:29] Пример первой строки:
[2025-08-28 11:38:29]   item_id: 51776625
[2025-08-28 11:38:29]   user_id: 3293811
[2025-08-28 11:38:29]   created_timestamp: 2025-02-13 19:00:37.846000
[2025-08-28 11:38:29]   last_status: delivered_orders
[2025-08-28 11:38:29]   target: 1
[2025-08-28 11:38:29]   weight: 7.331685343967136
[2025-08-28 11:38:29]   user_count: 1.0
[2025-08-28 11:38:29]   user_mean: 7.331685343967136
[2025-08-28 11:38:29]   user_sum: 7.331685343967136
[2025-08-28 11:38:29]   user_max: 7.331685343967136
[2025-08-28 11:38:29]   user_min: 7.331685343967136
[2025-08-28 11:38:29]   user_orders_count: 1.0
[2025-08-28 11:38:29]   emb_0: 20.0
[2025-08-28 11:38:29]   emb_1: 5.271136283874512
[2025-08-28 11:38:29]   emb_2: 105.4227294921875
[2025-08-28 11:38:29]   emb_3: 8.243292808532715
[2025-08-28 11:38:29]   emb_4: 0.9116078019142151
[2025-08-28 11:38:29]   emb_5: 23.0
[2025-08-28 11:38:29]   emb_6: 17031.0
[2025-08-28 11:38:29]   emb_7: 0.23768490552902222
[2025-08-28 11:38:29]   emb_8: 0.7679952383041382
[2025-08-28 11:38:29]   emb_9: -0.6340829730033875
[2025-08-28 11:38:29]   emb_10: -0.434574156999588
[2025-08-28 11:38:29]   emb_11: 0.13783203065395355
[2025-08-28 11:38:29]   copurchase_count: 0.0
[2025-08-28 11:38:29] === ДЕБАГ ИНФОРМАЦИЯ: VAL ===
[2025-08-28 11:38:29] Размер: 25468 строк
[2025-08-28 11:38:29] Колонки: ['item_id', 'user_id', 'created_timestamp', 'last_status', 'target', 'weight', 'user_count', 'user_mean', 'user_sum', 'user_max', 'user_min', 'user_orders_count', 'emb_0', 'emb_1', 'emb_2', 'emb_3', 'emb_4', 'emb_5', 'emb_6', 'emb_7', 'emb_8', 'emb_9', 'emb_10', 'emb_11', 'copurchase_count']
[2025-08-28 11:38:29] ✅ Все признаки присутствуют
[2025-08-28 11:38:29] Целевая переменная: {1: np.int64(13175), 0: np.int64(12293)}
[2025-08-28 11:38:29] Пример первой строки:
[2025-08-28 11:38:29]   item_id: 12015662
[2025-08-28 11:38:29]   user_id: 3089200
[2025-08-28 11:38:29]   created_timestamp: 2025-05-23 15:26:45.926000
[2025-08-28 11:38:29]   last_status: delivered_orders
[2025-08-28 11:38:29]   target: 1
[2025-08-28 11:38:29]   weight: 0.16394911411495436
[2025-08-28 11:38:29]   user_count: 1
[2025-08-28 11:38:29]   user_mean: 0.16394911411495436
[2025-08-28 11:38:29]   user_sum: 0.16394911411495436
[2025-08-28 11:38:29]   user_max: 0.16394911411495436
[2025-08-28 11:38:29]   user_min: 0.16394911411495436
[2025-08-28 11:38:29]   user_orders_count: 1
[2025-08-28 11:38:29]   emb_0: 6.0
[2025-08-28 11:38:29]   emb_1: 1.7316930294036865
[2025-08-28 11:38:29]   emb_2: 10.390157699584961
[2025-08-28 11:38:29]   emb_3: 8.013744354248047
[2025-08-28 11:38:29]   emb_4: 0.163949117064476
[2025-08-28 11:38:29]   emb_5: 6.0
[2025-08-28 11:38:29]   emb_6: 36734.0
[2025-08-28 11:38:29]   emb_7: 0.5092477202415466
[2025-08-28 11:38:29]   emb_8: 1.6942391395568848
[2025-08-28 11:38:29]   emb_9: 0.3858272433280945
[2025-08-28 11:38:29]   emb_10: -0.1928037703037262
[2025-08-28 11:38:29]   emb_11: -0.04905738681554794
[2025-08-28 11:38:29]   copurchase_count: 0.0
[2025-08-28 11:38:29] Feature columns: ['copurchase_count', 'user_count', 'user_mean', 'user_sum', 'user_max', 'user_min', 'user_orders_count', 'emb_0', 'emb_1', 'emb_2', 'emb_3', 'emb_4', 'emb_5', 'emb_6', 'emb_7', 'emb_8', 'emb_9', 'emb_10', 'emb_11']
[2025-08-28 11:38:29] [Iter 0] train_ndcg@100:0.9829, valid_ndcg@100:0.9841
[2025-08-28 11:38:30] [Iter 50] train_ndcg@100:0.9914, valid_ndcg@100:0.9903
[2025-08-28 11:38:30] NDCG@100 на валидации: 0.5506
[2025-08-28 11:38:30] Обучение LightGBM завершено за 0:00:00.782583
[2025-08-28 11:38:30] === ОЦЕНКА МОДЕЛИ ===
[2025-08-28 11:38:34] NDCG@100 train: 0.5897
[2025-08-28 11:38:34] NDCG@100 val: 0.5506
[2025-08-28 11:38:34] Оценка модели завершена за 0:00:03.918391
[2025-08-28 11:38:34] === ВАЖНОСТЬ ПРИЗНАКОВ ===
[2025-08-28 11:38:34] Топ-20 важных признаков:
[2025-08-28 11:38:34]   emb_6: 503
[2025-08-28 11:38:34]   emb_9: 266
[2025-08-28 11:38:34]   emb_8: 256
[2025-08-28 11:38:34]   user_sum: 205
[2025-08-28 11:38:34]   emb_7: 203
[2025-08-28 11:38:34]   emb_11: 153
[2025-08-28 11:38:34]   emb_1: 151
[2025-08-28 11:38:34]   emb_4: 133
[2025-08-28 11:38:34]   emb_10: 127
[2025-08-28 11:38:34]   emb_2: 121
[2025-08-28 11:38:34]   emb_0: 117
[2025-08-28 11:38:34]   emb_3: 108
[2025-08-28 11:38:34]   emb_5: 99
[2025-08-28 11:38:34]   user_orders_count: 88
[2025-08-28 11:38:34]   user_min: 38
[2025-08-28 11:38:34]   user_count: 27
[2025-08-28 11:38:34]   user_max: 26
[2025-08-28 11:38:34]   copurchase_count: 25
[2025-08-28 11:38:34]   user_mean: 20
[2025-08-28 11:38:34] Анализ важности признаков завершен за 0:00:00.001861
[2025-08-28 11:38:34] === СОХРАНЕНИЕ МОДЕЛИ И ПРИЗНАКОВ ===
[2025-08-28 11:38:34] Сохранение модели завершено за 0:00:00.081016
[2025-08-28 11:38:34] Модель сохранена в: /home/root6/python/e_cup/rec_system/src/models/lgbm_model_full.pkl
[2025-08-28 11:38:34] === ОБУЧЕНИЕ И ПРЕДСКАЗАНИЯ ЗАВЕРШЕНЫ УСПЕШНО ===
[2025-08-28 11:38:34] Общее время выполнения: 0:00:12.609493
[2025-08-28 11:38:34] Пользователей: 95951
[2025-08-28 11:38:34] Товаров: 21340
[2025-08-28 11:38:34] Признаков: 19
[2025-08-28 11:38:34] NDCG@100 train: 0.5897
[2025-08-28 11:38:34] NDCG@100 val: 0.5506
[2025-08-28 11:38:34] === СИСТЕМНАЯ ИНФОРМАЦИЯ ===
[2025-08-28 11:38:34] Видеокарта: NVIDIA GeForce RTX 4090
[2025-08-28 11:38:34] Память GPU: 24.0 GB
[2025-08-28 11:38:34] Процессор: 12.1% загрузки
[2025-08-28 11:38:34] Ядра CPU: 32
[2025-08-28 11:38:34] Частота CPU: 2995.2 MHz
[2025-08-28 11:38:34] Оперативная память: 94.2 GB всего, 77.7 GB использовано
[2025-08-28 11:38:34] Частота RAM: информация требует дополнительных библиотек
[2025-08-28 11:38:34] ==========================================
[2025-08-28 11:38:34] ВСЕ ЭТАПЫ ВЫПОЛНЕНЫ УСПЕШНО!
[2025-08-28 11:38:34] ==========================================

=== ОБЩЕЕ ВРЕМЯ ВЫПОЛНЕНИЯ: 0:00:12.610564 ===
