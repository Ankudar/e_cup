=== НАЧАЛО ОБУЧЕНИЯ 2025-09-03 18:17:05 ===

[2025-09-03 18:17:05] === РЕЖИМ МАСШТАБИРОВАНИЯ: FULL ===
[2025-09-03 18:17:05] Пользователей: все
[2025-09-03 18:17:05] Данных: 100.0%
[2025-09-03 18:17:05] === ЗАГРУЗКА ДАННЫХ ===
[2025-09-03 18:17:05] Загружаем данные...
[2025-09-03 18:17:05] orders: найдено 5 файлов, используем 5
[2025-09-03 18:17:07] orders: ограничено 1,000,000 из 18,887,122 строк (семплирование 5.3%, использовано 5 файлов), ~45.5 MB
[2025-09-03 18:17:07] tracker: найдено 200 файлов, используем 200
[2025-09-03 18:19:12] tracker: ограничено 1,000,002 из 1,644,982,482 строк (семплирование 0.1%, использовано 200 файлов), ~40.1 MB
[2025-09-03 18:19:12] items: найдено 100 файлов, используем 100
[2025-09-03 18:19:25] items: ограничено 999,998 из 6,439,422 строк (семплирование 15.5%, использовано 100 файлов), ~176.3 MB
[2025-09-03 18:19:25] categories: найдено 1 файлов, используем 1
[2025-09-03 18:19:25] categories: 7,012 строк (использовано 1 файлов), ~1.7 MB
[2025-09-03 18:19:25] test_users: найдено 1 файлов, используем 1
[2025-09-03 18:19:25] test_users: 470,347 строк (использовано 1 файлов), ~1.8 MB
[2025-09-03 18:19:25] Данные загружены
[2025-09-03 18:19:25] Фильтрация данных...
[2025-09-03 18:19:25] Фильтрация завершена
[2025-09-03 18:19:25] Загрузка данных завершена за 0:02:19.189953
[2025-09-03 18:19:25] === ЗАГРУЗКА ЭМБЕДДИНГОВ ===
[2025-09-03 18:19:25] Оптимизированная потоковая загрузка эмбеддингов... без PCA
[2025-09-03 18:19:33] Загружено эмбеддингов для 996653 товаров
[2025-09-03 18:19:33] Загружено сырых эмбеддингов: 996653
[2025-09-03 18:19:33] Размерность исходных эмбеддингов: 512
[2025-09-03 18:19:33] Анализ дисперсии эмбеддингов...
[2025-09-03 18:19:40] Оптимальное число компонент PCA: 354
[2025-09-03 18:19:40] Объясненная дисперсия: 95.022%
[2025-09-03 18:19:47] График PCA сохранен: /home/root6/python/e_cup/rec_system/pca_variance.png
[2025-09-03 18:19:47] Используем 10 компонент PCA (оптимально: 354, лимит: 10)
[2025-09-03 18:19:53] Обучение PCA на выборке из 100000 эмбеддингов...
[2025-09-03 18:19:57] PCA: сохранено 25.12% дисперсии в 10 компонентах
[2025-09-03 18:19:57] Применение PCA ко всем 996653 эмбеддингам батчами...
[2025-09-03 18:20:00] PCA трансформация завершена
[2025-09-03 18:20:03] Модель PCA сохранена: /home/root6/python/e_cup/rec_system/data/processed/embeddings_pca_pca.pkl
[2025-09-03 18:20:03] Модель Scaler сохранена: /home/root6/python/e_cup/rec_system/data/processed/embeddings_pca_scaler.pkl
[2025-09-03 18:20:03] Пример ключей в embeddings_dict: [313302306, 323611609, 313930510, 20238674, 113158168]
[2025-09-03 18:20:03] Пример значения после PCA: [ 9.488856   4.236806   1.7571259  5.7071743 -3.1916673]
[2025-09-03 18:20:03] Размерность после PCA: 10
[2025-09-03 18:20:03] Загрузка эмбеддингов с PCA завершена за 0:00:38.375101
[2025-09-03 18:20:03] Загружено эмбеддингов: 996653
[2025-09-03 18:20:03] === SPLIT ДАННЫХ ===
[2025-09-03 18:20:04] Split данных завершен за 0:00:01.203752
[2025-09-03 18:20:04] Train orders: 756671, Test orders: 189167
[2025-09-03 18:20:04] === ПОДГОТОВКА ВЗАИМОДЕЙСТВИЙ ===
[2025-09-03 18:20:04] Формируем матрицу взаимодействий по батчам...
[2025-09-03 18:20:04] ... обработка orders
[2025-09-03 18:20:04] Сохранен orders-батч 0-756671
[2025-09-03 18:20:05] ... обработка tracker
[2025-09-03 18:20:05] Обрабатываем 10 файлов tracker
[2025-09-03 18:20:06] Обработан tracker файл 0: 5202298 строк
[2025-09-03 18:20:07] Обработан tracker файл 1: 5086619 строк
[2025-09-03 18:20:08] Обработан tracker файл 2: 5043382 строк
[2025-09-03 18:20:10] Обработан tracker файл 3: 4985330 строк
[2025-09-03 18:20:11] Обработан tracker файл 4: 4987315 строк
[2025-09-03 18:20:12] Обработан tracker файл 5: 5217555 строк
[2025-09-03 18:20:14] Обработан tracker файл 6: 5028383 строк
[2025-09-03 18:20:15] Обработан tracker файл 7: 5184783 строк
[2025-09-03 18:20:16] Обработан tracker файл 8: 5118363 строк
[2025-09-03 18:20:17] Обработан tracker файл 9: 5065895 строк
[2025-09-03 18:20:17] Все файлы успешно созданы
[2025-09-03 18:20:17] Всего файлов взаимодействий: 11
[2025-09-03 18:20:17] Подготовка взаимодействий завершена за 0:00:13.150672
[2025-09-03 18:20:17] Создано файлов взаимодействий: 11
[2025-09-03 18:20:17] === ПОСЛЕДНИЕ ТОВАРЫ ===
[2025-09-03 18:20:26] Словарь сохранен в /home/root6/python/e_cup/rec_system/data/processed/recent_items_map.pkl
[2025-09-03 18:20:26] Построение recent items map завершено за 0:00:08.731196
[2025-09-03 18:20:26] Пользователей с recent items: 944178
[2025-09-03 18:20:26] === ОБУЧЕНИЕ ALS ДЛЯ ПРИЗНАКОВ ===
[2025-09-03 18:20:26] Первый проход: построение маппингов...
[2025-09-03 18:20:27] Маппинги построены. Уников: users=944178, items=779031
[2025-09-03 18:20:27] item_map сохранен: /home/root6/python/e_cup/rec_system/data/processed/item_map.pkl
[2025-09-03 18:20:27] Сохранение батчей на диск...
[2025-09-03 18:20:29] Обучение als_model...
[2025-09-03 18:20:35] Очистка временных файлов...
[2025-09-03 18:20:35] Директория батчей удалена
[2025-09-03 18:20:35] Обучение завершено!
[2025-09-03 18:20:36] als_model сохранен: /home/root6/python/e_cup/rec_system/src/models/als_model.pt
[2025-09-03 18:20:36] Считаем глобальную популярность на основе тренировочных данных...
[2025-09-03 18:20:36] Глобальная популярность рассчитана на 756670 тренировочных заказах
[2025-09-03 18:20:36] Обучение ALS завершено за 0:00:09.479755
[2025-09-03 18:20:36] Пользователей: 944178, Товаров: 779031
[2025-09-03 18:20:36] === ПОСТРОЕНИЕ ДОПОЛНИТЕЛЬНЫХ ДАННЫХ ===
[2025-09-03 18:20:36] Строим co-purchase матрицу для топ-N товаров...
[2025-09-03 18:20:36] Топ-2000 популярных товаров определены
[2025-09-03 18:20:44] Обрабатываем 129 корзин с популярными товарами
[2025-09-03 18:20:44] Уникальных популярных товаров: 2000
[2025-09-03 18:20:44] Создаем sparse матрицу из 262 взаимодействий...
[2025-09-03 18:20:44] Sparse матрица построена: torch.Size([2000, 2000]), ненулевых элементов: 254
[2025-09-03 18:20:44] Формируем рекомендации...
[2025-09-03 18:20:44] Co-purchase словарь построен для 205 товаров
[2025-09-03 18:20:44] В среднем 1.2 рекомендаций на товар
[2025-09-03 18:20:44] Co-purchase map построен: 205 товаров
[2025-09-03 18:20:50] Построение категорийных маппингов...
[2025-09-03 18:20:51] Категорийные маппинги построены: 996653 товаров, 457 категорий
[2025-09-03 18:20:51] Построение дополнительных данных завершено за 0:00:14.976940
[2025-09-03 18:20:51] === ПРЕДВАРИТЕЛЬНЫЙ РАСЧЕТ ПРИЗНАКОВ ===
[2025-09-03 18:20:51] Построение словаря пользовательских признаков из ТРЕНИРОВОЧНЫХ данных...
[2025-09-03 18:20:52] Агрегация по ЗАКАЗАМ (train)...
[2025-09-03 18:20:53] Словарь пользовательских признаков построен. Записей: 944178
[2025-09-03 18:20:53] User features построены за 0:00:02.596535: 944178 пользователей
[2025-09-03 18:20:53] Построение словаря товарных признаков из ТРЕНИРОВОЧНЫХ данных...
[2025-09-03 18:20:54] Обработка ЗАКАЗОВ (train)...
[2025-09-03 18:20:55] Словарь товарных признаков построен. Записей: 779031
[2025-09-03 18:20:55] Item features: 779031 товаров, размер вектора: 6 признаков
[2025-09-03 18:20:55] Порядок признаков: ['item_max', 'item_sum', 'item_orders_count', 'item_count', 'item_mean', 'item_min']
[2025-09-03 18:20:56] item_features_dict[27262977] type=<class 'numpy.ndarray'>, shape=(6,), example=[ 33.67296  313.97754    0.        78.         4.025353]
[2025-09-03 18:20:56] item_features_dict[52428801] type=<class 'numpy.ndarray'>, shape=(6,), example=[14.92841  28.123697  2.        2.       14.061849]
[2025-09-03 18:20:56] item_features_dict[251658241] type=<class 'numpy.ndarray'>, shape=(6,), example=[27.725887  93.66792    0.        26.         3.6026123]
[2025-09-03 18:20:56] item_features_dict[71303174] type=<class 'numpy.ndarray'>, shape=(6,), example=[ 17.005987  106.73438     0.         21.          5.0825896]
[2025-09-03 18:20:56] item_features_dict[255852555] type=<class 'numpy.ndarray'>, shape=(6,), example=[2.3500183 2.3500183 1.        1.        2.3500183]
[2025-09-03 18:20:57] Item features построены за 0:00:03.967556
[2025-09-03 18:20:57] === ПОДГОТОВКА ДАННЫХ ДЛЯ МОДЕЛИ ===
[2025-09-03 18:20:57] Подготовка данных для модели (streaming, polars lazy, батчи)...
[2025-09-03 18:20:57] Тестовые заказы отсутствуют
[2025-09-03 18:20:57] Разделение ТРЕНИРОВОЧНЫХ заказов по времени: 2025-01-01 00:00:22.200000 -> 2025-04-28 03:19:54.018400 (train) | 2025-04-28 03:19:54.018400 -> 2025-05-27 10:09:46.973000 (val)
[2025-09-03 18:20:57] Максимальная дата тренировочных заказов: 2025-05-27 10:09:46.973000
[2025-09-03 18:20:57] check_leakage train
[2025-09-03 18:20:59] Потенциальных утечек в train: 0
[2025-09-03 18:20:59] train: Утечек не обнаружено
[2025-09-03 18:20:59] check_leakage val
[2025-09-03 18:21:00] Потенциальных утечек в val: 0
[2025-09-03 18:21:00] val: Утечек не обнаружено
[2025-09-03 18:21:00] Формируем User признаки
[2025-09-03 18:21:01] Формируем Item признаки
[2025-09-03 18:21:02] Формируем Эмбеддинги
[2025-09-03 18:21:03] Объединение признаков в train
[2025-09-03 18:21:03] Объединение признаков в val
[2025-09-03 18:21:03] Заполняем NaN
[2025-09-03 18:21:03] Сохранение паркета для train
[2025-09-03 18:21:04] Сохранение паркета для val
[2025-09-03 18:21:14] Данные подготовлены БЕЗ УТЕЧЕК. Train: 155605 строк, Val: 48213 строк
[2025-09-03 18:21:14] Признаки: ['user_count', 'user_mean', 'user_sum', 'user_max', 'user_min', 'user_orders_count', 'item_feat_0', 'item_feat_1', 'item_feat_2', 'item_feat_3', 'item_feat_4', 'item_feat_5', 'emb_0', 'emb_1', 'emb_2', 'emb_3', 'emb_4', 'emb_5', 'emb_6', 'emb_7', 'emb_8', 'emb_9']
[2025-09-03 18:21:14] Собираем паркет для трейна
[2025-09-03 18:21:14] Собираем паркет для вала
[2025-09-03 18:21:14] Размер train: 155605, validation: 48213
[2025-09-03 18:21:14] Признаки: 22
[2025-09-03 18:21:14] Подготовка данных для модели завершена за 0:00:16.977679
[2025-09-03 18:21:14] === ДЕТАЛЬНАЯ ПРОВЕРКА FEATURE GENERATION ===
[2025-09-03 18:21:14] --- ПРОВЕРКА USER FEATURES ---
[2025-09-03 18:21:14] Пример user features для пользователя 2112620:
[2025-09-03 18:21:14]   user_count: 71
[2025-09-03 18:21:14]   user_mean: 5.9031171161454115
[2025-09-03 18:21:14]   user_sum: 419.12131524632423
[2025-09-03 18:21:14]   user_max: 32.42592351485517
[2025-09-03 18:21:14]   user_min: 0.7884573603642702
[2025-09-03 18:21:14]   user_orders_count: 1
[2025-09-03 18:21:14] Пользователей с features: 944178
[2025-09-03 18:21:14] Пользователей с НЕнулевыми features: 944178
[2025-09-03 18:21:14] --- ПРОВЕРКА ITEM FEATURES ---
[2025-09-03 18:21:14] Пример item features для товара 27262977:
[2025-09-03 18:21:14]   emb_0: 33.67295837402344
[2025-09-03 18:21:14]   emb_1: 313.9775390625
[2025-09-03 18:21:14]   emb_2: 0.0
[2025-09-03 18:21:14]   emb_3: 78.0
[2025-09-03 18:21:14]   emb_4: 4.025352954864502
[2025-09-03 18:21:14]   emb_5: 2.944438934326172
[2025-09-03 18:21:15] Товаров с features: 779031
[2025-09-03 18:21:15] Товаров с НЕнулевыми features: 779031
[2025-09-03 18:21:15] --- ПРОВЕРКА ЭМБЕДДИНГОВ ---
[2025-09-03 18:21:15] Пример эмбеддинга для товара 313302306: shape (10,)
[2025-09-03 18:21:15] Эмбеддингов загружено: 996653
[2025-09-03 18:21:15] Пример значений: [ 9.488856   4.236806   1.7571259  5.7071743 -3.1916673]
[2025-09-03 18:21:15] --- ПРОВЕРКА CO-PURCHASE MAP ---
[2025-09-03 18:21:15] Пример co-purchase для товара 51974017: 2 товаров
[2025-09-03 18:21:15] Co-purchase записей: 205
[2025-09-03 18:21:15] --- ПРОВЕРКА КАТЕГОРИЙНЫХ МАППИНГОВ ---
[2025-09-03 18:21:15] Товар 313302306 -> категория 7646
[2025-09-03 18:21:15] Категория 7646 -> 4672 товаров
[2025-09-03 18:21:15] Товаров в маппинге: 996653
[2025-09-03 18:21:15] Категорий в маппинге: 457
[2025-09-03 18:21:15] Проверка признаков завершена за 0:00:01.244483
[2025-09-03 18:21:15] === ОБУЧЕНИЕ МОДЕЛИ ===
[2025-09-03 18:21:16] === ДЕБАГ ИНФОРМАЦИЯ: TRAIN ===
[2025-09-03 18:21:16] Размер: 155605 строк
[2025-09-03 18:21:16] Колонки: ['item_id', 'user_id', 'created_timestamp', 'last_status', 'target', 'timestamp', 'weight', 'user_count', 'user_mean', 'user_sum', 'user_max', 'user_min', 'user_orders_count', 'item_feat_0', 'item_feat_1', 'item_feat_2', 'item_feat_3', 'item_feat_4', 'item_feat_5', 'emb_0', 'emb_1', 'emb_2', 'emb_3', 'emb_4', 'emb_5', 'emb_6', 'emb_7', 'emb_8', 'emb_9']
[2025-09-03 18:21:16] Все признаки присутствуют
[2025-09-03 18:21:16] Целевая переменная: {1: np.int64(85002), 0: np.int64(70603)}
[2025-09-03 18:21:16] Пример первой строки:
[2025-09-03 18:21:16]   item_id: 325167683
[2025-09-03 18:21:16]   user_id: 186490
[2025-09-03 18:21:16]   created_timestamp: 2025-01-31 07:41:36.850000
[2025-09-03 18:21:16]   last_status: delivered_orders
[2025-09-03 18:21:16]   target: 1
[2025-09-03 18:21:16]   timestamp: 2025-01-11 20:35:17.736000
[2025-09-03 18:21:16]   weight: 16.661022186279297
[2025-09-03 18:21:16]   user_count: 32.0
[2025-09-03 18:21:16]   user_mean: 5.147484676543102
[2025-09-03 18:21:16]   user_sum: 164.71950964937926
[2025-09-03 18:21:16]   user_max: 16.66102255087602
[2025-09-03 18:21:16]   user_min: 2.028148247292285
[2025-09-03 18:21:16]   user_orders_count: 2.0
[2025-09-03 18:21:16]   item_feat_0: 16.661022186279297
[2025-09-03 18:21:16]   item_feat_1: 32.5927848815918
[2025-09-03 18:21:16]   item_feat_2: 2.0
[2025-09-03 18:21:16]   item_feat_3: 2.0
[2025-09-03 18:21:16]   item_feat_4: 16.2963924407959
[2025-09-03 18:21:16]   item_feat_5: 15.9317626953125
[2025-09-03 18:21:16]   emb_0: 0.0
[2025-09-03 18:21:16]   emb_1: 0.0
[2025-09-03 18:21:16]   emb_2: 0.0
[2025-09-03 18:21:16]   emb_3: 0.0
[2025-09-03 18:21:16]   emb_4: 0.0
[2025-09-03 18:21:16]   emb_5: 0.0
[2025-09-03 18:21:16]   emb_6: 0.0
[2025-09-03 18:21:16]   emb_7: 0.0
[2025-09-03 18:21:16]   emb_8: 0.0
[2025-09-03 18:21:16]   emb_9: 0.0
[2025-09-03 18:21:16] === ДЕБАГ ИНФОРМАЦИЯ: VAL ===
[2025-09-03 18:21:16] Размер: 48213 строк
[2025-09-03 18:21:16] Колонки: ['item_id', 'user_id', 'created_timestamp', 'last_status', 'target', 'timestamp', 'weight', 'user_count', 'user_mean', 'user_sum', 'user_max', 'user_min', 'user_orders_count', 'item_feat_0', 'item_feat_1', 'item_feat_2', 'item_feat_3', 'item_feat_4', 'item_feat_5', 'emb_0', 'emb_1', 'emb_2', 'emb_3', 'emb_4', 'emb_5', 'emb_6', 'emb_7', 'emb_8', 'emb_9']
[2025-09-03 18:21:16] Все признаки присутствуют
[2025-09-03 18:21:16] Целевая переменная: {1: np.int64(26336), 0: np.int64(21877)}
[2025-09-03 18:21:16] Пример первой строки:
[2025-09-03 18:21:16]   item_id: 295675560
[2025-09-03 18:21:16]   user_id: 795411
[2025-09-03 18:21:16]   created_timestamp: 2025-05-15 21:47:37.343000
[2025-09-03 18:21:16]   last_status: delivered_orders
[2025-09-03 18:21:16]   target: 1
[2025-09-03 18:21:16]   timestamp: 2025-03-07 07:33:36.843000
[2025-09-03 18:21:16]   weight: 14.224547386169434
[2025-09-03 18:21:16]   user_count: 0.0
[2025-09-03 18:21:16]   user_mean: 0.0
[2025-09-03 18:21:16]   user_sum: 0.0
[2025-09-03 18:21:16]   user_max: 0.0
[2025-09-03 18:21:16]   user_min: 0.0
[2025-09-03 18:21:16]   user_orders_count: 0.0
[2025-09-03 18:21:16]   item_feat_0: 0.0
[2025-09-03 18:21:16]   item_feat_1: 0.0
[2025-09-03 18:21:16]   item_feat_2: 0.0
[2025-09-03 18:21:16]   item_feat_3: 0.0
[2025-09-03 18:21:16]   item_feat_4: 0.0
[2025-09-03 18:21:16]   item_feat_5: 0.0
[2025-09-03 18:21:16]   emb_0: 0.0
[2025-09-03 18:21:16]   emb_1: 0.0
[2025-09-03 18:21:16]   emb_2: 0.0
[2025-09-03 18:21:16]   emb_3: 0.0
[2025-09-03 18:21:16]   emb_4: 0.0
[2025-09-03 18:21:16]   emb_5: 0.0
[2025-09-03 18:21:16]   emb_6: 0.0
[2025-09-03 18:21:16]   emb_7: 0.0
[2025-09-03 18:21:16]   emb_8: 0.0
[2025-09-03 18:21:16]   emb_9: 0.0
[2025-09-03 18:21:16] Feature columns: ['user_count', 'user_mean', 'user_sum', 'user_max', 'user_min', 'user_orders_count', 'item_feat_0', 'item_feat_1', 'item_feat_2', 'item_feat_3', 'item_feat_4', 'item_feat_5', 'emb_0', 'emb_1', 'emb_2', 'emb_3', 'emb_4', 'emb_5', 'emb_6', 'emb_7', 'emb_8', 'emb_9']
[2025-09-03 18:21:16] Всего данных для обработки: 155605 строк
[2025-09-03 18:21:16] Чанк 1/1 (155605 строк)
[2025-09-03 18:21:17] Модель сохранена после чанка 1
[2025-09-03 18:21:20] Финальный NDCG@100 на валидации: 0.995065
[2025-09-03 18:21:20] Обучение модели завершено за 0:00:04.543261
[2025-09-03 18:21:20] === СОХРАНЕНИЕ МОДЕЛИ И ПРИЗНАКОВ ===
[2025-09-03 18:21:25] Сохранение модели завершено за 0:00:04.713933
[2025-09-03 18:21:25] Модель сохранена в: /home/root6/python/e_cup/rec_system/src/models/model.pkl
[2025-09-03 18:21:25] === ОБУЧЕНИЕ И ПРЕДСКАЗАНИЯ ЗАВЕРШЕНЫ УСПЕШНО ===
[2025-09-03 18:21:25] Общее время выполнения: 0:04:19.299582
[2025-09-03 18:21:25] Пользователей: 944178
[2025-09-03 18:21:25] Товаров: 779031
[2025-09-03 18:21:25] Признаков: 22
[2025-09-03 18:21:25] === СИСТЕМНАЯ ИНФОРМАЦИЯ ===
[2025-09-03 18:21:25] Видеокарта: NVIDIA GeForce RTX 4090
[2025-09-03 18:21:25] Память GPU: 24.0 GB
[2025-09-03 18:21:25] Процессор: 29.8% загрузки
[2025-09-03 18:21:25] Ядра CPU: 32
[2025-09-03 18:21:25] Частота CPU: 2995.2 MHz
[2025-09-03 18:21:25] Оперативная память: 94.2 GB всего, 68.4 GB использовано
[2025-09-03 18:21:25] ==========================================
[2025-09-03 18:21:25] ВСЕ ЭТАПЫ ВЫПОЛНЕНЫ УСПЕШНО!
[2025-09-03 18:21:25] ==========================================

=== ОБЩЕЕ ВРЕМЯ ВЫПОЛНЕНИЯ: 0:04:19.305826 ===
