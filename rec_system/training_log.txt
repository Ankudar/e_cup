=== НАЧАЛО ОБУЧЕНИЯ 2025-08-27 22:31:52 ===

[2025-08-27 22:31:52] === РЕЖИМ МАСШТАБИРОВАНИЯ: FULL ===
[2025-08-27 22:31:52] Пользователей: все
[2025-08-27 22:31:52] Данных: 100.0%
[2025-08-27 22:31:52] === ЗАГРУЗКА ДАННЫХ ===
[2025-08-27 22:31:52] Загружаем данные...
[2025-08-27 22:31:53] orders: 1,000 строк (использовано 5 из 5 партиций), ~0.0 MB
[2025-08-27 22:31:53] tracker: 1,000 строк (использовано 200 из 200 партиций), ~0.0 MB
[2025-08-27 22:31:54] items: 1,000 строк (использовано 200 из 200 партиций), ~0.2 MB
[2025-08-27 22:31:54] categories: 1,000 строк (использовано 1 из 1 партиций), ~0.2 MB
[2025-08-27 22:31:54] test_users: 1,000 строк (использовано 1 из 1 партиций), ~0.0 MB
[2025-08-27 22:31:54] Данные загружены
[2025-08-27 22:31:54] Фильтрация данных...
[2025-08-27 22:31:54] Фильтрация завершена
[2025-08-27 22:31:54] Загрузка данных завершена за 0:00:02.015317
[2025-08-27 22:31:54] === ЗАГРУЗКА ЭМБЕДДИНГОВ ===
[2025-08-27 22:31:54] Оптимизированная потоковая загрузка эмбеддингов...
[2025-08-27 22:31:55] Загружено эмбеддингов для 990 товаров
[2025-08-27 22:31:55] Загрузка эмбеддингов завершена за 0:00:00.748610
[2025-08-27 22:31:55] Загружено эмбеддингов: 990
[2025-08-27 22:31:55] === SPLIT ДАННЫХ ===
[2025-08-27 22:31:55] Split данных завершен за 0:00:00.294703
[2025-08-27 22:31:55] Train orders: 753, Test orders: 187
[2025-08-27 22:31:55] === ПОДГОТОВКА ВЗАИМОДЕЙСТВИЙ ===
[2025-08-27 22:31:55] Формируем матрицу взаимодействий по батчам...
[2025-08-27 22:31:55] ... для orders
[2025-08-27 22:31:55] Сохранен orders-батч 0-753
[2025-08-27 22:31:55] ... для tracker
[2025-08-27 22:31:56] Сохранен tracker-партиция 0
[2025-08-27 22:31:56] Все батчи сохранены на диск.
[2025-08-27 22:31:56] Подготовка взаимодействий завершена за 0:00:00.860211
[2025-08-27 22:31:56] Создано файлов взаимодействий: 2
[2025-08-27 22:31:56] === ПОСЛЕДНИЕ ТОВАРЫ ===
[2025-08-27 22:31:56] Словарь сохранен в /home/root6/python/e_cup/rec_system/data/processed/recent_items_map.pkl
[2025-08-27 22:31:56] Построение recent items map завершено за 0:00:00.024054
[2025-08-27 22:31:56] Пользователей с recent items: 1195
[2025-08-27 22:31:56] === ОБУЧЕНИЕ ALS ДЛЯ ПРИЗНАКОВ ===
[2025-08-27 22:31:56] Первый проход: построение маппингов...
[2025-08-27 22:31:56] Маппинги построены. Уников: users=1195, items=207
[2025-08-27 22:31:56] item_map сохранен: /home/root6/python/e_cup/rec_system/data/processed/item_map.pkl
[2025-08-27 22:31:56] Сохранение батчей на диск...
[2025-08-27 22:31:56] Постепенное обучение...
[2025-08-27 22:31:57] Очистка временных файлов...
[2025-08-27 22:31:57] Директория батчей удалена
[2025-08-27 22:31:57] Обучение завершено!
[2025-08-27 22:31:57] Считаем глобальную популярность на основе тренировочных данных...
[2025-08-27 22:31:57] Глобальная популярность рассчитана на 752 тренировочных заказах
[2025-08-27 22:31:57] Обучение ALS завершено за 0:00:00.818180
[2025-08-27 22:31:57] Пользователей: 1195, Товаров: 207
[2025-08-27 22:31:57] === ПОСТРОЕНИЕ ДОПОЛНИТЕЛЬНЫХ ДАННЫХ ===
[2025-08-27 22:31:57] Строим co-purchase матрицу для топ-N товаров...
[2025-08-27 22:31:57] Топ-207 популярных товаров определены
[2025-08-27 22:31:57] Обрабатываем 3 корзин с популярными товарами
[2025-08-27 22:31:57] Уникальных популярных товаров: 207
[2025-08-27 22:31:57] Создаем sparse матрицу из 6 взаимодействий...
[2025-08-27 22:31:57] Sparse матрица построена: torch.Size([207, 207]), ненулевых элементов: 3
[2025-08-27 22:31:57] Формируем рекомендации...
[2025-08-27 22:31:57] Co-purchase словарь построен для 3 товаров
[2025-08-27 22:31:57] В среднем 1.0 рекомендаций на товар
[2025-08-27 22:31:57] Co-purchase map построен: 3 товаров
[2025-08-27 22:31:57] Построение категорийных маппингов...
[2025-08-27 22:31:57] Сохранено: item_to_cat.pkl и extended_cat_to_items.pkl в /home/root6/python/e_cup/rec_system/data/processed/
[2025-08-27 22:31:57] Категорийные маппинги построены: 990 товаров, 223 категорий
[2025-08-27 22:31:57] Построение дополнительных данных завершено за 0:00:00.281662
[2025-08-27 22:31:57] === ПРЕДВАРИТЕЛЬНЫЙ РАСЧЕТ ПРИЗНАКОВ ДЛЯ LGBM ===
[2025-08-27 22:31:57] Построение словаря пользовательских признаков...
[2025-08-27 22:31:57] Агрегация по заказам...
[2025-08-27 22:31:58] Словарь пользовательских признаков построен и сохранён в /home/root6/python/e_cup/rec_system/data/processed/user_features_dict.pkl. Записей: 1196
[2025-08-27 22:31:58] User features построены за 0:00:00.315976: 1196 пользователей
[2025-08-27 22:31:58] Построение словаря товарных признаков...
[2025-08-27 22:31:58] Добавление данных из items_df...
[2025-08-27 22:31:58] Добавление эмбеддингов...
[2025-08-27 22:31:58] Словарь товарных признаков построен. Записей: 208
[2025-08-27 22:31:58] Словарь сохранён в /home/root6/python/e_cup/rec_system/data/processed/item_features_dict.pkl
[2025-08-27 22:31:58] Item features построены за 0:00:00.310663: 208 товаров
[2025-08-27 22:31:58] Предварительный расчет признаков завершен за 0:00:00.626755
[2025-08-27 22:31:58] === ПОДГОТОВКА ДАННЫХ ДЛЯ LightGBM ===
[2025-08-27 22:31:58] Подготовка данных для LightGBM (streaming)...
[2025-08-27 22:31:58] min_timestamp=2025-01-01 07:18:57; max_timestamp=2025-05-29 08:10:22; duration=148 days 00:51:25
[2025-08-27 22:31:58] split_time (20% tail) = 2025-04-29 17:36:05; train_timestamp_fill = 2025-04-29 17:36:04
[2025-08-27 22:32:01] TRAIN: rows=1204; target_counts={0: 830, 1: 374}
[2025-08-27 22:32:01] VAL: rows=163; target_counts={1: 85, 0: 78}
[2025-08-27 22:32:01] split_time=2025-04-29 17:36:05 split_by_time=True
[2025-08-27 22:32:01] ✅ Данные подготовлены: train=1204, val=163
[2025-08-27 22:32:01] Размер train: 963, validation: 241
[2025-08-27 22:32:01] Признаки: 0
[2025-08-27 22:32:01] Подготовка данных для LightGBM завершена за 0:00:02.807925
[2025-08-27 22:32:01] === ДЕТАЛЬНАЯ ПРОВЕРКА FEATURE GENERATION ===
[2025-08-27 22:32:01] --- ПРОВЕРКА USER FEATURES ---
[2025-08-27 22:32:01] Пример user features для пользователя 1063981:
[2025-08-27 22:32:01]   user_count: 1
[2025-08-27 22:32:01]   user_mean: 7.014118315355507
[2025-08-27 22:32:01]   user_sum: 7.014118315355507
[2025-08-27 22:32:01]   user_max: 7.014118315355507
[2025-08-27 22:32:01]   user_min: 7.014118315355507
[2025-08-27 22:32:01]   user_orders_count: 1
[2025-08-27 22:32:01] Пользователей с features: 1196
[2025-08-27 22:32:01] Пользователей с НЕнулевыми features: 1196
[2025-08-27 22:32:01] --- ПРОВЕРКА ITEM FEATURES ---
[2025-08-27 22:32:01] Пример item features для товара 8033594:
[2025-08-27 22:32:01]   item_count: 1
[2025-08-27 22:32:01]   item_mean: 4.5814536593707755
[2025-08-27 22:32:01]   item_sum: 4.5814536593707755
[2025-08-27 22:32:01]   item_max: 4.5814536593707755
[2025-08-27 22:32:01]   item_min: 4.5814536593707755
[2025-08-27 22:32:01]   item_orders_count: 1
[2025-08-27 22:32:01]   item_category: None
[2025-08-27 22:32:01] Товаров с features: 208
[2025-08-27 22:32:01] Товаров с НЕнулевыми features: 208
[2025-08-27 22:32:01] --- ПРОВЕРКА ЭМБЕДДИНГОВ ---
[2025-08-27 22:32:01] Пример эмбеддинга для товара 400301: shape (512,)
[2025-08-27 22:32:01] Эмбеддингов загружено: 990
[2025-08-27 22:32:01] Пример значений: [ 0.32023853  0.11766258 -0.784552    0.4168199  -0.24610527]
[2025-08-27 22:32:01] --- ПРОВЕРКА CO-PURCHASE MAP ---
[2025-08-27 22:32:01] Пример co-purchase для товара 10126067: 1 товаров
[2025-08-27 22:32:01] Co-purchase записей: 3
[2025-08-27 22:32:01] --- ПРОВЕРКА КАТЕГОРИЙНЫХ МАППИНГОВ ---
[2025-08-27 22:32:01] Товар 400301 -> категория 17080
[2025-08-27 22:32:01] Категория 17080 -> 4 товаров
[2025-08-27 22:32:01] Товаров в маппинге: 990
[2025-08-27 22:32:01] Категорий в маппинге: 223
[2025-08-27 22:32:01] Проверка признаков завершена за 0:00:00.001158
[2025-08-27 22:32:01] === ОБУЧЕНИЕ LightGBM ===
[2025-08-27 22:32:01] Размер train: 1204
[2025-08-27 22:32:01] Размер val: 163
[2025-08-27 22:32:01] !!! ОШИБКА ВЫПОЛНЕНИЯ !!!
[2025-08-27 22:32:01] Ошибка: Forced splits file includes feature index 0, but maximum feature index in dataset is -1
[2025-08-27 22:32:01] Время до ошибки: 0:00:08.486822
[2025-08-27 22:32:01] Трассировка ошибки:
[2025-08-27 22:32:01] Traceback (most recent call last):
  File "/home/root6/python/e_cup/rec_system/src/prepare/with_ml.py", line 2361, in <module>
    model = recommender.train(train_df, val_df)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/root6/python/e_cup/rec_system/src/prepare/with_ml.py", line 1595, in train
    self.model = lgb.train(
                 ^^^^^^^^^^
  File "/home/root6/python/e_cup/venv/lib/python3.12/site-packages/lightgbm/engine.py", line 297, in train
    booster = Booster(params=params, train_set=train_set)
              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/root6/python/e_cup/venv/lib/python3.12/site-packages/lightgbm/basic.py", line 3660, in __init__
    _safe_call(
  File "/home/root6/python/e_cup/venv/lib/python3.12/site-packages/lightgbm/basic.py", line 313, in _safe_call
    raise LightGBMError(_LIB.LGBM_GetLastError().decode("utf-8"))
lightgbm.basic.LightGBMError: Forced splits file includes feature index 0, but maximum feature index in dataset is -1


=== ОБЩЕЕ ВРЕМЯ ВЫПОЛНЕНИЯ: 0:00:08.487832 ===
